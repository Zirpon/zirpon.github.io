<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®° | ZepungğŸ‰Blog</title><meta name="author" content="ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³"><meta name="copyright" content="ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. Begin1.1 chunkChunk æ˜¯ä¸€ç³»åˆ—è¯­å¥ï¼ŒLua æ‰§è¡Œçš„æ¯ä¸€å—è¯­å¥ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶æˆ–è€…äº¤äº’æ¨¡å¼ä¸‹çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ª Chunkã€‚æ¯ä¸ªè¯­å¥ç»“å°¾çš„åˆ†å·ï¼ˆ;ï¼‰æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœåŒä¸€è¡Œæœ‰å¤šä¸ªè¯­å¥æœ€å¥½ç”¨ï¼›åˆ†å¼€(but valid)Chunkå¯ä»¥å¾ˆå¤§ï¼Œåœ¨ Lua ä¸­å‡ ä¸ª MByte çš„ Chunk æ˜¯å¾ˆå¸¸è§çš„ äº¤äº’æ¨¡å¼ä¸‹ é”®å…¥æ–‡ä»¶ç»“æŸç¬¦å¯ä»¥é€€å‡ºäº¤äº’æ¨¡å¼ï¼ˆCtrl-D in Unix, Ctrl-Z">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®°">
<meta property="og:url" content="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="ZepungğŸ‰Blog">
<meta property="og:description" content="1. Begin1.1 chunkChunk æ˜¯ä¸€ç³»åˆ—è¯­å¥ï¼ŒLua æ‰§è¡Œçš„æ¯ä¸€å—è¯­å¥ï¼Œæ¯”å¦‚ä¸€ä¸ªæ–‡ä»¶æˆ–è€…äº¤äº’æ¨¡å¼ä¸‹çš„æ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ª Chunkã€‚æ¯ä¸ªè¯­å¥ç»“å°¾çš„åˆ†å·ï¼ˆ;ï¼‰æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœåŒä¸€è¡Œæœ‰å¤šä¸ªè¯­å¥æœ€å¥½ç”¨ï¼›åˆ†å¼€(but valid)Chunkå¯ä»¥å¾ˆå¤§ï¼Œåœ¨ Lua ä¸­å‡ ä¸ª MByte çš„ Chunk æ˜¯å¾ˆå¸¸è§çš„ äº¤äº’æ¨¡å¼ä¸‹ é”®å…¥æ–‡ä»¶ç»“æŸç¬¦å¯ä»¥é€€å‡ºäº¤äº’æ¨¡å¼ï¼ˆCtrl-D in Unix, Ctrl-Z">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zirpon.github.io/img/404-bg.jpg">
<meta property="article:published_time" content="2019-04-06T07:32:12.000Z">
<meta property="article:modified_time" content="2025-03-17T04:04:45.766Z">
<meta property="article:author" content="ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³">
<meta property="article:tag" content="lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zirpon.github.io/img/404-bg.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®°",
  "url": "https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
  "image": "https://zirpon.github.io/img/404-bg.jpg",
  "datePublished": "2019-04-06T07:32:12.000Z",
  "dateModified": "2025-03-17T04:04:45.766Z",
  "author": [
    {
      "@type": "Person",
      "name": "ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³",
      "url": "https://zirpon.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/timg.jpeg"><link rel="canonical" href="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":-1,"unescape":false,"languages":{"hits_empty":"æœªæ‰¾åˆ°ç¬¦åˆæ‚¨æŸ¥è¯¢çš„å†…å®¹ï¼š${query}","hits_stats":"å…±æ‰¾åˆ° ${hits} ç¯‡æ–‡ç« "}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"å·²åˆ‡æ¢ä¸ºç¹ä½“ä¸­æ–‡","cht_to_chs":"å·²åˆ‡æ¢ä¸ºç®€ä½“ä¸­æ–‡","day_to_night":"å·²åˆ‡æ¢ä¸ºæ·±è‰²æ¨¡å¼","night_to_day":"å·²åˆ‡æ¢ä¸ºæµ…è‰²æ¨¡å¼","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®°',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/IMG_5015.JPG" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/404-bg.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/timg.jpeg" alt="Logo"><span class="site-name">ZepungğŸ‰Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®°</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lua 5.0 ~ 5.4 å­¦ä¹ ç¬”è®°</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2019-04-06T07:32:12.000Z" title="å‘è¡¨äº 2019-04-06 15:32:12">2019-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-03-17T04:04:45.766Z" title="æ›´æ–°äº 2025-03-17 12:04:45">2025-03-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">æ€»å­—æ•°:</span><span class="word-count">17.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">é˜…è¯»æ—¶é•¿:</span><span>75åˆ†é’Ÿ</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="1-Begin"><a href="#1-Begin" class="headerlink" title="1. Begin"></a>1. Begin</h2><h3 id="1-1-chunk"><a href="#1-1-chunk" class="headerlink" title="1.1 chunk"></a>1.1 chunk</h3><p>Chunk æ˜¯ä¸€ç³»åˆ—è¯­å¥ï¼ŒLua æ‰§è¡Œçš„æ¯ä¸€<strong>å—</strong>è¯­å¥ï¼Œæ¯”å¦‚<strong>ä¸€ä¸ªæ–‡ä»¶</strong>æˆ–è€…<strong>äº¤äº’æ¨¡å¼</strong>ä¸‹çš„<em>æ¯ä¸€è¡Œ</em>éƒ½æ˜¯ä¸€ä¸ª Chunkã€‚<br>æ¯ä¸ªè¯­å¥ç»“å°¾çš„åˆ†å·ï¼ˆ;ï¼‰æ˜¯å¯é€‰çš„ï¼Œä½†å¦‚æœåŒä¸€è¡Œæœ‰å¤šä¸ªè¯­å¥æœ€å¥½ç”¨ï¼›åˆ†å¼€(but valid)<br>Chunkå¯ä»¥å¾ˆå¤§ï¼Œåœ¨ Lua ä¸­å‡ ä¸ª MByte çš„ Chunk æ˜¯å¾ˆå¸¸è§çš„</p>
<p>äº¤äº’æ¨¡å¼ä¸‹ é”®å…¥æ–‡ä»¶ç»“æŸç¬¦å¯ä»¥é€€å‡ºäº¤äº’æ¨¡å¼ï¼ˆCtrl-D in Unix, Ctrl-Z in DOS&#x2F;Windowsï¼‰ï¼Œæˆ–è€…è°ƒç”¨ OS åº“çš„ os.exit()å‡½æ•°ä¹Ÿå¯ä»¥é€€å‡º</p>
<blockquote>
<p>prompt&gt; lua -la -lb</p>
</blockquote>
<p>å‘½ä»¤é¦–å…ˆåœ¨ä¸€ä¸ª Chunk å†…å…ˆè¿è¡Œ a ç„¶åè¿è¡Œ bã€‚ï¼ˆæ³¨æ„ï¼š-l é€‰é¡¹ä¼šè°ƒç”¨ requireï¼Œå°†ä¼šåœ¨æŒ‡å®šçš„ç›®å½•ä¸‹æœç´¢æ–‡ä»¶ï¼Œå¦‚æœç¯å¢ƒå˜é‡æ²¡æœ‰è®¾å¥½ï¼Œä¸Šé¢çš„å‘½ä»¤å¯èƒ½ä¸èƒ½æ­£ç¡®è¿è¡Œã€‚)</p>
<blockquote>
<p>lua -i -la -lb</p>
</blockquote>
<p>å°†åœ¨ä¸€ä¸ª Chunk å†…å…ˆè¿è¡Œ a ç„¶åè¿è¡Œ bï¼Œæœ€åç›´æ¥è¿›å…¥äº¤äº’æ¨¡å¼</p>
<p>æœ€å¥½ä¸è¦ä½¿ç”¨ä¸‹åˆ’çº¿åŠ å¤§å†™å­—æ¯çš„æ ‡ç¤ºç¬¦ï¼Œå› ä¸º Lua çš„ä¿ç•™å­—ä¹Ÿæ˜¯è¿™æ ·çš„ã€‚</p>
<h3 id="1-4-lua-command-line"><a href="#1-4-lua-command-line" class="headerlink" title="1.4 lua command line"></a>1.4 lua command line</h3><ul>
<li><p>-eï¼šç›´æ¥å°†å‘½ä»¤ä¼ å…¥ Lua</p>
<blockquote>
<p>prompt&gt; lua -e â€œprint(math.sin(12))â€ â€“&gt; -0.53657291800043</p>
</blockquote>
</li>
<li><p>-lï¼šåŠ è½½ä¸€ä¸ªæ–‡ä»¶.</p>
</li>
<li><p>-iï¼šè¿›å…¥äº¤äº’æ¨¡å¼.<br>  _PROMPT å†…ç½®å˜é‡ä½œä¸ºäº¤äº’æ¨¡å¼çš„æç¤ºç¬¦</p>
<blockquote>
<p>prompt&gt; lua -i -e â€œ_PROMPT&#x3D;â€™ lua&gt; â€˜â€œ<br>lua&gt;</p>
</blockquote>
</li>
</ul>
<p>Lua çš„è¿è¡Œè¿‡ç¨‹ï¼Œåœ¨è¿è¡Œå‚æ•°ä¹‹å‰ï¼ŒLua ä¼šæŸ¥æ‰¾ç¯å¢ƒå˜é‡ <code>LUA_INIT</code> çš„å€¼ï¼Œ</p>
<ul>
<li>å¦‚æœå˜é‡å­˜åœ¨å¹¶ä¸”<code>å€¼</code>ä¸º<code>@filename</code>ï¼ŒLua å°†<strong>åŠ è½½</strong>æŒ‡å®šæ–‡ä»¶ã€‚</li>
<li>å¦‚æœå˜é‡å­˜åœ¨ä½†<code>ä¸æ˜¯ä»¥@å¼€å¤´</code>ï¼ŒLuaå‡å®š filename ä¸º Lua ä»£ç æ–‡ä»¶å¹¶ä¸”<strong>è¿è¡Œ</strong>ä»–ã€‚</li>
</ul>
<p>å…¨å±€å˜é‡ <code>arg</code> å­˜æ”¾ Lua çš„å‘½ä»¤è¡Œå‚æ•°ã€‚åœ¨è¿è¡Œä»¥å‰ï¼ŒLua ä½¿ç”¨æ‰€æœ‰å‚æ•°æ„é€  arg è¡¨ã€‚</p>
<ul>
<li>è„šæœ¬åç´¢å¼•ä¸º 0ï¼Œ</li>
<li>è„šæœ¬çš„å‚æ•°ä» 1 å¼€å§‹å¢åŠ ã€‚</li>
<li>è„šæœ¬å‰é¢çš„å‚æ•°ä»-1 å¼€å§‹å‡å°‘</li>
</ul>
<blockquote>
<p>prompt&gt; lua -e â€œsin&#x3D;math.sinâ€ script a b<br>arg è¡¨å¦‚ä¸‹ï¼š</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">arg</span>[<span class="number">-3</span>] = <span class="string">&quot;lua&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-2</span>] = <span class="string">&quot;-e&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-1</span>] = <span class="string">&quot;sin=math.sin&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">0</span>] = <span class="string">&quot;script&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">1</span>] = <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">2</span>] = <span class="string">&quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-lua-basic-type"><a href="#2-lua-basic-type" class="headerlink" title="2. lua basic type"></a>2. lua basic type</h2><p>Lua æ˜¯åŠ¨æ€ç±»å‹è¯­è¨€ï¼Œå˜é‡ä¸è¦ç±»å‹å®šä¹‰ã€‚<br>Lua ä¸­æœ‰8 ä¸ªåŸºæœ¬ç±»å‹åˆ†åˆ«ä¸ºï¼š<code>nilã€booleanã€numberã€stringã€userdataã€functionã€thread å’Œ table</code>ã€‚<br>å‡½æ•° <code>type</code> å¯ä»¥æµ‹è¯•ç»™å®šå˜é‡æˆ–è€…å€¼çš„ç±»å‹ã€‚</p>
<p>åœ¨æ§åˆ¶ç»“æ„çš„æ¡ä»¶ä¸­é™¤äº† <code>false</code> å’Œ <code>nil</code> ä¸ºå‡ï¼Œå…¶ä»–å€¼éƒ½ä¸ºçœŸã€‚<br>æ‰€ä»¥ Lua è®¤ä¸º <code>0</code> å’Œ<code>ç©ºä¸²</code>éƒ½æ˜¯çœŸã€‚</p>
<p><code>number</code>è¡¨ç¤ºå®æ•°ï¼ŒLua ä¸­æ²¡æœ‰æ•´æ•°ã€‚</p>
<p>note: <em><strong>ä¸€èˆ¬æœ‰ä¸ªé”™è¯¯çš„çœ‹æ³• CPU è¿ç®—æµ®ç‚¹æ•°æ¯”æ•´æ•°æ…¢ã€‚äº‹å®ä¸æ˜¯å¦‚æ­¤ï¼Œç”¨å®æ•°ä»£æ›¿æ•´æ•°ä¸ä¼šæœ‰ä»€ä¹ˆè¯¯å·®ï¼ˆé™¤éæ•°å­—å¤§äº 100,000,000,000,000ï¼‰ã€‚</strong></em><br>Luaçš„ numbers å¯ä»¥å¤„ç†ä»»ä½•é•¿æ•´æ•°ä¸ç”¨æ‹…å¿ƒè¯¯å·®ã€‚</p>
<p>note: ä½ ä¹Ÿå¯ä»¥åœ¨ç¼–è¯‘ <code>Lua</code> çš„æ—¶å€™ä½¿ç”¨é•¿æ•´å‹æˆ–è€…<code>å•ç²¾åº¦æµ®ç‚¹å‹</code>ä»£æ›¿ numbersï¼Œåœ¨ä¸€äº›å¹³å°ç¡¬ä»¶<code>ä¸æ”¯æŒæµ®ç‚¹æ•°</code>çš„æƒ…å†µä¸‹è¿™ä¸ªç‰¹æ€§æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œå…·ä½“çš„æƒ…å†µè¯·å‚è€ƒ Lua å‘å¸ƒç‰ˆæ‰€é™„çš„è¯¦ç»†è¯´æ˜ã€‚</p>
<h3 id="2-4-string"><a href="#2-4-string" class="headerlink" title="2.4 string"></a>2.4 string</h3><p>å­—ç¬¦çš„åºåˆ—, lua æ˜¯ 8 ä½å­—èŠ‚ï¼Œæ‰€ä»¥å­—ç¬¦ä¸²å¯ä»¥åŒ…å«ä»»ä½•æ•°å€¼å­—ç¬¦ï¼ŒåŒ…æ‹¬åµŒå…¥çš„ 0ã€‚<br>è¿™æ„å‘³ç€ä½ å¯ä»¥å­˜å‚¨ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²é‡Œã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;one string&quot;</span></span><br><span class="line">b = <span class="built_in">string</span>.<span class="built_in">gsub</span>(a, <span class="string">&quot;one&quot;</span>, <span class="string">&quot;another&quot;</span>) <span class="comment">-- change string parts</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; one string</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment">--&gt; another string</span></span><br></pre></td></tr></table></figure>

<p>Lua å¯ä»¥é«˜æ•ˆçš„å¤„ç†é•¿å­—ç¬¦ä¸²ï¼Œ<code>1M</code> çš„ string åœ¨ Lua ä¸­æ˜¯å¾ˆå¸¸è§çš„ã€‚å¯ä»¥ä½¿ç”¨<code>å•å¼•å·</code>æˆ–è€…<code>åŒå¼•å·</code>è¡¨ç¤ºå­—ç¬¦ä¸²</p>
<p>è¿˜å¯ä»¥åœ¨å­—ç¬¦ä¸²ä¸­ä½¿ç”¨\dddï¼ˆddd ä¸ºä¸‰ä½åè¿›åˆ¶æ•°å­—ï¼‰æ–¹å¼è¡¨ç¤ºå­—æ¯ã€‚</p>
<blockquote>
<p>â€œalo\n123&quot;â€œ<br>â€˜\97lo\10\04923â€â€˜<br>æ˜¯ç›¸åŒçš„</p>
</blockquote>
<p>è¿˜å¯ä»¥ä½¿ç”¨<code>[[...]]</code>è¡¨ç¤ºå­—ç¬¦ä¸²ã€‚<br>è¿™ç§å½¢å¼çš„å­—ç¬¦ä¸²å¯ä»¥åŒ…å«<code>å¤šè¡Œ</code>ä¹Ÿï¼Œå¯ä»¥åµŒå¥—ä¸”<code>ä¸ä¼šè§£é‡Šè½¬ä¹‰åºåˆ—</code>ï¼Œå¦‚æœ<code>ç¬¬ä¸€ä¸ªå­—ç¬¦</code>æ˜¯<code>æ¢è¡Œç¬¦</code>ä¼šè¢«è‡ªåŠ¨<strong>å¿½ç•¥</strong>æ‰ã€‚</p>
<p>ç§å½¢å¼çš„å­—ç¬¦ä¸²ç”¨æ¥åŒ…å«ä¸€æ®µä»£ç æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">page = <span class="string">[[</span></span><br><span class="line"><span class="string">&lt;HTML&gt;</span></span><br><span class="line"><span class="string">&lt;HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;TITLE&gt;An HTML Page&lt;/TITLE&gt;</span></span><br><span class="line"><span class="string">&lt;/HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;BODY&gt;</span></span><br><span class="line"><span class="string">Lua</span></span><br><span class="line"><span class="string">[[a text between double brackets]]</span></span><br><span class="line"><span class="string">&lt;/BODY&gt;</span></span><br><span class="line"><span class="string">&lt;/HTML&gt;</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(page)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œæ—¶ï¼ŒLua ä¼šè‡ªåŠ¨åœ¨ string å’Œ numbers ä¹‹é—´è‡ªåŠ¨è¿›è¡Œç±»å‹è½¬æ¢ï¼Œå½“ä¸€ä¸ªå­—ç¬¦ä¸²ä½¿<br>ç”¨ç®—æœ¯æ“ä½œç¬¦æ—¶ï¼Œstring å°±ä¼šè¢«è½¬æˆæ•°å­—ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;10&quot;</span> + <span class="number">1</span>) <span class="comment">--&gt; 11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;10 + 1&quot;</span>) <span class="comment">--&gt; 10 + 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-5.3e - 10&quot;</span> * <span class="string">&quot;2&quot;</span>) <span class="comment">--&gt; -1.06e-09</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span> + <span class="number">1</span>) <span class="comment">-- ERROR (cannot convert &quot;hello&quot;)</span></span><br></pre></td></tr></table></figure>

<p><code>..</code>åœ¨ Lua ä¸­æ˜¯å­—ç¬¦ä¸²è¿æ¥ç¬¦ï¼Œå½“åœ¨ä¸€ä¸ª<code>æ•°å­—</code>åé¢å†™<code>..</code>æ—¶ï¼Œå¿…é¡»<code>åŠ ä¸Šç©ºæ ¼</code>ä»¥é˜²æ­¢è¢«è§£é‡Šé”™</p>
<p>æ˜¾å¼å°† string è½¬æˆæ•°å­—å¯ä»¥ä½¿ç”¨å‡½æ•° <code>tonumber()</code>ï¼Œå¦‚æœ string ä¸æ˜¯æ­£ç¡®çš„æ•°å­—è¯¥å‡½æ•°å°†è¿”å› <code>nil</code>ã€‚</p>
<p>å¯ä»¥è°ƒç”¨<code>tostring()</code>å°†æ•°å­—è½¬æˆå­—ç¬¦ä¸²ï¼Œè¿™ç§è½¬æ¢ä¸€ç›´æœ‰æ•ˆ</p>
<h3 id="2-5-Function"><a href="#2-5-Function" class="headerlink" title="2.5 Function"></a>2.5 Function</h3><p>å‡½æ•°æ˜¯<code>ç¬¬ä¸€ç±»å€¼</code>ï¼ˆå’Œå…¶ä»–å˜é‡ç›¸åŒï¼‰ï¼Œæ„å‘³ç€</p>
<ul>
<li>å‡½æ•°å¯ä»¥å­˜å‚¨åœ¨å˜é‡ä¸­ï¼Œ</li>
<li>å¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œ</li>
<li>ä¹Ÿå¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚</li>
</ul>
<h3 id="2-6-Userdata-and-Threads"><a href="#2-6-Userdata-and-Threads" class="headerlink" title="2.6 Userdata and Threads"></a>2.6 Userdata and Threads</h3><ul>
<li>userdata å¯ä»¥å°† C æ•°æ®å­˜æ”¾åœ¨ Lua å˜é‡ä¸­ï¼Œ</li>
<li>userdata åœ¨ Lua ä¸­é¢„å®šä¹‰æ“ä½œ<code>èµ‹å€¼</code>å’Œ<code>ç›¸ç­‰æ¯”è¾ƒ</code></li>
</ul>
<h2 id="3-expression-è¡¨è¾¾å¼"><a href="#3-expression-è¡¨è¾¾å¼" class="headerlink" title="3. expression è¡¨è¾¾å¼"></a>3. expression è¡¨è¾¾å¼</h2><h3 id="3-2-Relational-operators"><a href="#3-2-Relational-operators" class="headerlink" title="3.2 Relational operators"></a>3.2 Relational operators</h3><p>å…³ç³»è¿ç®—ç¬¦</p>
<blockquote>
<p>&lt; &gt; &lt;&#x3D; &gt;&#x3D; &#x3D;&#x3D; ~&#x3D;</p>
</blockquote>
<ul>
<li>Lua é€šè¿‡<code>å¼•ç”¨</code>æ¯”è¾ƒ<code>tablesã€userdataã€functions</code>ã€‚ä¹Ÿå°±æ˜¯è¯´å½“ä¸”ä»…å½“ä¸¤è€…è¡¨ç¤ºåŒä¸€ä¸ªå¯¹è±¡æ—¶ç›¸ç­‰ã€‚</li>
<li>Lua æ¯”è¾ƒæ•°å­—æŒ‰ä¼ ç»Ÿçš„æ•°å­—å¤§å°è¿›è¡Œï¼Œ</li>
<li>æ¯”è¾ƒå­—ç¬¦ä¸²æŒ‰å­—æ¯çš„é¡ºåºè¿›è¡Œï¼Œä½†æ˜¯å­—æ¯é¡ºåºä¾èµ–äºæœ¬åœ°ç¯å¢ƒ</li>
</ul>
<h3 id="3-3-logical-operator-é€»è¾‘è¿ç®—ç¬¦"><a href="#3-3-logical-operator-é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="3.3 logical operator é€»è¾‘è¿ç®—ç¬¦"></a>3.3 logical operator é€»è¾‘è¿ç®—ç¬¦</h3><blockquote>
<p>and or not</p>
</blockquote>
<p>ä¸€ä¸ªå¾ˆå®ç”¨çš„æŠ€å·§ï¼šå¦‚æœ x ä¸º false æˆ–è€… nil åˆ™ç»™ x èµ‹åˆå§‹å€¼ v</p>
<blockquote>
<p>x &#x3D; x or v</p>
</blockquote>
<p>C è¯­è¨€ä¸­çš„ä¸‰å…ƒè¿ç®—ç¬¦</p>
<blockquote>
<p>(a and b) or c &#x3D;&#x3D;&gt; a ? b : c</p>
</blockquote>
<h3 id="3-5-operator-priority-ä¼˜å…ˆçº§"><a href="#3-5-operator-priority-ä¼˜å…ˆçº§" class="headerlink" title="3.5 operator priority ä¼˜å…ˆçº§"></a>3.5 operator priority ä¼˜å…ˆçº§</h3><p>ä»é«˜åˆ°ä½çš„é¡ºåºï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line"><span class="keyword">not</span> - (unary)</span><br><span class="line">* /</span><br><span class="line">+ -</span><br><span class="line">..</span><br><span class="line">&lt; &gt; &lt;= &gt;= ~= ==</span><br><span class="line"><span class="keyword">and</span></span><br><span class="line"><span class="keyword">or</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†^å’Œ..å¤–æ‰€æœ‰çš„äºŒå…ƒè¿ç®—ç¬¦éƒ½æ˜¯<code>å·¦è¿æ¥</code>çš„ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a+i &lt; b/<span class="number">2</span>+<span class="number">1</span> &lt;<span class="comment">--&gt; (a+i) &lt; ((b/2)+1)</span></span><br><span class="line"><span class="number">5</span>+x^<span class="number">2</span>*<span class="number">8</span> &lt;<span class="comment">--&gt; 5+((x^2)*8)</span></span><br><span class="line">a &lt; y <span class="keyword">and</span> y &lt;= z &lt;<span class="comment">--&gt; (a &lt; y) and (y &lt;= z)</span></span><br><span class="line">-x^<span class="number">2</span> &lt;<span class="comment">--&gt; -(x^2)</span></span><br><span class="line">x^y^z &lt;<span class="comment">--&gt; x^(y^z)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-6-table-constructor-è¡¨çš„æ„é€ "><a href="#3-6-table-constructor-è¡¨çš„æ„é€ " class="headerlink" title="3.6 table constructor è¡¨çš„æ„é€ "></a>3.6 table constructor è¡¨çš„æ„é€ </h3><p>æœ€ç®€å•çš„æ„é€ å‡½æ•°æ˜¯<code>&#123;&#125;</code>ï¼Œç”¨æ¥åˆ›å»ºä¸€ä¸ª<code>ç©ºè¡¨</code>ã€‚</p>
<p>ä½¿ç”¨ table æ„é€ ä¸€ä¸ª listï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line"> list = &#123;<span class="built_in">next</span>=list, value=line&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>åµŒå¥—æ„é€ å‡½æ•°</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">polyline = &#123;color=<span class="string">&quot;blue&quot;</span>, thickness=<span class="number">2</span>, npoints=<span class="number">4</span>,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">1</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸èƒ½ä½¿ç”¨è´Ÿç´¢å¼•åˆå§‹åŒ–ä¸€ä¸ªè¡¨ä¸­å…ƒç´ ï¼Œ</li>
<li>å­—ç¬¦ä¸²ç´¢å¼•ä¹Ÿä¸èƒ½è¢«æ°å½“çš„è¡¨ç¤ºã€‚</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">opnames = &#123;</span><br><span class="line">    [<span class="string">&quot;+&quot;</span>] = <span class="string">&quot;add&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;-&quot;</span>] = <span class="string">&quot;sub&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;*&quot;</span>] = <span class="string">&quot;mul&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;/&quot;</span>] = <span class="string">&quot;div&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i = <span class="number">20</span>; s = <span class="string">&quot;-&quot;</span></span><br><span class="line">a = &#123;[i+<span class="number">0</span>] = s, [i+<span class="number">1</span>] = s..s, [i+<span class="number">2</span>] = s..s..s,&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(opnames[s]) <span class="comment">--&gt; sub</span></span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">22</span>]) <span class="comment">--&gt; ---</span></span><br></pre></td></tr></table></figure>

<ul>
<li>æ³¨æ„ï¼šä¸æ¨èæ•°ç»„ä¸‹æ ‡<code>ä» 0 å¼€å§‹</code>ï¼Œå¦åˆ™<code>å¾ˆå¤šæ ‡å‡†åº“ä¸èƒ½ä½¿ç”¨</code>ã€‚</li>
<li>åœ¨æ„é€ å‡½æ•°çš„<code>æœ€åçš„</code>â€œ,â€æ˜¯å¯é€‰çš„ï¼Œå¯ä»¥æ–¹ä¾¿ä»¥åçš„æ‰©å±•ã€‚</li>
<li>åœ¨æ„é€ å‡½æ•°ä¸­åŸŸåˆ†éš”ç¬¦é€—å·ï¼ˆâ€,â€ï¼‰å¯ä»¥ç”¨åˆ†å·ï¼ˆâ€;â€ï¼‰æ›¿ä»£ï¼Œé€šå¸¸æˆ‘ä»¬ä½¿ç”¨åˆ†å·ç”¨æ¥åˆ†å‰²ä¸åŒç±»å‹çš„è¡¨å…ƒç´ ã€‚</li>
</ul>
<p>å¦‚æœçœŸçš„æƒ³è¦æ•°ç»„ä¸‹æ ‡ä» 0 å¼€å§‹ï¼š</p>
<blockquote>
<p>days &#x3D; {[0]&#x3D;â€Sundayâ€, â€œMondayâ€, â€œTuesdayâ€, â€œWednesdayâ€, â€œThursdayâ€, â€œFridayâ€, â€œSaturdayâ€}<br>{x&#x3D;10, y&#x3D;45; â€œoneâ€, â€œtwoâ€, â€œthreeâ€}</p>
</blockquote>
<h3 id="4-basic-syntax-åŸºæœ¬è¯­æ³•"><a href="#4-basic-syntax-åŸºæœ¬è¯­æ³•" class="headerlink" title="4. basic syntax åŸºæœ¬è¯­æ³•"></a>4. basic syntax åŸºæœ¬è¯­æ³•</h3><blockquote>
<p>a, b &#x3D; 10, 2<em>x &lt;â€“&gt; a&#x3D;10; b&#x3D;2</em>x</p>
</blockquote>
<p>é‡åˆ°èµ‹å€¼è¯­å¥ Lua ä¼šå…ˆè®¡ç®—å³è¾¹æ‰€æœ‰çš„å€¼ç„¶åå†æ‰§è¡Œèµ‹å€¼æ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¿™æ ·<br>è¿›è¡Œäº¤æ¢å˜é‡çš„å€¼ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x <span class="comment">-- swap &#x27;x&#x27; for &#x27;y&#x27;</span></span><br><span class="line">a[i], a[j] = a[j], a[i] <span class="comment">-- swap &#x27;a[i]&#x27; for &#x27;a[i]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å½“å˜é‡ä¸ªæ•°å’Œå€¼çš„ä¸ªæ•°ä¸ä¸€è‡´æ—¶ï¼ŒLua ä¼šä¸€ç›´ä»¥å˜é‡ä¸ªæ•°ä¸ºåŸºç¡€é‡‡å–ä»¥ä¸‹ç­–ç•¥ï¼š</p>
<ul>
<li>a. å˜é‡ä¸ªæ•°&gt;å€¼çš„ä¸ªæ•° æŒ‰å˜é‡ä¸ªæ•°è¡¥è¶³ nil</li>
<li>b. å˜é‡ä¸ªæ•°&lt;å€¼çš„ä¸ªæ•° å¤šä½™çš„å€¼ä¼šè¢«å¿½ç•¥</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a, b, c = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 1 nil</span></span><br><span class="line">a, b = a+<span class="number">1</span>, b+<span class="number">1</span>, b+<span class="number">2</span> <span class="comment">-- value of b+2 is ignored</span></span><br><span class="line"><span class="built_in">print</span>(a,b) <span class="comment">--&gt; 1 2</span></span><br><span class="line">a, b, c = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 nil nil</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-local-variable-code-block-å±€éƒ¨å˜é‡-ä»£ç å—"><a href="#4-2-local-variable-code-block-å±€éƒ¨å˜é‡-ä»£ç å—" class="headerlink" title="4.2  local variable &amp; code block å±€éƒ¨å˜é‡ ä»£ç å—"></a>4.2  local variable &amp; code block å±€éƒ¨å˜é‡ ä»£ç å—</h3><p>ä½¿ç”¨ <code>local</code> åˆ›å»ºä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œä¸å…¨å±€å˜é‡ä¸åŒï¼Œå±€éƒ¨å˜é‡åªåœ¨è¢«å£°æ˜çš„é‚£ä¸ªä»£ç å—å†…æœ‰æ•ˆã€‚ä»£ç å—ï¼šæŒ‡ä¸€ä¸ª<code>æ§åˆ¶ç»“æ„</code>å†…ï¼Œä¸€ä¸ª<code>å‡½æ•°ä½“</code>ï¼Œæˆ–è€…ä¸€ä¸ª <code>chunk</code>ï¼ˆå˜é‡è¢«å£°æ˜çš„é‚£ä¸ªæ–‡ä»¶æˆ–è€…æ–‡æœ¬ä¸²ï¼‰</p>
<p>åº”è¯¥å°½å¯èƒ½çš„ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œæœ‰ä¸¤ä¸ªå¥½å¤„ï¼š</p>
<ol>
<li>é¿å…å‘½åå†²çª</li>
<li>è®¿é—®å±€éƒ¨å˜é‡çš„é€Ÿåº¦æ¯”å…¨å±€å˜é‡æ›´å¿«.</li>
</ol>
<blockquote>
<p>do â€¦ end</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">elseif</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> condition <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    statements;</span><br><span class="line"><span class="keyword">until</span> conditions;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ•°å€¼ for å¾ªç¯:</span></span><br><span class="line"><span class="keyword">for</span> var=exp1,exp2,exp3 <span class="keyword">do</span></span><br><span class="line">    loop-part</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- èŒƒå‹ for å¾ªç¯ï¼š</span></span><br><span class="line"><span class="comment">-- print all values of array &#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span> <span class="built_in">print</span>(k) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-break-return"><a href="#4-3-break-return" class="headerlink" title="4.3 break return"></a>4.3 break return</h3><p>æœ‰æ—¶å€™ä¸ºäº†è°ƒè¯•æˆ–è€…å…¶ä»–ç›®çš„éœ€è¦åœ¨ block çš„ä¸­é—´ä½¿ç”¨ return æˆ–è€… breakï¼Œå¯ä»¥æ˜¾å¼çš„ä½¿ç”¨ do..end æ¥å®ç°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">--&lt;&lt; SYNTAX ERROR</span></span><br><span class="line">    <span class="comment">-- &#x27;return&#x27; is the last statement in the next block</span></span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">return</span> <span class="keyword">end</span> <span class="comment">-- OK</span></span><br><span class="line">    ... <span class="comment">-- statements not reached</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="5-function"><a href="#5-function" class="headerlink" title="5. function"></a>5. function</h2><p>è°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œå¦‚æœå‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œå¿…é¡»ä½¿ç”¨()è¡¨æ˜æ˜¯å‡½æ•°è°ƒç”¨ã€‚</p>
<p>å½“å‡½æ•°<code>åªæœ‰ä¸€ä¸ªå‚æ•°</code>å¹¶ä¸”è¿™ä¸ªå‚æ•°æ˜¯<code>å­—ç¬¦ä¸²</code>æˆ–è€…<code>è¡¨æ„é€ </code>çš„æ—¶å€™ï¼Œ()æ˜¯å¯é€‰çš„ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">&quot;Hello World&quot;</span>     <span class="comment">--&gt; print(&quot;Hello World&quot;)</span></span><br><span class="line"><span class="built_in">dofile</span> <span class="string">&#x27;a.lua&#x27;</span>          <span class="comment">--&gt; dofile (&#x27;a.lua&#x27;)</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span>)</span><br><span class="line"></span><br><span class="line">f&#123;x=<span class="number">10</span>, y=<span class="number">20</span>&#125;   <span class="comment">--&gt; f(&#123;x=10, y=20&#125;)</span></span><br><span class="line"><span class="built_in">type</span>&#123;&#125;          <span class="comment">--&gt; type(&#123;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- é¢å‘å¯¹è±¡æ–¹å¼è°ƒç”¨å‡½æ•°çš„è¯­æ³•</span></span><br><span class="line">o:foo(x) <span class="comment">-- &gt; o.foo(o, x)</span></span><br></pre></td></tr></table></figure>

<p>string.findï¼Œå…¶è¿”å›åŒ¹é…ä¸²<code>â€œå¼€å§‹å’Œç»“æŸçš„ä¸‹æ ‡â€</code>ï¼ˆå¦‚æœä¸å­˜åœ¨åŒ¹é…ä¸²è¿”å› <code>nil</code>ï¼‰ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">&quot;hello Lua users&quot;</span>, <span class="string">&quot;Lua&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s, e) <span class="comment">--&gt; 7 9</span></span><br></pre></td></tr></table></figure>

<h3 id="5-1-multi-result-return"><a href="#5-1-multi-result-return" class="headerlink" title="5.1 multi result return"></a>5.1 multi result return</h3><p>è¿”å›å¤šä¸ªç»“æœå€¼</p>
<ul>
<li><p>ä½œä¸ºè¡¨è¾¾å¼è°ƒç”¨å‡½æ•°</p>
<ol>
<li>å½“è°ƒç”¨<code>ä½œä¸ºè¡¨è¾¾å¼æœ€åä¸€ä¸ªå‚æ•°</code>æˆ–è€…<code>ä»…æœ‰ä¸€ä¸ªå‚æ•°</code>æ—¶ï¼Œæ ¹æ®å˜é‡ä¸ªæ•°å‡½æ•°å°½å¯èƒ½å¤šåœ°è¿”å›å¤šä¸ªå€¼ï¼Œä¸è¶³è¡¥ nilï¼Œè¶…å‡ºèˆå»ã€‚</li>
<li>å…¶ä»–æƒ…å†µä¸‹ï¼Œå‡½æ•°è°ƒç”¨<code>ä»…è¿”å›ç¬¬ä¸€ä¸ªå€¼</code>ï¼ˆå¦‚æœæ²¡æœ‰è¿”å›å€¼ä¸º nilï¼‰</li>
</ol>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo0</span> <span class="params">()</span></span> <span class="keyword">end</span> <span class="comment">-- returns no results</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">end</span> <span class="comment">-- returns 1 result</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span> <span class="keyword">end</span> <span class="comment">-- returns 2 results</span></span><br><span class="line"></span><br><span class="line">x,y = foo2(), <span class="number">20</span> <span class="comment">-- x=&#x27;a&#x27;, y=20</span></span><br><span class="line">x,y = foo0(), <span class="number">20</span>, <span class="number">30</span> <span class="comment">-- x=&#x27;nil&#x27;, y=20, 30 is discarded</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½œä¸ºå‡½æ•°å‚æ•°è°ƒç”¨</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(foo2(), <span class="number">1</span>) <span class="comment">--&gt; a 1</span></span><br><span class="line"><span class="built_in">print</span>(foo2() .. <span class="string">&quot;x&quot;</span>) <span class="comment">--&gt; ax</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨è¡¨æ„é€ å‡½æ•° è°ƒç”¨</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;foo0(), foo2(), <span class="number">4</span>&#125; <span class="comment">-- a[1] = nil, a[2] = &#x27;a&#x27;, a[3] = 4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>return f()è¿™ç§ç±»å‹çš„è¿”å› f()è¿”å›çš„<code>æ‰€æœ‰å€¼</code></p>
</li>
<li><p>å¯ä»¥ä½¿ç”¨åœ†æ‹¬å·å¼ºåˆ¶ä½¿è°ƒç”¨è¿”å›ä¸€ä¸ªå€¼ã€‚</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>((foo0())) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">print</span>((foo1())) <span class="comment">--&gt; a</span></span><br><span class="line"><span class="built_in">print</span>((foo2())) <span class="comment">--&gt; a</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>å‡½æ•°å¤šå€¼è¿”å›çš„ç‰¹æ®Šå‡½æ•° unpackï¼Œæ¥å—ä¸€ä¸ªæ•°ç»„ä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿”å›æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ã€‚<br>unpack è¢«ç”¨æ¥å®ç°èŒƒå‹è°ƒç”¨æœºåˆ¶ï¼Œåœ¨ C è¯­è¨€ä¸­å¯ä»¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè°ƒç”¨å¯å˜çš„å‡½æ•°ï¼Œå¯ä»¥å£°æ˜å‚æ•°å¯å˜çš„å‡½æ•°ï¼Œä½†ä¸èƒ½ä¸¤è€…åŒæ—¶å¯å˜ã€‚</p>
<p>åœ¨ Lua ä¸­å¦‚æœä½ æƒ³è°ƒç”¨å¯å˜å‚æ•°çš„å¯å˜å‡½æ•°åªéœ€è¦è¿™æ ·</p>
<blockquote>
<p>f(unpack(a))</p>
</blockquote>
<p>é¢„å®šä¹‰çš„ unpack å‡½æ•°æ˜¯ç”¨ C è¯­è¨€å®ç°çš„ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç”¨ Lua æ¥å®Œæˆï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unpack</span><span class="params">(t, i)</span></span></span><br><span class="line">    i = i <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> t[i] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> t[i], <span class="built_in">unpack</span>(t, i + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-variable-parameter-å¯å˜å‚æ•°"><a href="#5-2-variable-parameter-å¯å˜å‚æ•°" class="headerlink" title="5.2 variable parameter å¯å˜å‚æ•°"></a>5.2 variable parameter å¯å˜å‚æ•°</h3><p>Lua å‡½æ•°å¯ä»¥æ¥å—å¯å˜æ•°ç›®çš„å‚æ•°ï¼Œå’Œ C è¯­è¨€ç±»ä¼¼åœ¨å‡½æ•°å‚æ•°åˆ—è¡¨ä¸­ä½¿ç”¨ä¸‰ç‚¹<code>ï¼ˆ...ï¼‰</code>è¡¨ç¤ºå‡½æ•°æœ‰å¯å˜çš„å‚æ•°ã€‚<br>Lua å°†å‡½æ•°çš„å‚æ•°æ”¾åœ¨ä¸€ä¸ªå« <code>arg</code> çš„è¡¨ä¸­ï¼Œé™¤äº†å‚æ•°ä»¥å¤–ï¼Œ<code>argè¡¨</code>ä¸­è¿˜æœ‰ä¸€ä¸ª<code>åŸŸ n</code> è¡¨ç¤ºå‚æ•°çš„ä¸ªæ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span> <span class="params">(a, b, ...)</span></span> <span class="keyword">end</span></span><br><span class="line">CALL PARAMETERS</span><br><span class="line">g(<span class="number">3</span>) a=<span class="number">3</span>, b=<span class="literal">nil</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;<span class="number">5</span>, <span class="number">8</span>; n=<span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæˆ‘ä»¬åªæƒ³è¦ string.find è¿”å›çš„ç¬¬äºŒä¸ªå€¼ï¼šä¸€ä¸ªå…¸å‹çš„æ–¹æ³•æ˜¯ä½¿ç”¨è™šå˜é‡ï¼ˆä¸‹åˆ’çº¿ï¼‰</p>
<blockquote>
<p>local _, x &#x3D; string.find(s, p)</p>
</blockquote>
<h3 id="5-3-named-parameter-å‘½åå‚æ•°"><a href="#5-3-named-parameter-å‘½åå‚æ•°" class="headerlink" title="5.3 named parameter å‘½åå‚æ•°"></a>5.3 named parameter å‘½åå‚æ•°</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rename</span> <span class="params">(arg)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">os</span>.<span class="built_in">rename</span>(<span class="built_in">arg</span>.old, <span class="built_in">arg</span>.new)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rename</span>&#123;old=<span class="string">&quot;temp.lua&quot;</span>, new=<span class="string">&quot;temp1.lua&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-function-plus-å†è®ºå‡½æ•°"><a href="#6-function-plus-å†è®ºå‡½æ•°" class="headerlink" title="6. function plus å†è®ºå‡½æ•°"></a>6. function plus å†è®ºå‡½æ•°</h2><p>note: <em><strong>Lua ä¸­çš„å‡½æ•°æ˜¯å¸¦æœ‰è¯æ³•å®šç•Œï¼ˆlexical scopingï¼‰çš„ç¬¬ä¸€ç±»å€¼ï¼ˆfirst-class valuesï¼‰ã€‚</strong></em></p>
<p>**ç¬¬ä¸€ç±»å€¼(first-class values)**æŒ‡ï¼š<em><strong>åœ¨ Lua ä¸­å‡½æ•°å’Œå…¶ä»–å€¼ï¼ˆæ•°å€¼ã€å­—ç¬¦ä¸²ï¼‰ä¸€æ ·ï¼Œå‡½æ•°å¯ä»¥è¢«å­˜æ”¾åœ¨å˜é‡ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜æ”¾åœ¨è¡¨ä¸­ï¼Œå¯ä»¥ä½œä¸ºå‡½æ•°çš„å‚æ•°ï¼Œè¿˜å¯ä»¥ä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚</strong></em></p>
<p>**è¯æ³•å®šç•Œ(lexical scoping)**æŒ‡ï¼š<em><strong>è¢«åµŒå¥—çš„å‡½æ•°å¯ä»¥è®¿é—®ä»–å¤–éƒ¨å‡½æ•°ä¸­çš„å˜é‡ã€‚è¿™ä¸€ç‰¹æ€§ç»™ Lua æä¾›äº†å¼ºå¤§çš„ç¼–ç¨‹èƒ½åŠ›ã€‚</strong></em></p>
<p>Lua ä¸­æˆ‘ä»¬ç»å¸¸è¿™æ ·å†™ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>è¿™å®é™…ä¸Šæ˜¯åˆ©ç”¨ Lua æä¾›çš„â€œè¯­æ³•ä¸Šçš„ç”œå¤´â€ï¼ˆ<em><strong>syntactic sugar</strong></em>ï¼‰çš„ç»“æœï¼Œä¸‹é¢æ˜¯åŸæœ¬çš„å‡½æ•°ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- why you try like that? because i dont&#x27;t like sugar</span></span><br><span class="line">foo = <span class="function"><span class="keyword">function</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ ¹æ®å­¦ç”Ÿçš„æˆç»©ä»é«˜åˆ°ä½å¯¹å­¦ç”Ÿè¿›è¡Œæ’åºï¼Œ è¿™é‡Œçš„ names, grades ä½œç”¨åŸŸæ˜¯è¿™ä¸ªchunkçš„å…¨å±€</span></span><br><span class="line">names = &#123;<span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Paul&quot;</span>, <span class="string">&quot;Mary&quot;</span>&#125;</span><br><span class="line">grades = &#123;Mary = <span class="number">10</span>, Paul = <span class="number">7</span>, Peter = <span class="number">8</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line"><span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>ä»¥å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°çš„å‡½æ•°åœ¨ Lua ä¸­è¢«ç§°ä½œ<code>é«˜çº§å‡½æ•°</code>ï¼Œé«˜çº§å‡½æ•°åœ¨ Lua ä¸­å¹¶æ²¡æœ‰ç‰¹æƒï¼Œåªæ˜¯ Lua æŠŠå‡½æ•°å½“ä½œ<code>ç¬¬ä¸€ç±»å‡½æ•°</code>å¤„ç†çš„ä¸€ä¸ªç®€å•çš„ç»“æœã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortbygrade</span> <span class="params">(names, grades)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line">        <span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>åŒ…å«åœ¨ sortbygrade å‡½æ•°å†…éƒ¨çš„ sort ä¸­çš„åŒ¿åå‡½æ•°å¯ä»¥è®¿é—® sortbygrade çš„å‚æ•°gradesï¼Œ<br>åœ¨<code>åŒ¿åå‡½æ•°å†…éƒ¨</code> grades ä¸æ˜¯å…¨å±€å˜é‡ä¹Ÿä¸æ˜¯å±€éƒ¨å˜é‡ï¼Œæˆ‘ä»¬ç§°ä½œ<code>å¤–éƒ¨çš„å±€éƒ¨å˜é‡</code>ï¼ˆexternal local variableï¼‰æˆ–è€… <code>upvalue</code>ã€‚</p>
<p>æŠ€æœ¯ä¸Šæ¥è®²ï¼Œ<code>é—­åŒ…</code>æŒ‡å€¼è€Œä¸æ˜¯æŒ‡å‡½æ•°ï¼Œå‡½æ•°ä»…ä»…æ˜¯é—­åŒ…çš„ä¸€ä¸ª<code>åŸå‹å£°æ˜</code>ï¼›</p>
<blockquote>
<p>é—­åŒ…çš„å£°æ˜å‘¨æœŸ?</p>
</blockquote>
<p>ç®€å•çš„è¯´<code>é—­åŒ…</code> æ˜¯ <em><strong>ä¸€ä¸ªå‡½æ•°åŠ ä¸Šå®ƒå¯ä»¥æ­£ç¡®è®¿é—®çš„ upvaluesã€‚</strong></em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Lib = &#123;&#125;</span><br><span class="line">Lib.foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span></span><br><span class="line">Lib.goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span></span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;</span><br><span class="line">    foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span>,</span><br><span class="line">    goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.foo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.goo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x - y</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Lua æŠŠ <code>chunk</code> å½“ä½œ<code>å‡½æ•°</code>å¤„ç†ï¼Œåœ¨ chunk å†…å¯ä»¥å£°æ˜<code>å±€éƒ¨å‡½æ•°</code>ï¼ˆ<em><strong>ä»…ä»…åœ¨ chunk å†…å¯è§</strong></em>ï¼‰ï¼Œè¯æ³•å®šç•Œä¿è¯äº†åŒ…å†…çš„<code>å…¶ä»–å‡½æ•°</code><strong>å¯ä»¥è°ƒç”¨</strong>æ­¤å‡½æ•°ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- error usage</span></span><br><span class="line"><span class="keyword">local</span> fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>) <span class="comment">-- buggy</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢è¿™ç§æ–¹å¼å¯¼è‡´ Lua ç¼–è¯‘æ—¶é‡åˆ° fact(n-1)å¹¶<em>ä¸çŸ¥é“ä»–æ˜¯å±€éƒ¨å‡½æ•°</em> <code>fact</code>ï¼ŒLua ä¼šå»æŸ¥æ‰¾æ˜¯å¦æœ‰è¿™æ ·çš„<em>å…¨å±€å‡½æ•°</em> <code>fact</code>ã€‚<br>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬å¿…é¡»åœ¨<em>å®šä¹‰å‡½æ•°ä»¥å‰</em> å…ˆ<strong>å£°æ˜</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> fact</span><br><span class="line">fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>ä½†æ˜¯ Lua æ‰©å±•äº†ä»–çš„è¯­æ³•ä½¿å¾—å¯ä»¥åœ¨ç›´æ¥é€’å½’å‡½æ•°å®šä¹‰æ—¶ä½¿ç”¨ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥ã€‚</em><br>note:<em>åœ¨å®šä¹‰<code>é</code>ç›´æ¥é€’å½’å±€éƒ¨å‡½æ•°æ—¶è¦<strong>å…ˆå£°æ˜</strong>ç„¶åå®šä¹‰æ‰å¯ä»¥</em></p>
<h3 id="6-3-proper-tail-calls-å°¾è°ƒç”¨"><a href="#6-3-proper-tail-calls-å°¾è°ƒç”¨" class="headerlink" title="6.3 proper tail calls å°¾è°ƒç”¨"></a>6.3 proper tail calls å°¾è°ƒç”¨</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(x)</span></span></span><br><span class="line">    <span class="keyword">return</span> g(x)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><em>è¿™ç§æƒ…å†µä¸‹å½“è¢«è°ƒç”¨å‡½æ•° g ç»“æŸæ—¶ç¨‹åº<strong>ä¸éœ€è¦è¿”å›</strong>åˆ°<code>è°ƒç”¨è€… f</code>ï¼›</em><br><em>æ‰€ä»¥<strong>å°¾è°ƒç”¨ä¹‹å</strong>ç¨‹åºä¸éœ€è¦åœ¨æ ˆä¸­ä¿ç•™å…³äº*<em>è°ƒç”¨è€…çš„ä»»ä½•ä¿¡æ¯</em></em>ã€‚*<br><em>ä¸€äº›ç¼–è¯‘å™¨æ¯”å¦‚ <strong>Lua è§£é‡Šå™¨</strong>åˆ©ç”¨è¿™ç§ç‰¹æ€§åœ¨å¤„ç†å°¾è°ƒç”¨æ—¶<strong>ä¸ä½¿ç”¨é¢å¤–çš„æ ˆ</strong>ï¼Œæˆ‘ä»¬ç§°è¿™ç§è¯­è¨€*<em>æ”¯æŒ</em></em><code>æ­£ç¡®çš„å°¾è°ƒç”¨</code>ã€‚*</p>
<p>note:<em>ç”±äºå°¾è°ƒç”¨ä¸éœ€è¦ä½¿ç”¨æ ˆç©ºé—´ï¼Œé‚£ä¹ˆå°¾è°ƒç”¨<strong>é€’å½’çš„å±‚æ¬¡</strong>å¯ä»¥æ— é™åˆ¶çš„ã€‚ä¾‹å¦‚ä¸‹é¢è°ƒç”¨ä¸è®º n ä¸ºä½•å€¼*<em>ä¸ä¼šå¯¼è‡´æ ˆæº¢å‡º</em></em>ã€‚*</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> foo(n - <span class="number">1</span>) <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- éå°¾è°ƒç”¨</span></span><br><span class="line"><span class="keyword">return</span> g(x) + <span class="number">1</span> <span class="comment">-- must do the addition</span></span><br><span class="line"><span class="keyword">return</span> x <span class="keyword">or</span> g(x) <span class="comment">-- must adjust to 1 result</span></span><br><span class="line"><span class="keyword">return</span> (g(x)) <span class="comment">-- must adjust to 1 result</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å°†å°¾è°ƒç”¨ç†è§£æˆä¸€ç§ gotoï¼Œåœ¨<strong>çŠ¶æ€æœºçš„ç¼–ç¨‹</strong>é¢†åŸŸå°¾è°ƒç”¨æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚<br>çŠ¶æ€æœºçš„åº”ç”¨è¦æ±‚å‡½æ•°è®°ä½æ¯ä¸€ä¸ªçŠ¶æ€ï¼Œæ”¹å˜çŠ¶æ€åªéœ€è¦ goto(or call)ä¸€ä¸ªç‰¹å®šçš„å‡½æ•°ã€‚</p>
<p>ä¼ ç»Ÿæ¨¡å¼çš„ç¼–è¯‘å™¨å¯¹äºå°¾è°ƒç”¨çš„å¤„ç†æ–¹å¼å°±åƒå¤„ç†å…¶ä»–æ™®é€šå‡½æ•°è°ƒç”¨ä¸€æ ·ï¼Œæ€»ä¼šåœ¨è°ƒç”¨æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„æ ˆå¸§ï¼ˆstack frameï¼‰å¹¶å°†å…¶æ¨å…¥è°ƒç”¨æ ˆé¡¶éƒ¨ï¼Œç”¨äºè¡¨ç¤ºè¯¥æ¬¡å‡½æ•°è°ƒç”¨ã€‚</p>
<p>å½“ä¸€ä¸ªå‡½æ•°è°ƒç”¨å‘ç”Ÿæ—¶ï¼Œè®¡ç®—æœºå¿…é¡» â€œè®°ä½â€ è°ƒç”¨å‡½æ•°çš„ä½ç½® â€”â€” è¿”å›ä½ç½®ï¼Œæ‰å¯ä»¥åœ¨è°ƒç”¨ç»“æŸæ—¶å¸¦ç€è¿”å›å€¼å›åˆ°è¯¥ä½ç½®ï¼Œè¿”å›ä½ç½®ä¸€èˆ¬å­˜åœ¨è°ƒç”¨æ ˆä¸Šã€‚åœ¨å°¾è°ƒç”¨è¿™ç§ç‰¹æ®Šæƒ…å½¢ä¸­ï¼Œè®¡ç®—æœºç†è®ºä¸Šå¯ä»¥<em>ä¸éœ€è¦è®°ä½å°¾è°ƒç”¨çš„ä½ç½®</em>è€Œ<em>ä»è¢«è°ƒç”¨çš„å‡½æ•°ç›´æ¥<strong>å¸¦ç€è¿”å›å€¼</strong>è¿”å›è°ƒç”¨å‡½æ•°çš„è¿”å›ä½ç½®</em>ï¼ˆç›¸å½“äºç›´æ¥è¿ç»­è¿”å›ä¸¤æ¬¡ï¼‰ã€‚<br>å°¾è°ƒç”¨æ¶ˆé™¤å³æ˜¯åœ¨ä¸æ”¹å˜å½“å‰è°ƒç”¨æ ˆï¼ˆä¹Ÿä¸æ·»åŠ æ–°çš„è¿”å›ä½ç½®ï¼‰çš„æƒ…å†µä¸‹è·³åˆ°æ–°å‡½æ•°çš„ä¸€ç§ä¼˜åŒ–ï¼ˆå®Œå…¨ä¸æ”¹å˜è°ƒç”¨æ ˆæ˜¯ä¸å¯èƒ½çš„ï¼Œè¿˜æ˜¯éœ€è¦æ ¡æ­£è°ƒç”¨æ ˆä¸Šå½¢å¼å‚æ•°ä¸å±€éƒ¨å˜é‡çš„ä¿¡æ¯ã€‚ï¼‰</p>
<p>ç”±äºå½“å‰å‡½æ•°å¸§ä¸ŠåŒ…å«å±€éƒ¨å˜é‡ç­‰ç­‰å¤§éƒ¨åˆ†çš„ä¸œè¥¿éƒ½ä¸éœ€è¦äº†ï¼Œå½“å‰çš„<em>å‡½æ•°å¸§ç»è¿‡é€‚å½“çš„æ›´åŠ¨</em>ä»¥åå¯ä»¥<em>ç›´æ¥å½“ä½œè¢«å°¾è°ƒç”¨çš„å‡½æ•°çš„å¸§ä½¿ç”¨</em>ï¼Œç„¶åç¨‹åºå³å¯ä»¥è·³åˆ°è¢«å°¾è°ƒç”¨çš„å‡½æ•°ã€‚äº§ç”Ÿè¿™ç§å‡½æ•°å¸§æ›´åŠ¨ä»£ç ä¸ â€œjumpâ€ï¼ˆè€Œä¸æ˜¯ä¸€èˆ¬å¸¸è§„å‡½æ•°è°ƒç”¨çš„ä»£ç ï¼‰çš„è¿‡ç¨‹ç§°ä½œ<strong>å°¾è°ƒç”¨æ¶ˆé™¤(Tail Call Elimination)<strong>æˆ–</strong>å°¾è°ƒç”¨ä¼˜åŒ–(Tail Call Optimization, TCO)</strong>ã€‚å°¾è°ƒç”¨ä¼˜åŒ–è®©ä½äºå°¾ä½ç½®çš„å‡½æ•°è°ƒç”¨è·Ÿ goto è¯­å¥æ€§èƒ½ä¸€æ ·é«˜ï¼Œä¹Ÿå› æ­¤ä½¿å¾—é«˜æ•ˆçš„ç»“æ„ç¼–ç¨‹æˆä¸ºç°å®ã€‚</p>
<p>ç„¶è€Œï¼Œå¯¹äº <strong>C++</strong> ç­‰è¯­è¨€æ¥è¯´ï¼Œåœ¨å‡½æ•°æœ€å return g(x); å¹¶ä¸ä¸€å®šæ˜¯å°¾é€’å½’â€”â€”åœ¨è¿”å›ä¹‹å‰å¾ˆå¯èƒ½æ¶‰åŠåˆ°<strong>å¯¹è±¡çš„ææ„å‡½æ•°</strong>ï¼Œä½¿å¾— g(x) ä¸æ˜¯æœ€åæ‰§è¡Œçš„é‚£ä¸ªã€‚è¿™å¯ä»¥é€šè¿‡è¿”å›å€¼ä¼˜åŒ–æ¥è§£å†³ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(data1, data2)</span></span></span><br><span class="line">   a(data1)</span><br><span class="line">   <span class="keyword">return</span> b(data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">æ±‡ç¼–ä»£ç :</span><br><span class="line">```asm</span><br><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; é€è¿‡æ ˆæŒ‡é’ˆï¼ˆspï¼‰å–å¾— data1 å¹¶æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data1 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ a ä½¿ç”¨ã€‚</span><br><span class="line">  call a              ; a ä½¿ç”¨ data1ã€‚</span><br><span class="line">  pop                 ; æŠŠ data1 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  mov  reg,[sp+data2] ; é€è¿‡æ ˆæŒ‡é‡ï¼ˆspï¼‰å–å¾— data2 ä¸¦æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data2 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ b ä½¿ç”¨ã€‚</span><br><span class="line">  call b              ; b ä½¿ç”¨ data2ã€‚</span><br><span class="line">  pop                 ; æŠŠ data2 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p>ä¼˜åŒ–åæ±‡ç¼–ä»£ç :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; é€è¿‡æ ˆæŒ‡é’ˆï¼ˆspï¼‰å–å¾— data1 å¹¶æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚</span><br><span class="line">  push reg            ; å°† data1 æ”¾åˆ°æ ˆä¸Šä»¥ä¾¿ a ä½¿ç”¨ã€‚</span><br><span class="line">  call a              ; a ä½¿ç”¨ data1ã€‚</span><br><span class="line">  pop                 ; æŠŠ data1 å¾æ ˆä¸Šæ‹¿æ‰ã€‚</span><br><span class="line">  mov  reg,[sp+data2] ; é€è¿‡æ ˆæŒ‡é‡ï¼ˆspï¼‰å–å¾— data2 ä¸¦æ”¾åˆ°æš‚ç”¨æš‚å­˜å™¨ã€‚  </span><br><span class="line">  mov  [sp+data1],reg ; æŠŠ data2 æ”¾åˆ° b é¢„æœŸçš„ä½ç½®ã€‚</span><br><span class="line">  jmp  b              ; b ä½¿ç”¨ data2 ä¸¦è¿”å›åˆ°è°ƒç”¨ foo çš„å‡½æ•°ã€‚</span><br></pre></td></tr></table></figure>

<h2 id="7-iterator-genericity-for-è¿­ä»£å™¨-æ³›å‹for"><a href="#7-iterator-genericity-for-è¿­ä»£å™¨-æ³›å‹for" class="headerlink" title="7. iterator &amp; genericity for è¿­ä»£å™¨ æ³›å‹for"></a>7. iterator &amp; genericity for è¿­ä»£å™¨ æ³›å‹for</h2><p>åˆ›å»ºä¸€ä¸ª<code>é—­åŒ…</code>å¿…é¡»è¦åˆ›å»ºå…¶å¤–éƒ¨å±€éƒ¨å˜é‡ã€‚<br>æ‰€ä»¥ä¸€ä¸ªå…¸å‹çš„é—­åŒ…çš„ç»“æ„åŒ…å«ä¸¤ä¸ªå‡½æ•°ï¼šä¸€ä¸ªæ˜¯<code>é—­åŒ…</code>è‡ªå·±ï¼›å¦ä¸€ä¸ªæ˜¯å·¥å‚ï¼ˆ<code>åˆ›å»ºé—­åŒ…çš„å‡½æ•°</code>ï¼‰ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">list_iter</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> n = #t</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &lt;= n <span class="keyword">then</span> <span class="keyword">return</span> t[i] <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line">iter = list_iter(t) <span class="comment">-- creates the iterator</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> element = iter() <span class="comment">-- calls the iterator</span></span><br><span class="line">    <span class="keyword">if</span> element == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- æ³›å‹ for</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> list_iter(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>è¿™ä¸ªä¾‹å­ä¸­ list_iter æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œæ¯æ¬¡è°ƒç”¨ä»–éƒ½ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„é—­åŒ…ï¼ˆè¿­ä»£å™¨æœ¬èº«ï¼‰</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- è¿­ä»£å™¨</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allwords</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- current line</span></span><br><span class="line">    <span class="keyword">local</span> pos = <span class="number">1</span> <span class="comment">-- current position in the line</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator function</span></span><br><span class="line">        <span class="keyword">while</span> line <span class="keyword">do</span> <span class="comment">-- repeat while there are lines</span></span><br><span class="line">            <span class="keyword">local</span> s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(line, <span class="string">&quot;%w+&quot;</span>, pos)</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">then</span> <span class="comment">-- found a word</span></span><br><span class="line">                pos = e + <span class="number">1</span> <span class="comment">-- next position is after this word</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(line, s, e) <span class="comment">-- return the word</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- word not found; try next line</span></span><br><span class="line">                pos = <span class="number">1</span> <span class="comment">-- restart from first position</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">-- no more lines: end of traversal</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> allwords() <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(word)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-genericity-for-æ³›å‹-for-çš„è¯­ä¹‰"><a href="#7-2-genericity-for-æ³›å‹-for-çš„è¯­ä¹‰" class="headerlink" title="7.2 genericity for æ³›å‹ for çš„è¯­ä¹‰"></a>7.2 genericity for æ³›å‹ for çš„è¯­ä¹‰</h3><p>ä¸€èˆ¬å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var_1, ..., var_n <span class="keyword">in</span> explist <span class="keyword">do</span> block <span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ==&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> _f, _s, _var = explist</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> var_1, ... , var_n = _f(_s, _var)</span><br><span class="line">        _var = var_1</span><br><span class="line">        <span class="keyword">if</span> _var == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        block</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-iterator-without-status-æ— çŠ¶æ€çš„è¿­ä»£å™¨"><a href="#7-3-iterator-without-status-æ— çŠ¶æ€çš„è¿­ä»£å™¨" class="headerlink" title="7.3 iterator without status æ— çŠ¶æ€çš„è¿­ä»£å™¨"></a>7.3 iterator without status æ— çŠ¶æ€çš„è¿­ä»£å™¨</h3><p>note:<em>è¿­ä»£çš„çŠ¶æ€åŒ…æ‹¬è¢«éå†çš„è¡¨ï¼ˆå¾ªç¯è¿‡ç¨‹ä¸­ä¸ä¼šæ”¹å˜çš„<code>çŠ¶æ€å¸¸é‡</code>ï¼‰å’Œå½“å‰çš„ç´¢å¼•ä¸‹æ ‡ï¼ˆ<code>æ§åˆ¶å˜é‡</code>ï¼‰ï¼Œ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span> <span class="params">(a, i)</span></span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> v = a[i]</span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> i, v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ipairs</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">return</span> iter, a, <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>å½“ Lua è°ƒç”¨ ipairs(a)å¼€å§‹å¾ªç¯æ—¶ï¼Œä»–è·å–ä¸‰ä¸ªå€¼:è¿­ä»£å‡½æ•° iterï¼ŒçŠ¶æ€å¸¸é‡ a å’Œæ§åˆ¶å˜é‡åˆå§‹å€¼ 0ï¼›ç„¶å Lua è°ƒç”¨ iter(a,0)è¿”å› 1,a[1]ï¼ˆé™¤é a[1]&#x3D;nilï¼‰ï¼›ç›´åˆ°<strong>ç¬¬ä¸€ä¸ª</strong>é nil å…ƒç´ </em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> n</span><br><span class="line"><span class="comment">-- n = nil å…¨éƒ¨</span></span><br><span class="line"><span class="comment">-- n = 1 æ‰“å°ä»2 å¼€å§‹</span></span><br><span class="line"><span class="comment">-- n = 0 å‡ºé”™</span></span><br><span class="line">dd=&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,&#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">next</span>, dd, n <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-multi-status-iterator-å¤šçŠ¶æ€çš„è¿­ä»£å™¨"><a href="#7-3-multi-status-iterator-å¤šçŠ¶æ€çš„è¿­ä»£å™¨" class="headerlink" title="7.3 multi status iterator å¤šçŠ¶æ€çš„è¿­ä»£å™¨"></a>7.3 multi status iterator å¤šçŠ¶æ€çš„è¿­ä»£å™¨</h3><h2 id="8-compile-run-debug-ç¼–è¯‘-è¿è¡Œ-è°ƒè¯•"><a href="#8-compile-run-debug-ç¼–è¯‘-è¿è¡Œ-è°ƒè¯•" class="headerlink" title="8. compile run debug ç¼–è¯‘ è¿è¡Œ è°ƒè¯•"></a>8. compile run debug ç¼–è¯‘ è¿è¡Œ è°ƒè¯•</h2><p>note: <em>è§£é‡Šå‹è¯­è¨€çš„ç‰¹å¾ä¸åœ¨äºä»–ä»¬æ˜¯å¦è¢«ç¼–è¯‘ï¼Œè€Œæ˜¯<code>ç¼–è¯‘å™¨</code>æ˜¯<code>è¯­è¨€è¿è¡Œæ—¶</code>çš„ä¸€éƒ¨åˆ†</em></p>
<p>loadfile:<em>ç¼–è¯‘ä»£ç æˆä¸­é—´ç å¹¶ä¸”è¿”å›ç¼–è¯‘åçš„ chunk ä½œä¸ºä¸€ä¸ªå‡½æ•°ï¼Œè€Œä¸æ‰§è¡Œä»£ç ï¼›</em></p>
<p>note:<em>åœ¨å‘ç”Ÿé”™è¯¯çš„æƒ…å†µä¸‹ï¼Œloadfile è¿”å› nil å’Œé”™è¯¯ä¿¡æ¯ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è‡ªå®šä¹‰é”™è¯¯å¤„ç†</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">loadstring</span>(<span class="string">&quot;i = i + 1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>note:<em>f å°†æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨æ—¶æ‰§è¡Œ i&#x3D;i+1</em></p>
<p>Lua æŠŠæ¯ä¸€ä¸ª chunk éƒ½ä½œä¸ºä¸€ä¸ª<code>åŒ¿åå‡½æ•°</code>å¤„ç†ã€‚<br>ä¾‹å¦‚ï¼šchunk â€œa &#x3D; 1â€ï¼Œ<br><code>loadstring</code> è¿”å›ä¸å…¶ç­‰ä»·çš„ <code>function () a = 1 end</code>ä¸å…¶ä»–å‡½æ•°ä¸€æ ·ï¼Œ<br>chunks å¯ä»¥å®šä¹‰å±€éƒ¨å˜é‡ä¹Ÿå¯ä»¥è¿”å›å€¼ï¼š<code>f = loadstring(&quot;local a = 10; return a + 20&quot;)</code></p>
<p>note:<em>loadfile å’Œ loadstring éƒ½ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœå‘ç”Ÿé”™è¯¯ä»–ä»¬å°†è¿”å› nil åŠ ä¸Šé”™è¯¯ä¿¡æ¯ï¼š</em><br>note:<em>Lua ä¸­çš„<code>å‡½æ•°å®šä¹‰</code>æ˜¯å‘ç”Ÿåœ¨<code>è¿è¡Œæ—¶çš„èµ‹å€¼</code>è€Œä¸æ˜¯å‘ç”Ÿåœ¨ç¼–è¯‘æ—¶ã€‚</em></p>
<p>å¦‚æœä½ æƒ³å¿«æ·çš„è°ƒç”¨ dostringï¼ˆæ¯”å¦‚åŠ è½½å¹¶è¿è¡Œï¼‰ï¼Œå¯ä»¥è¿™æ ·<br><code>loadstring(s)()</code></p>
<p>å¦‚æœåŠ è½½çš„å†…å®¹å­˜åœ¨<code>è¯­æ³•é”™è¯¯</code>çš„è¯ï¼Œloadstring è¿”å› nil å’Œé”™è¯¯ä¿¡æ¯ï¼ˆattempt to call a nil valueï¼‰ï¼›ä¸ºäº†è¿”å›æ›´æ¸…æ¥šçš„é”™è¯¯ä¿¡æ¯å¯ä»¥ä½¿ç”¨ assertï¼š<br><code>assert(loadstring(s))()</code></p>
<p>note:<em>æ¯æ¬¡è°ƒç”¨ loadstring éƒ½ä¼šé‡æ–°ç¼–è¯‘,loadstring ç¼–è¯‘çš„æ—¶å€™ä¸å…³å¿ƒè¯æ³•èŒƒå›´</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">f = <span class="built_in">loadstring</span>(<span class="string">&quot;i = i + 1&quot;</span>)</span><br><span class="line">g = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> i = i + <span class="number">1</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>è¿™ä¸ªä¾‹å­ä¸­ï¼Œå’Œæƒ³è±¡çš„ä¸€æ · <code>g</code> ä½¿ç”¨*<em>å±€éƒ¨å˜é‡</em></em> iï¼Œç„¶è€Œ <code>f</code> ä½¿ç”¨<strong>å…¨å±€å˜é‡</strong> iï¼›<code>loadstring</code> æ€»æ˜¯åœ¨<strong>å…¨å±€ç¯å¢ƒ</strong>ä¸­<strong>ç¼–è¯‘</strong>ä»–çš„ä¸²ã€‚*</p>
<p>note:<em>loadstring æœŸæœ›ä¸€ä¸ª chunkï¼Œå³è¯­å¥ã€‚å¦‚æœæƒ³è¦åŠ è½½<code>è¡¨è¾¾å¼</code>ï¼Œéœ€è¦åœ¨è¡¨è¾¾å¼å‰åŠ  <code>return</code>ï¼Œé‚£æ ·å°†è¿”å›è¡¨è¾¾å¼çš„å€¼ã€‚</em></p>
<h2 id="8-1-require"><a href="#8-1-require" class="headerlink" title="8.1 require"></a>8.1 require</h2><ul>
<li><em>ä¼šæœç´¢ç›®å½•åŠ è½½æ–‡ä»¶</em></li>
<li><em>ä¼šåˆ¤æ–­æ˜¯å¦æ–‡ä»¶å·²ç»åŠ è½½é¿å…é‡å¤åŠ è½½åŒä¸€æ–‡ä»¶</em></li>
<li><em>?;?.lua;c:\windows?;&#x2F;usr&#x2F;local&#x2F;lua&#x2F;?&#x2F;?.lua</em></li>
<li><em>require å’Œ dofile å®ŒæˆåŒæ ·çš„åŠŸèƒ½</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> lili</span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">lili</span></span><br><span class="line"><span class="comment">lili.lua</span></span><br><span class="line"><span class="comment">c:\windows\lili</span></span><br><span class="line"><span class="comment">/usr/local/lua/lili/lili.lua</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>

<p>note:<em>è¡¨ä¸­ä¿ç•™åŠ è½½çš„æ–‡ä»¶çš„è™šåï¼Œè€Œä¸æ˜¯å®æ–‡ä»¶åã€‚æ‰€ä»¥å¦‚æœä½ ä½¿ç”¨ä¸åŒçš„è™šæ–‡ä»¶å requireåŒä¸€ä¸ªæ–‡ä»¶ä¸¤æ¬¡ï¼Œå°†ä¼šåŠ è½½ä¸¤æ¬¡è¯¥æ–‡ä»¶ã€‚æ¯”å¦‚ require â€œfooâ€å’Œ require â€œfoo.luaâ€ï¼Œå°†ä¼šåŠ è½½ foo.lua ä¸¤æ¬¡,å…¨å±€å˜é‡<code>_LOADED</code> è®¿é—®æ–‡ä»¶ååˆ—è¡¨, <code>_REQUIREDNAME</code></em></p>
<h3 id="8-2-C-Packages"><a href="#8-2-C-Packages" class="headerlink" title="8.2 C Packages"></a>8.2 C Packages</h3><p>note:<em>åŠ¨æ€è¿æ¥åº“ä¸æ˜¯ ANSI C çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨æ ‡å‡† C ä¸­å®ç°åŠ¨æ€è¿æ¥æ˜¯å¾ˆå›°éš¾çš„ã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = <span class="string">&quot;/usr/local/lua/lib/libluasocket.so&quot;</span></span><br><span class="line"><span class="comment">-- or path = &quot;C:\\windows\\luasocket.dll&quot;</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">loadlib</span>(<span class="built_in">path</span>, <span class="string">&quot;luaopen_socket&quot;</span>))</span><br><span class="line">f() <span class="comment">-- actually open the library</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-error-é”™è¯¯"><a href="#8-3-error-é”™è¯¯" class="headerlink" title="8.3 error é”™è¯¯"></a>8.3 error é”™è¯¯</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">&quot;enter a number:&quot;</span></span><br><span class="line">n = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="built_in">error</span>(<span class="string">&quot;invalid input&quot;</span>) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-exception-pcall"><a href="#8-4-exception-pcall" class="headerlink" title="8.4 exception &amp; pcall"></a>8.4 exception &amp; pcall</h3><h3 id="8-5-exception-msg-xpcall"><a href="#8-5-exception-msg-xpcall" class="headerlink" title="8.5 exception msg &amp; xpcall"></a>8.5 exception msg &amp; xpcall</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">error</span>(<span class="string">&quot;string expected&quot;</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>())</span><br></pre></td></tr></table></figure>

<h2 id="9-0-coroutine"><a href="#9-0-coroutine" class="headerlink" title="9.0 coroutine"></a>9.0 coroutine</h2><p>ååŒç¨‹åºï¼ˆcoroutineï¼‰<em>ä¸å¤šçº¿ç¨‹æƒ…å†µä¸‹çš„çº¿ç¨‹æ¯”è¾ƒç±»ä¼¼ï¼šæœ‰è‡ªå·±çš„å †æ ˆï¼Œè‡ªå·±çš„å±€éƒ¨å˜é‡ï¼Œæœ‰è‡ªå·±çš„æŒ‡ä»¤æŒ‡é’ˆï¼Œä½†æ˜¯å’Œå…¶ä»–ååŒç¨‹åºå…±äº«å…¨å±€å˜é‡ç­‰å¾ˆå¤šä¿¡æ¯ã€‚</em></p>
<p>çº¿ç¨‹å’ŒååŒç¨‹åºçš„ä¸»è¦ä¸åŒåœ¨äºï¼šåœ¨å¤šå¤„ç†å™¨æƒ…å†µä¸‹ï¼Œä»æ¦‚å¿µä¸Šæ¥è®²å¤šçº¿ç¨‹ç¨‹åºåŒæ—¶è¿è¡Œå¤šä¸ªçº¿ç¨‹ï¼›è€ŒååŒç¨‹åºæ˜¯é€šè¿‡åä½œæ¥å®Œæˆï¼Œåœ¨<strong>ä»»ä¸€æŒ‡å®šæ—¶åˆ»åªæœ‰ä¸€ä¸ªååŒç¨‹åºåœ¨è¿è¡Œ</strong>ï¼Œå¹¶ä¸”è¿™ä¸ªæ­£åœ¨è¿è¡Œçš„ååŒç¨‹åºåªæœ‰åœ¨æ˜ç¡®çš„è¢«è¦æ±‚æŒ‚èµ·çš„æ—¶å€™æ‰ä¼šè¢«æŒ‚èµ·ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;hi&quot;</span>) <span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(co) <span class="comment">--&gt; thread: 0x8071d98</span></span><br></pre></td></tr></table></figure>

<p>note:<em>ååŒæœ‰ä¸‰ä¸ªçŠ¶æ€ï¼šæŒ‚èµ·æ€ã€è¿è¡Œæ€ã€åœæ­¢æ€.å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªååŒç¨‹åºæ—¶ä»–å¼€å§‹çš„çŠ¶æ€ä¸ºæŒ‚èµ·æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åˆ›å»ºååŒç¨‹åºçš„æ—¶å€™ä¸ä¼šè‡ªåŠ¨è¿è¡Œï¼Œ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; suspended</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; dead</span></span><br><span class="line"></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, i)</span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ååŒç¨‹åºå¤„äºç»ˆæ­¢çŠ¶æ€ æ¿€æ´»ä»–ï¼Œresume å°†è¿”å› false å’Œé”™è¯¯ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">--&gt; false cannot resume dead coroutine</span></span><br></pre></td></tr></table></figure>

<p>note:<em>resume è¿è¡Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹ï¼Œå› æ­¤å¦‚æœååŒå†…éƒ¨å­˜åœ¨é”™è¯¯ Lua å¹¶ä¸ä¼šæŠ›å‡ºé”™è¯¯è€Œæ˜¯å°†é”™è¯¯è¿”å›ç»™ resume å‡½æ•°ã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- yield è¿”å›çš„é¢å¤–çš„å‚æ•°ä¹Ÿå°†ä¼šä¼ é€’ç»™ resumeã€‚</span></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span> (<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, <span class="built_in">coroutine</span>.<span class="built_in">yield</span>())</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">4</span>, <span class="number">5</span>) <span class="comment">--&gt; co 4 5</span></span><br></pre></td></tr></table></figure>

<ul>
<li>resume æŠŠé¢å¤–çš„å‚æ•°ä¼ é€’ç»™ååŒçš„ä¸»ç¨‹åºã€‚</li>
<li>resume è¿”å›é™¤äº† true ä»¥å¤–çš„å…¶ä»–éƒ¨åˆ†å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™ç›¸åº”çš„ yield, yield è¿”å›çš„é¢å¤–çš„å‚æ•°ä¹Ÿå°†ä¼šä¼ é€’ç»™ resumeã€‚</li>
<li>å½“ååŒä»£ç ç»“æŸæ—¶ä¸»å‡½æ•°è¿”å›çš„å€¼éƒ½ä¼šä¼ ç»™ç›¸åº”çš„ resume</li>
</ul>
<p>å¯¹ç§°ååŒ:<em>ç”±æ‰§è¡Œåˆ°æŒ‚èµ·ä¹‹é—´çŠ¶æ€è½¬æ¢çš„å‡½æ•°æ˜¯ç›¸åŒçš„ã€‚</em><br>ä¸å¯¹ç§°ååŒ(åŠååŒ):<em>æŒ‚èµ·ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ååŒçš„å‡½æ•°ä¸ä½¿ä¸€ ä¸ªè¢«æŒ‚èµ·çš„ååŒå†æ¬¡æ‰§è¡Œçš„å‡½æ•°æ˜¯ä¸åŒçš„</em></p>
<h3 id="9-2-filter-è¿‡æ»¤å™¨"><a href="#9-2-filter-è¿‡æ»¤å™¨" class="headerlink" title="9.2 filter è¿‡æ»¤å™¨"></a>9.2 filter è¿‡æ»¤å™¨</h3><p>è¿‡æ»¤å™¨:<em>æŒ‡åœ¨ç”Ÿäº§è€…ä¸æ¶ˆè´¹è€…ä¹‹é—´ï¼Œå¯ä»¥å¯¹æ•°æ® è¿›è¡ŒæŸäº›è½¬æ¢å¤„ç†ã€‚è¿‡æ»¤å™¨åœ¨åŒä¸€æ—¶é—´æ—¢æ˜¯ç”Ÿäº§è€…åˆæ˜¯æ¶ˆè´¹è€…ï¼Œä»–è¯·æ±‚ç”Ÿäº§è€…ç”Ÿäº§å€¼å¹¶ ä¸”è½¬æ¢æ ¼å¼åä¼ ç»™æ¶ˆè´¹è€…</em></p>
<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receive</span> <span class="params">(prod)</span></span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, value = <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(prod)</span><br><span class="line">   <span class="keyword">return</span> value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> <span class="params">(x)</span></span></span><br><span class="line">   <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(x)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- produce new value</span></span><br><span class="line">            send(x)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span> <span class="params">(prod)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">       <span class="keyword">local</span> line = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">            x = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%5d %s&quot;</span>, line, x)</span><br><span class="line">            send(x) <span class="comment">-- send it to consumer</span></span><br><span class="line">            line = line + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">consumer</span> <span class="params">(prod)</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(x, <span class="string">&quot;\n&quot;</span>) <span class="comment">-- consume new value</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">consumer(filter(producer()))</span><br></pre></td></tr></table></figure>

<h3 id="9-3-iterator-è¿­ä»£å™¨"><a href="#9-3-iterator-è¿­ä»£å™¨" class="headerlink" title="9.3 iterator è¿­ä»£å™¨"></a>9.3 iterator è¿­ä»£å™¨</h3><p>origin:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        printResult(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">       <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">&quot; &quot;</span>)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">permgen (&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;, <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">local</span> n = #a</span><br><span class="line">    <span class="keyword">local</span> co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator</span></span><br><span class="line">        <span class="keyword">local</span> code, res = <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> perm&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125; <span class="keyword">do</span></span><br><span class="line">   printResult(p)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>coroutine.wrap:<em>wrap åˆ›å»ºä¸€ä¸ªååŒç¨‹åº;ä¸åŒçš„æ˜¯ wrap ä¸è¿”å›å åŒæœ¬èº«ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå½“è¿™ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶å°† resume ååŒ</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">local</span> n = #a</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">wrap</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="9-4-pre-emptive-multi-thread-éæŠ¢å å¼å¤šçº¿ç¨‹"><a href="#9-4-pre-emptive-multi-thread-éæŠ¢å å¼å¤šçº¿ç¨‹" class="headerlink" title="9.4 pre-emptive multi thread éæŠ¢å å¼å¤šçº¿ç¨‹"></a>9.4 pre-emptive multi thread éæŠ¢å å¼å¤šçº¿ç¨‹</h3><p>note:<em>ååŒæ˜¯éæŠ¢å å¼çš„ã€‚ å½“ä¸€ä¸ªååŒæ­£åœ¨è¿è¡Œæ—¶ï¼Œä¸èƒ½åœ¨å¤–éƒ¨ç»ˆæ­¢ä»–ã€‚åªèƒ½é€šè¿‡æ˜¾ç¤ºçš„è°ƒç”¨ yield æŒ‚èµ·ä»–çš„æ‰§è¡Œã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ååŒæ˜¯éæŠ¢å å¼çš„ã€‚ å½“ä¸€ä¸ªååŒæ­£åœ¨è¿è¡Œæ—¶ï¼Œä¸èƒ½åœ¨å¤–éƒ¨ç»ˆæ­¢ä»–ã€‚åªèƒ½é€šè¿‡æ˜¾ç¤ºçš„è°ƒç”¨ <span class="built_in">yield</span> æŒ‚èµ·ä»–çš„æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p>table &amp; object</p>
</blockquote>
<h2 id="11-datastruct"><a href="#11-datastruct" class="headerlink" title="11. datastruct"></a>11. datastruct</h2><h3 id="11-1-array-æ•°ç»„"><a href="#11-1-array-æ•°ç»„" class="headerlink" title="11.1 array æ•°ç»„"></a>11.1 array æ•°ç»„</h3><h3 id="11-2-matrix-multidimensional-array-é˜µ-å¤šç»´æ•°ç»„"><a href="#11-2-matrix-multidimensional-array-é˜µ-å¤šç»´æ•°ç»„" class="headerlink" title="11.2 matrix &amp; multidimensional array é˜µ å¤šç»´æ•°ç»„"></a>11.2 matrix &amp; multidimensional array é˜µ å¤šç»´æ•°ç»„</h3><p>ç¨€ç–çŸ©é˜µ:<em>æŒ‡çŸ©é˜µçš„å¤§éƒ¨åˆ†å…ƒç´ éƒ½ä¸ºç©ºæˆ–è€… 0 çš„çŸ©é˜µã€‚</em></p>
<h3 id="11-3-linked-list-sé“¾è¡¨"><a href="#11-3-linked-list-sé“¾è¡¨" class="headerlink" title="11.3 linked list sé“¾è¡¨"></a>11.3 linked list sé“¾è¡¨</h3><h3 id="11-4-queen-dique-sé˜Ÿåˆ—-åŒç«¯é˜Ÿåˆ—"><a href="#11-4-queen-dique-sé˜Ÿåˆ—-åŒç«¯é˜Ÿåˆ—" class="headerlink" title="11.4 queen &amp; dique sé˜Ÿåˆ— åŒç«¯é˜Ÿåˆ—"></a>11.4 queen &amp; dique sé˜Ÿåˆ— åŒç«¯é˜Ÿåˆ—</h3><p>note:<em>Lua çš„ table åº“æä¾›çš„ insert å’Œ remove æ“ä½œæ¥å®ç°é˜Ÿåˆ—ï¼Œä½†è¿™ç§æ–¹å¼ å®ç°çš„é˜Ÿåˆ—é’ˆå¯¹<strong>å¤§æ•°æ®é‡</strong>æ—¶æ•ˆç‡å¤ªä½</em></p>
<p>note:<em>æœ‰æ•ˆçš„æ–¹å¼æ˜¯ä½¿ç”¨ä¸¤ä¸ªç´¢å¼•ä¸‹æ ‡ï¼Œä¸€ä¸ªè¡¨ç¤ºç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œå¦ä¸€ä¸ªè¡¨ç¤ºæœ€åä¸€ä¸ªå…ƒç´ ã€‚</em></p>
<h3 id="11-5-set-package-é›†åˆ-åŒ…"><a href="#11-5-set-package-é›†åˆ-åŒ…" class="headerlink" title="11.5 set &amp; package é›†åˆ åŒ…"></a>11.5 set &amp; package é›†åˆ åŒ…</h3><h3 id="11-6-string-buffer-å­—ç¬¦ä¸²ç¼“å†²"><a href="#11-6-string-buffer-å­—ç¬¦ä¸²ç¼“å†²" class="headerlink" title="11.6 string buffer å­—ç¬¦ä¸²ç¼“å†²"></a>11.6 string buffer å­—ç¬¦ä¸²ç¼“å†²</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WARNING: bad code ahead!!</span></span><br><span class="line"><span class="keyword">local</span> buff = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   buff = buff .. line .. <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>å‡å®šåœ¨ loop ä¸­é—´ï¼Œbuff å·²ç»æ˜¯ä¸€ä¸ª 50KB çš„å­—ç¬¦ä¸²ï¼Œ æ¯ä¸€è¡Œçš„å¤§å°ä¸º 20bytesï¼Œ<br>å½“ Lua æ‰§è¡Œ <code>buff..line..&quot;\n&quot;</code>æ—¶ï¼Œå¥¹åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²å¤§å°ä¸º 50,020 bytesï¼Œå¹¶ä¸”ä» buff ä¸­å°† 50KB çš„å­—ç¬¦ä¸²æ‹·è´åˆ°æ–°ä¸²ä¸­ã€‚<br>è€çš„å­—ç¬¦ä¸²å˜æˆäº†åƒåœ¾æ•°æ®ï¼Œä¸¤è½®å¾ªç¯ä¹‹åï¼Œå°†æœ‰ä¸¤ä¸ªè€ä¸²åŒ…å«è¶…è¿‡ 100KB çš„åƒåœ¾ æ•°æ®ã€‚è¿™ä¸ªæ—¶å€™ Lua ä¼šåšå‡ºæ­£ç¡®çš„å†³å®šï¼Œè¿›è¡Œä»–çš„åƒåœ¾æ”¶é›†å¹¶é‡Šæ”¾ 100KB çš„å†…å­˜ã€‚é—®é¢˜ åœ¨äºæ¯ä¸¤æ¬¡å¾ªç¯ Lua å°±è¦è¿›è¡Œä¸€æ¬¡åƒåœ¾æ”¶é›†ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶éœ€è¦è¿›è¡Œ 200 æ¬¡åƒåœ¾æ”¶é›†ã€‚ å¹¶ä¸”å®ƒçš„å†…å­˜ä½¿ç”¨æ˜¯æ•´ä¸ªæ–‡ä»¶å¤§å°çš„ä¸‰å€ã€‚</p>
<p>note:<em>å…¶å®ƒçš„é‡‡ç”¨åƒåœ¾æ”¶é›†ç®—æ³•çš„å¹¶ä¸”å­—ç¬¦ä¸²ä¸å¯å˜çš„è¯­è¨€ ä¹Ÿéƒ½å­˜åœ¨è¿™ä¸ªé—®é¢˜ã€‚Java ä¸“é—¨æä¾› StringBuffer æ¥æ”¹å–„è¿™ç§æƒ…å†µã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newStack</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> &#123;<span class="string">&quot;&quot;</span>&#125;   <span class="comment">-- starts with an empty string</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addString</span> <span class="params">(stack, s)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(stack,s) <span class="comment">--push&#x27;s&#x27;intothethestack for i=#stack-1, 1, -1 do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i]) &gt; <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i+<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    stack[i] = stack[i] .. stack[i+<span class="number">1</span>]</span><br><span class="line">    stack[i+<span class="number">1</span>] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> s = newStack()</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   addString(s, line .. <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = toString(s)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- æˆ–è€…</span></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   <span class="built_in">table</span>.<span class="built_in">insert</span>(t, line)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = <span class="built_in">table</span>.<span class="built_in">concat</span>(t, <span class="string">&quot;\n&quot;</span>) .. <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="12-data-file-storage-Persistence-æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–"><a href="#12-data-file-storage-Persistence-æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–" class="headerlink" title="12. data file storage &amp; Persistence æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–"></a>12. data file storage &amp; Persistence æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–</h2><blockquote>
<p>string.format(â€œ%qâ€, o)</p>
</blockquote>
<h2 id="13-metatables-metamethods"><a href="#13-metatables-metamethods" class="headerlink" title="13. metatables metamethods"></a>13. metatables metamethods</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, t1)</span><br><span class="line"><span class="built_in">assert</span>(<span class="built_in">getmetatable</span>(t) == t1)</span><br></pre></td></tr></table></figure>

<p>note:<em>ä¸€ç»„ç›¸å…³çš„è¡¨å¯ä»¥å…±äº«ä¸€ä¸ª metatable (æè¿°ä»–ä»¬å…±åŒçš„è¡Œä¸º)ã€‚ä¸€ä¸ªè¡¨ä¹Ÿå¯ä»¥æ˜¯<strong>è‡ªèº«</strong>çš„ metatable(æè¿°å…¶ç§æœ‰è¡Œä¸º)ã€‚</em></p>
<h3 id="13-1-arithmetic-operation-metamethods-ç®—æœ¯è¿ç®—çš„-matamethods"><a href="#13-1-arithmetic-operation-metamethods-ç®—æœ¯è¿ç®—çš„-matamethods" class="headerlink" title="13.1  arithmetic operation metamethods ç®—æœ¯è¿ç®—çš„ matamethods"></a>13.1  arithmetic operation metamethods ç®—æœ¯è¿ç®—çš„ matamethods</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Set = &#123;&#125;</span><br><span class="line">Set.mt = &#123;&#125; <span class="comment">-- metatable for sets</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.new</span> <span class="params">(t)</span></span></span><br><span class="line">   <span class="keyword">local</span> set = &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(set, Set.mt)</span><br><span class="line">   <span class="keyword">for</span> _, l <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span> set[l] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> set</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.union</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getmetatable</span>(a) ~= Set.mt <span class="keyword">or</span> <span class="built_in">getmetatable</span>(b) ~= Set.mt <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;attempt to `add&#x27; a set with a non-set value&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(b) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.intersection</span> <span class="params">(a,b)</span></span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">res[k] = b[k]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.tostring</span> <span class="params">(set)</span></span></span><br><span class="line">   <span class="keyword">local</span> s = <span class="string">&quot;&#123;&quot;</span></span><br><span class="line">   <span class="keyword">local</span> sep = <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">pairs</span>(set) <span class="keyword">do</span></span><br><span class="line">s = s .. sep .. e</span><br><span class="line">sep = <span class="string">&quot;, &quot;</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> s .. <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.print</span> <span class="params">(s)</span></span></span><br><span class="line">   <span class="built_in">print</span>(Set.<span class="built_in">tostring</span>(s))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s1 = Set.new&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>&#125;</span><br><span class="line">s2 = Set.new&#123;<span class="number">30</span>, <span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s1))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s2))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__add</span> = Set.union</span><br><span class="line"></span><br><span class="line">s3 = s1 + s2</span><br><span class="line">Set.<span class="built_in">print</span>(s3) <span class="comment">--&gt; &#123;1, 10, 20, 30, 50&#125;</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__mul</span> = Set.intersection</span><br><span class="line">Set.<span class="built_in">print</span>((s1 + s2)*s1)     <span class="comment">--&gt; &#123;10, 20, 30, 50&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>note:<em>é™¤äº†__add,__mul, è¿˜æœ‰__sub(å‡),__div(é™¤),__unm(è´Ÿ),__pow(å¹‚)ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å®šä¹‰__concat å®šä¹‰è¿æ¥è¡Œä¸ºã€‚</em></p>
<p>å¦‚æœä¸¤ä¸ªæ“ä½œæ•°æœ‰ä¸åŒçš„ metatable, Lua é€‰æ‹© metamethod çš„åŸåˆ™:</p>
<ul>
<li>å¦‚æœç¬¬ä¸€ä¸ªå‚æ•°å­˜åœ¨å¸¦æœ‰__add åŸŸçš„ metatableï¼ŒLua ä½¿ç”¨å®ƒä½œä¸º metamethodï¼Œå’Œç¬¬äºŒä¸ªå‚æ•°æ— å…³;</li>
<li>å¦åˆ™ç¬¬äºŒä¸ªå‚æ•°å­˜åœ¨å¸¦æœ‰__add åŸŸçš„ metatableï¼ŒLua ä½¿ç”¨å®ƒä½œä¸º metamethod å¦åˆ™æŠ¥é”™ã€‚</li>
</ul>
<h3 id="13-2-relational-operation-metamethods-å…³ç³»è¿ç®—çš„-metamethods"><a href="#13-2-relational-operation-metamethods-å…³ç³»è¿ç®—çš„-metamethods" class="headerlink" title="13.2 relational operation metamethods å…³ç³»è¿ç®—çš„ metamethods"></a>13.2 relational operation metamethods å…³ç³»è¿ç®—çš„ metamethods</h3><p>note:<em>__eqï¼ˆç­‰äºï¼‰ï¼Œ__ltï¼ˆå°äºï¼‰ ï¼Œå’Œ__leï¼ˆå°äºç­‰äº)</em></p>
<p>note:<em><code>å½“æˆ‘ä»¬é‡åˆ°ååºï¼ˆpartial orderï¼‰æƒ…å†µï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰çš„å…ƒç´ éƒ½å¯ä»¥æ­£ç¡®çš„è¢«æ’åºæƒ…å†µã€‚ä¾‹å¦‚ï¼Œåœ¨å¤§å¤šæ•°æœºå™¨ä¸Šæµ®ç‚¹æ•°ä¸èƒ½è¢«æ’åºï¼Œå› ä¸ºä»–çš„å€¼ä¸æ˜¯ä¸€ä¸ªæ•°å­—ï¼ˆNot a Number å³ NaNï¼‰</code></em></p>
<p>note:<em>æ ¹æ® IEEE 754 çš„æ ‡å‡†ï¼ŒNaN è¡¨ç¤ºä¸€ä¸ªæœªå®šä¹‰çš„å€¼ï¼Œæ¯”å¦‚ 0&#x2F;0 çš„ç»“æœã€‚è¯¥æ ‡å‡†æŒ‡å‡ºä»»ä½•æ¶‰åŠåˆ° NaN æ¯”è¾ƒçš„ç»“æœéƒ½åº”ä¸º falseã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒNaN &lt;&#x3D; x æ€»æ˜¯ falseï¼Œx &lt; NaN ä¹Ÿæ€»æ˜¯ falseã€‚è¿™æ ·ä¸€æ¥ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ a &lt;&#x3D; b è½¬æ¢ä¸º not (b &lt; a)å°±ä¸å†æ­£ç¡®äº†ã€‚</em></p>
<p>note:<em>&lt;&#x3D;ä»£è¡¨é›†åˆçš„åŒ…å«ï¼ša &lt;&#x3D; b è¡¨ç¤ºé›†åˆ a æ˜¯é›†åˆ b çš„å­é›†ã€‚è¿™ç§æ„ä¹‰ä¸‹ï¼Œå¯èƒ½ a &lt;&#x3D; b å’Œ b &lt; a éƒ½æ˜¯ falseï¼›</em></p>
<p>note:<em>å…³ç³»å…ƒç®—çš„ metamethods ä¸æ”¯æŒæ··åˆç±»å‹è¿ç®—</em></p>
<p>note:<em>è¯•å›¾æ¯”è¾ƒä¸€ä¸ªå­—ç¬¦ä¸²å’Œä¸€ä¸ªæ•°å­—ï¼ŒLua å°†æŠ›å‡ºé”™è¯¯.ç›¸ä¼¼çš„ï¼Œå¦‚æœä½ è¯•å›¾æ¯”è¾ƒä¸¤ä¸ªå¸¦æœ‰ä¸åŒ metamethods çš„å¯¹è±¡ï¼ŒLua ä¹Ÿå°†æŠ›å‡ºé”™è¯¯ã€‚</em></p>
<p>note:<em>ä½†ç›¸ç­‰æ¯”è¾ƒä»æ¥ä¸ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡æœ‰ä¸åŒçš„ metamethodï¼Œæ¯”è¾ƒçš„ç»“æœä¸ºfalseï¼Œç”šè‡³å¯èƒ½ä¸ä¼šè°ƒç”¨ metamethod.</em></p>
<p>note:<em>ä»…å½“ä¸¤ä¸ªæœ‰å…±åŒçš„ metamethod çš„å¯¹è±¡è¿›è¡Œç›¸ç­‰æ¯”è¾ƒçš„æ—¶å€™ï¼ŒLua æ‰ä¼šè°ƒç”¨å¯¹åº”çš„ metamethodã€‚</em></p>
<h3 id="13-3-others-metamethods"><a href="#13-3-others-metamethods" class="headerlink" title="13.3 others metamethods"></a>13.3 others metamethods</h3><p>note:<em><code>print</code> å‡½æ•°æ€»æ˜¯è°ƒç”¨ tostring æ¥æ ¼å¼åŒ–å®ƒçš„è¾“å‡º, tostring ä¼šé¦–å…ˆæ£€æŸ¥å¯¹è±¡æ˜¯å¦å­˜åœ¨ä¸€ä¸ªå¸¦æœ‰<code>__tostring</code>åŸŸçš„ metatableã€‚</em></p>
<p>å‡å®šä½ æƒ³ä¿æŠ¤ä½ çš„é›†åˆä½¿å…¶ä½¿ç”¨è€…æ—¢çœ‹ä¸åˆ°ä¹Ÿä¸èƒ½ä¿®æ”¹ metatablesã€‚<br>å¦‚æœä½ å¯¹ metatable è®¾ç½®äº†__metatable çš„å€¼ï¼Œ getmetatable å°†è¿”å›è¿™ä¸ªåŸŸçš„å€¼ï¼Œè€Œè°ƒç”¨ setmetatableå°†ä¼šå‡ºé”™ï¼š</p>
<blockquote>
<p>Set.mt.__metatable &#x3D; â€œnot your businessâ€</p>
</blockquote>
<h3 id="13-4-table-relative-metamethods-è¡¨ç›¸å…³-metamethods"><a href="#13-4-table-relative-metamethods-è¡¨ç›¸å…³-metamethods" class="headerlink" title="13.4 table relative metamethods è¡¨ç›¸å…³ metamethods"></a>13.4 table relative metamethods è¡¨ç›¸å…³ metamethods</h3><h4 id="13-4-1-The-index-Metamethod"><a href="#13-4-1-The-index-Metamethod" class="headerlink" title="13.4.1 The __index Metamethod"></a>13.4.1 The __index Metamethod</h4><p>note:<em>å½“æˆ‘ä»¬è®¿é—®ä¸€ä¸ªè¡¨çš„ä¸å­˜åœ¨çš„åŸŸï¼Œè¿™ç§è®¿é—®è§¦å‘ lua è§£é‡Šå™¨å»æŸ¥æ‰¾__index metamethod</em><br>note:<em>__index metamethod ä¸éœ€è¦éæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œä»–ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨ã€‚</em></p>
<ul>
<li>å®ƒæ˜¯ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ï¼ŒLua å°† table å’Œç¼ºå°‘çš„åŸŸä½œä¸ºå‚æ•°è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼›</li>
<li>ä»–æ˜¯ä¸€ä¸ªè¡¨çš„æ—¶å€™ï¼ŒLua å°†åœ¨è¿™ä¸ªè¡¨ä¸­çœ‹æ˜¯å¦æœ‰ç¼ºå°‘çš„åŸŸã€‚</li>
</ul>
<h4 id="13-4-2-The-newindex-Metamethod"><a href="#13-4-2-The-newindex-Metamethod" class="headerlink" title="13.4.2 The __newindex Metamethod"></a>13.4.2 The __newindex Metamethod</h4><p>note:<em>å½“ä½ ç»™è¡¨çš„ä¸€ä¸ªç¼ºå°‘çš„åŸŸèµ‹å€¼ï¼Œè§£é‡Šå™¨å°±ä¼šæŸ¥æ‰¾__newindex metamethod,å¦‚æœå­˜åœ¨åˆ™è°ƒç”¨è¿™ä¸ªå‡½æ•°è€Œä¸è¿›è¡Œèµ‹å€¼æ“ä½œã€‚</em></p>
<p>è°ƒç”¨rawset(t,k,v)ä¸æ‰ç”¨ä»»ä½• metamethod å¯¹è¡¨ t çš„ k åŸŸèµ‹å€¼ä¸º vã€‚</p>
<h4 id="13-4-3-table-default-value-æœ‰é»˜è®¤å€¼çš„è¡¨"><a href="#13-4-3-table-default-value-æœ‰é»˜è®¤å€¼çš„è¡¨" class="headerlink" title="13.4.3 table default value æœ‰é»˜è®¤å€¼çš„è¡¨"></a>13.4.3 table default value æœ‰é»˜è®¤å€¼çš„è¡¨</h4><h4 id="13-4-4-table-monitor-ç›‘æ§è¡¨"><a href="#13-4-4-table-monitor-ç›‘æ§è¡¨" class="headerlink" title="13.4.4 table monitor ç›‘æ§è¡¨"></a>13.4.4 table monitor ç›‘æ§è¡¨</h4><p>å•è¡¨ç›‘æ§</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125; <span class="comment">-- original table (created somewhere)</span></span><br><span class="line"><span class="comment">-- keep a private access to original table</span></span><br><span class="line"><span class="keyword">local</span> _t = t</span><br><span class="line"><span class="comment">-- create proxy</span></span><br><span class="line">t = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line"><span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*access to element &quot;</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">    <span class="keyword">return</span> _t[k] <span class="comment">-- access the original table</span></span><br><span class="line"><span class="keyword">end</span>,</span><br><span class="line"><span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*update of element &quot;</span> .. <span class="built_in">tostring</span>(k) ..</span><br><span class="line">    <span class="string">&quot; to &quot;</span> .. <span class="built_in">tostring</span>(v))</span><br><span class="line">    _t[k] = v <span class="comment">-- update original table</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br></pre></td></tr></table></figure>

<p>note:<em>æ³¨æ„ï¼šä¸å¹¸çš„æ˜¯ï¼Œè¿™ä¸ªè®¾è®¡ä¸å…è®¸æˆ‘ä»¬éå†è¡¨ã€‚</em></p>
<p>å¤šè¡¨ç›‘æ§</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- create private index</span></span><br><span class="line"><span class="keyword">local</span> index = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*access to element &quot;</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">        <span class="keyword">return</span> t[index][k] <span class="comment">-- access the original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*update of element &quot;</span> .. <span class="built_in">tostring</span>(k) .. <span class="string">&quot; to &quot;</span>.. <span class="built_in">tostring</span>(v))</span><br><span class="line">        t[index][k] = v <span class="comment">-- update original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    proxy[index] = t</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="13-4-5-readonly-table-åªè¯»è¡¨"><a href="#13-4-5-readonly-table-åªè¯»è¡¨" class="headerlink" title="13.4.5 readonly table åªè¯»è¡¨"></a>13.4.5 readonly table åªè¯»è¡¨</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123; <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&quot;attempt to update a read-only table&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>,<span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-environment-ç¯å¢ƒ"><a href="#14-environment-ç¯å¢ƒ" class="headerlink" title="14. environment ç¯å¢ƒ"></a>14. environment ç¯å¢ƒ</h2><h3 id="14-1-dynamic-access-global-value-ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡"><a href="#14-1-dynamic-access-global-value-ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡" class="headerlink" title="14.1 dynamic access global value ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡"></a>14.1 dynamic access global value ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getfield</span> <span class="params">(f)</span></span></span><br><span class="line">    <span class="keyword">local</span> v = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">&quot;[%w_]+&quot;</span>) <span class="keyword">do</span></span><br><span class="line">        v = v[w]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setfield</span> <span class="params">(f, v)</span></span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w, d <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">&quot;([%w_]+)(.?)&quot;</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> d == <span class="string">&quot;.&quot;</span> <span class="keyword">then</span> <span class="comment">-- not last field?</span></span><br><span class="line">            t[w] = t[w] <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create table if absent</span></span><br><span class="line">            t = t[w] <span class="comment">-- get the table</span></span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- last field</span></span><br><span class="line">            t[w] = v <span class="comment">-- do the assignment</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="14-2-delcare-global-value-å£°æ˜å…¨å±€å˜é‡"><a href="#14-2-delcare-global-value-å£°æ˜å…¨å±€å˜é‡" class="headerlink" title="14.2 delcare global value å£°æ˜å…¨å±€å˜é‡"></a>14.2 delcare global value å£°æ˜å…¨å±€å˜é‡</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> declaredNames = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">declare</span> <span class="params">(name, initval)</span></span></span><br><span class="line">    <span class="built_in">rawset</span>(<span class="built_in">_G</span>, name, initval)</span><br><span class="line">    declaredNames[name] = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">_G</span>, &#123;</span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;attempt to write to undeclared var. &quot;</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">rawset</span>(t, n, v) <span class="comment">-- do the actual set</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_, n)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;attempt to read undeclared var. &quot;</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="14-3-un-global-environment-éå…¨å±€çš„ç¯å¢ƒ"><a href="#14-3-un-global-environment-éå…¨å±€çš„ç¯å¢ƒ" class="headerlink" title="14.3 un-global environment éå…¨å±€çš„ç¯å¢ƒ"></a>14.3 un-global environment éå…¨å±€çš„ç¯å¢ƒ</h3><p>note:<em>å½“ä½ å®‰è£…ä¸€ä¸ª metatable å»æ§åˆ¶å…¨å±€è®¿é—®æ—¶ï¼Œä½ çš„æ•´ä¸ªç¨‹åºéƒ½å¿…é¡»éµå¾ªåŒä¸€ä¸ªæŒ‡å¯¼æ–¹é’ˆã€‚å¦‚æœä½ æƒ³ä½¿ç”¨æ ‡å‡†åº“ï¼Œæ ‡å‡†åº“ä¸­å¯èƒ½ä½¿ç”¨åˆ°æ²¡æœ‰å£°æ˜çš„å…¨å±€å˜é‡ï¼Œä½ å°†ç¢°åˆ°åè¿ã€‚</em></p>
<p>Setfenv:<em>æ¥å—å‡½æ•°å’Œæ–°çš„ç¯å¢ƒä½œä¸ºå‚æ•°ã€‚é™¤äº†ä½¿ç”¨å‡½æ•°æœ¬èº«ï¼Œè¿˜å¯ä»¥æŒ‡å®šä¸€ä¸ªæ•°å­—è¡¨ç¤ºæ ˆé¡¶çš„æ´»åŠ¨å‡½æ•°ã€‚æ•°å­— 1 ä»£è¡¨å½“å‰å‡½æ•°ï¼Œæ•°å­— 2 ä»£è¡¨è°ƒç”¨å½“å‰å‡½æ•°çš„å‡½æ•°</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment to a new empty table</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;&#125;)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>

<p>å¿…é¡»åœ¨å•ç‹¬çš„ chunk å†…è¿è¡Œè¿™æ®µä»£ç ï¼Œå¦‚æœä½ åœ¨äº¤äº’æ¨¡å¼é€è¡Œè¿è¡Œä»–ï¼Œæ¯ä¸€è¡Œéƒ½æ˜¯ä¸€ä¸ªä¸åŒçš„å‡½æ•°ï¼Œè°ƒç”¨ setfenv åªä¼šå½±å“ä»–è‡ªå·±çš„é‚£ä¸€è¡Œ</p>
<p>å°è£…: populate</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>

<p>ç»§æ‰¿å°è£…</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>

<p>note:<em>å½“ä½ åˆ›å»ºä¸€ä¸ªæ–°çš„å‡½æ•°æ—¶ï¼Œä»–ä»åˆ›å»ºä»–çš„å‡½æ•°ç»§æ‰¿äº†ç¯å¢ƒå˜é‡</em><br>note:<em>å¦‚æœä¸€ä¸ªchunk æ”¹å˜äº†ä»–è‡ªå·±çš„ç¯å¢ƒï¼Œè¿™ä¸ª chunk æ‰€æœ‰åœ¨æ”¹å˜ä¹‹åå®šä¹‰çš„å‡½æ•°éƒ½å…±äº«ç›¸åŒçš„ç¯å¢ƒï¼Œéƒ½ä¼šå—åˆ°å½±å“ã€‚è¿™å¯¹åˆ›å»º<strong>å‘½åç©ºé—´</strong>æ˜¯éå¸¸æœ‰ç”¨çš„æœºåˆ¶</em></p>
<h2 id="15-package"><a href="#15-package" class="headerlink" title="15 package"></a>15 package</h2><p>note:<em>å¤§å¤šæ•°è¯­è¨€ä¸­ï¼Œpackages ä¸æ˜¯<strong>ç¬¬ä¸€ç±»å€¼(first-class values)</strong>ï¼ˆä¹Ÿå°±æ˜¯è¯´ï¼Œä»–ä»¬ä¸èƒ½å­˜å‚¨åœ¨å˜é‡é‡Œï¼Œä¸èƒ½ä½œä¸ºå‡½æ•°å‚æ•°ã€‚ã€‚ã€‚ ï¼‰</em></p>
<ul>
<li>å¯¹æ¯ä¸€ä¸ªå‡½æ•°å®šä¹‰éƒ½å¿…é¡»æ˜¾ç¤ºçš„åœ¨å‰é¢åŠ ä¸ŠåŒ…çš„åç§°ã€‚</li>
<li>åŒä¸€åŒ…å†…çš„å‡½æ•°<code>ç›¸äº’è°ƒç”¨</code>å¿…é¡»åœ¨è¢«è°ƒç”¨å‡½æ•°å‰<strong>æŒ‡å®šåŒ…å</strong>ã€‚</li>
</ul>
<p>ç¼ºç‚¹:</p>
<ul>
<li><em>ä¿®æ”¹å‡½æ•°çš„çŠ¶æ€(å…¬æœ‰å˜æˆç§æœ‰æˆ–è€…ç§æœ‰å˜æˆå…¬æœ‰)æˆ‘ä»¬å¿…é¡»ä¿®æ”¹å‡½æ•°å¾—*<em>è°ƒç”¨æ–¹å¼</em></em>ã€‚*</li>
<li><em>è®¿é—®åŒä¸€ä¸ªpackage å†…çš„å…¶ä»–å…¬æœ‰çš„å®ä½“å†™æ³•å†—ä½™ï¼Œå¿…é¡»åŠ ä¸Šå‰ç¼€ P.ã€‚</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">checkComplex</span> <span class="params">(c)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ((<span class="built_in">type</span>(c) == <span class="string">&quot;table&quot;</span>) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.r) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.i)) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;bad complex number&quot;</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span> <span class="params">(r, i)</span></span> <span class="keyword">return</span> &#123;r=r, i=i&#125; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(c1, c2)</span></span></span><br><span class="line">    checkComplex(c1);</span><br><span class="line">    checkComplex(c2);</span><br><span class="line">    <span class="keyword">return</span> new(c1.r + c2.r, c1.i + c2.i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">-- åˆ—è¡¨æ”¾åœ¨åé¢ å› ä¸ºå¿…é¡»é¦–å…ˆå®šä¹‰å±€éƒ¨å‡½æ•°</span></span><br><span class="line">complex = &#123;</span><br><span class="line">    new = new,</span><br><span class="line">    add = add,</span><br><span class="line">    <span class="built_in">sub</span> = <span class="built_in">sub</span>,</span><br><span class="line">    mul = mul,</span><br><span class="line">    div = div,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-3-package-file"><a href="#15-3-package-file" class="headerlink" title="15.3 package &amp; file"></a>15.3 package &amp; file</h3><pre><code>note:*å½“ require åŠ è½½ä¸€ä¸ªæ–‡ä»¶çš„æ—¶å€™ï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå˜é‡æ¥è¡¨ç¤ºè™šæ‹Ÿçš„æ–‡ä»¶å*

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ä¸éœ€è¦ require å°±å¯ä»¥ä½¿ç”¨ package</span></span><br><span class="line"><span class="keyword">local</span> P = &#123;&#125; <span class="comment">-- package</span></span><br><span class="line"><span class="keyword">if</span> _REQUIREDNAME == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    complex = P</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">_G</span>[_REQUIREDNAME] = P</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

note:*æˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæ–‡ä»¶ä¹‹å†…å®šä¹‰å¤šä¸ª packagesï¼Œæˆ‘ä»¬éœ€è¦åšçš„åªæ˜¯å°†æ¯ä¸€ä¸ª package æ”¾åœ¨ä¸€ä¸ª **do ä»£ç å—***å†…ï¼Œè¿™æ · local å˜é‡æ‰èƒ½è¢«é™åˆ¶åœ¨é‚£ä¸ªä»£ç å—ä¸­*

è‡ªåŠ¨åŠ è½½

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> location = &#123;</span><br><span class="line">foo = <span class="string">&quot;/usr/local/lua/lib/pack1_1.lua&quot;</span>,</span><br><span class="line">goo = <span class="string">&quot;/usr/local/lua/lib/pack1_1.lua&quot;</span>,</span><br><span class="line">foo1 = <span class="string">&quot;/usr/local/lua/lib/pack1_2.lua&quot;</span>,</span><br><span class="line">goo1 = <span class="string">&quot;/usr/local/lua/lib/pack1_3.lua&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pack1 = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(pack1, &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, funcname)</span></span></span><br><span class="line">    <span class="keyword">local</span> file = location[funcname]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;package pack1 does not define &quot;</span> .. funcname)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">loadfile</span>(file))()    <span class="comment">-- load and run definition</span></span><br><span class="line">    <span class="keyword">return</span> t[funcname]          <span class="comment">-- return the function</span></span><br><span class="line"><span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pack1</span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="16-object-oriented-programming-é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡"><a href="#16-object-oriented-programming-é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡" class="headerlink" title="16 object-oriented programming é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡"></a>16 object-oriented programming é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡</h2><ul>
<li>ç¤ºä¾‹ä»£ç  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Account = &#123;</span><br><span class="line">    balance=<span class="number">0</span>,</span><br><span class="line">    withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(self, v)</span></span></span><br><span class="line">        <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:deposit</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance + v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Account.deposit(Account, <span class="number">200.00</span>)</span><br><span class="line">Account:withdraw(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span> <span class="params">(o)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create object if user does not provide one</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(o, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = Account:new&#123;balance = <span class="number">0</span>&#125;</span><br><span class="line">a:deposit(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">getmetatable</span>(a).<span class="built_in">__index</span>.deposit(a, <span class="number">100.00</span>)</span><br><span class="line">Account.deposit(a, <span class="number">100.00</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="16-3-multiple-inheritance-å¤šé‡ç»§æ‰¿"><a href="#16-3-multiple-inheritance-å¤šé‡ç»§æ‰¿" class="headerlink" title="16.3 multiple inheritance å¤šé‡ç»§æ‰¿"></a>16.3 multiple inheritance å¤šé‡ç»§æ‰¿</h3><pre><code> å¤šé‡ç»§æ‰¿æ„å‘³ç€ä¸€ä¸ªç±»æ‹¥æœ‰å¤šä¸ªçˆ¶ç±»
</code></pre>
<h3 id="16-4-private-ç§æœ‰æ€§"><a href="#16-4-private-ç§æœ‰æ€§" class="headerlink" title="16.4 private ç§æœ‰æ€§"></a>16.4 private ç§æœ‰æ€§</h3><pre><code> é€šè¿‡é—­åŒ…å®ç°ç§æœ‰æ€§

 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newAccount</span> <span class="params">(initialBalance)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">self</span> = &#123;</span><br><span class="line">        balance = initialBalance,</span><br><span class="line">        LIM = <span class="number">10000.00</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> deposit = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance + v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> extra = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.balance &gt; <span class="built_in">self</span>.LIM <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.balance*<span class="number">0.10</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> getBalance = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>.balance + <span class="built_in">self</span>.extra()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--local getBalance = function () return self.balance end</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        withdraw = withdraw,</span><br><span class="line">        deposit = deposit,</span><br><span class="line">        getBalance = getBalance</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">acc1 = newAccount(<span class="number">100.00</span>)</span><br><span class="line">acc1.withdraw(<span class="number">40.00</span>)</span><br><span class="line"><span class="built_in">print</span>(acc1.getBalance())    <span class="comment">--&gt; 60</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="16-5-Single-Method-çš„å¯¹è±¡å®ç°æ–¹æ³•"><a href="#16-5-Single-Method-çš„å¯¹è±¡å®ç°æ–¹æ³•" class="headerlink" title="16.5 Single-Method çš„å¯¹è±¡å®ç°æ–¹æ³•"></a>16.5 Single-Method çš„å¯¹è±¡å®ç°æ–¹æ³•</h3><pre><code> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newObject</span> <span class="params">(value)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(action, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">&quot;get&quot;</span> <span class="keyword">then</span> <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">elseif</span> action == <span class="string">&quot;set&quot;</span> <span class="keyword">then</span> value = v</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">error</span>(<span class="string">&quot;invalid action&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">d = newObject(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">&quot;get&quot;</span>)) <span class="comment">--&gt; 0</span></span><br><span class="line">d(<span class="string">&quot;set&quot;</span>, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">&quot;get&quot;</span>)) <span class="comment">--&gt; 10</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h2 id="17-weak-table"><a href="#17-weak-table" class="headerlink" title="17 weak table"></a>17 weak table</h2><p>ä¸€ä¸ª weak å¼•ç”¨æ˜¯æŒ‡<em>ä¸€ä¸ªä¸è¢« Lua è®¤ä¸ºæ˜¯åƒåœ¾çš„å¯¹è±¡çš„å¼•ç”¨ã€‚</em><br>å¦‚æœä¸€ä¸ªå¯¹è±¡æ‰€æœ‰çš„å¼•ç”¨æŒ‡å‘éƒ½æ˜¯weakï¼Œå¯¹è±¡å°†è¢«æ”¶é›†ï¼Œè€Œé‚£äº› weak å¼•ç”¨å°†ä¼šè¢«åˆ é™¤ã€‚<br>å¦‚æœä¸€ä¸ªå¯¹è±¡åªå­˜åœ¨äº weak tables ä¸­ï¼ŒLua å°†ä¼šæœ€ç»ˆå°†å®ƒæ”¶é›†ã€‚</p>
<p>ä¸‰ç§ç±»å‹çš„ weak tablesï¼š</p>
<ul>
<li><p>weak keys ç»„æˆçš„ tablesï¼›</p>
</li>
<li><p>weak values ç»„æˆçš„ tablesï¼›</p>
</li>
<li><p>ä»¥åŠçº¯ weak tables ç±»å‹ï¼Œä»–ä»¬çš„ keys å’Œ values éƒ½æ˜¯ weak çš„ã€‚</p>
<p>  è¡¨çš„ weak æ€§ç”±ä»–çš„ metatable çš„__mode åŸŸæ¥æŒ‡å®šçš„ã€‚</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">b = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(a, b)</span><br><span class="line">b.<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span> <span class="comment">-- now &#x27;a&#x27; has weak keys</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates first key</span></span><br><span class="line">a[&#123;key&#125;] = <span class="number">1</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates second key</span></span><br><span class="line">a[key] = <span class="number">2</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">-- forces a garbage collection cycle</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>  ç¬¬äºŒä¸ªèµ‹å€¼è¯­å¥ key&#x3D;{}è¦†ç›–äº†ç¬¬ä¸€ä¸ª key çš„å€¼ã€‚å½“åƒåœ¾æ”¶é›†å™¨å·¥ä½œæ—¶ï¼Œåœ¨å…¶ä»–åœ°æ–¹æ²¡æœ‰æŒ‡å‘ç¬¬ä¸€ä¸ª key çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒè¢«æ”¶é›†äº†</p>
<p>  note:<em>åªæœ‰å¯¹è±¡æ‰å¯ä»¥ä»ä¸€ä¸ª weak table ä¸­è¢«æ”¶é›†ã€‚æ¯”å¦‚æ•°å­—å’Œå¸ƒå°”å€¼ç±»å‹çš„å€¼ï¼Œéƒ½æ˜¯ä¸ä¼šè¢«æ”¶é›†çš„ã€‚</em></p>
<p>  example:*å¦‚æœæˆ‘ä»¬åœ¨ table ä¸­æ’å…¥äº†ä¸€ä¸ªæ•°å€¼å‹çš„ keyï¼ˆåœ¨å‰é¢é‚£ä¸ªä¾‹å­ä¸­ï¼‰ï¼Œå®ƒå°†æ°¸è¿œä¸ä¼šè¢«æ”¶é›†å™¨ä» table ä¸­ç§»é™¤ã€‚å½“ç„¶ï¼Œå¦‚æœå¯¹åº”äºè¿™ä¸ªæ•°å€¼å‹ key çš„ <strong>vaule</strong>è¢«æ”¶é›†ï¼Œé‚£ä¹ˆå®ƒçš„æ•´ä¸ªå…¥å£å°†ä¼šä» weak table ä¸­è¢«ç§»é™¤ã€‚*</p>
<p>  note:<em>ä¸€ä¸ªå­—ç¬¦ä¸²ä¸ä¼šä» weak tables ä¸­è¢«ç§»é™¤ï¼ˆé™¤éå®ƒæ‰€å…³è”çš„ vaule è¢«æ”¶é›†ï¼‰</em></p>
<h3 id="17-1-è®°å¿†å‡½æ•°"><a href="#17-1-è®°å¿†å‡½æ•°" class="headerlink" title="17.1 è®°å¿†å‡½æ•°"></a>17.1 è®°å¿†å‡½æ•°</h3><p>  å¦‚æœè¿™ä¸ªç»“æœè¡¨ä¸­æœ‰ weak å€¼ï¼Œæ¯æ¬¡çš„åƒåœ¾æ”¶é›†å¾ªç¯éƒ½ä¼šç§»é™¤å½“å‰æ—¶é—´å†…æ‰€æœ‰æœªè¢«ä½¿ç”¨çš„ç»“æœ</p>
<pre><code>  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> results = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(results, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;) <span class="comment">-- make values weak</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRGB</span> <span class="params">(r, g, b)</span></span></span><br><span class="line">    <span class="keyword">local</span> key = r .. <span class="string">&quot;-&quot;</span> .. g .. <span class="string">&quot;-&quot;</span> .. b</span><br><span class="line">    <span class="keyword">if</span> results[key] <span class="keyword">then</span> <span class="keyword">return</span> results[key]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> newcolor = &#123;red = r, green = g, blue = b&#125;</span><br><span class="line">        results[key] = newcolor</span><br><span class="line">        <span class="keyword">return</span> newcolor</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<blockquote>
<p>æ ‡å‡†åº“</p>
</blockquote>
<h2 id="18-æ•°å­¦åº“"><a href="#18-æ•°å­¦åº“" class="headerlink" title="18. æ•°å­¦åº“"></a>18. æ•°å­¦åº“</h2><p>ä¸‰è§’å‡½æ•°åº“ï¼ˆsin, cos, tan, asin, acos, etc.ï¼‰<br>å¹‚æŒ‡å‡½æ•°ï¼ˆexp, log, log10ï¼‰ï¼Œ<br>èˆå…¥å‡½æ•°ï¼ˆfloor, ceilï¼‰ã€<br>maxã€minï¼ŒåŠ ä¸Šä¸€ä¸ªå˜é‡ piã€‚</p>
<p>æ‰€æœ‰çš„ä¸‰è§’å‡½æ•°éƒ½åœ¨å¼§åº¦å•ä½ä¸‹å·¥ä½œã€‚<strong>ï¼ˆLua4.0 ä»¥å‰åœ¨åº¦æ•°ä¸‹å·¥ä½œã€‚ï¼‰</strong><br>ä½ å¯ä»¥ä½¿ç”¨ <code>deg</code>å’Œ <code>rad</code> å‡½æ•°åœ¨åº¦å’Œå¼§åº¦ä¹‹é—´è½¬æ¢ã€‚</p>
<p>math.random ç”¨æ¥äº§ç”Ÿä¼ªéšæœºæ•°ï¼Œæœ‰ä¸‰ç§è°ƒç”¨æ–¹å¼ï¼š</p>
<ul>
<li>ç¬¬ä¸€ï¼šä¸å¸¦å‚æ•°ï¼Œå°†äº§ç”Ÿ [0,1)èŒƒå›´å†…çš„éšæœºæ•°.</li>
<li>ç¬¬äºŒï¼šå¸¦ä¸€ä¸ªå‚æ•° nï¼Œå°†äº§ç”Ÿ 1 &lt;&#x3D; x &lt;&#x3D; n èŒƒå›´å†…çš„éšæœºæ•° x.</li>
<li>ç¬¬ä¸‰ï¼šå¸¦ä¸¤ä¸ªå‚æ•° a å’Œ b,å°†äº§ç”Ÿ a &lt;&#x3D; x &lt;&#x3D; b èŒƒå›´å†…çš„éšæœºæ•° x.</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())</span><br></pre></td></tr></table></figure>

<h2 id="19-table-lib"><a href="#19-table-lib" class="headerlink" title="19. table lib"></a>19. table lib</h2><p>table.getn table.setn å·²ç»å¼ƒç”¨</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="literal">nil</span>, <span class="number">1</span>, <span class="number">2</span>, key = <span class="string">&#x27;1234321&#x27;</span>, <span class="literal">nil</span>, <span class="number">15</span>, <span class="string">&#x27;sagewqgag&#x27;</span>, <span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ddd&#x27;</span>,k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;len:&#x27;</span>,#a)</span><br></pre></td></tr></table></figure>

<p>ipairs iterate number index until first <code>nil</code><br>pairs iterate all except <code>nil</code><br>when <code>&#123;nil, 1, 2, key = &#39;1234321&#39;, nil, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 6<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, nil, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 2<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 4<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, 15, &#39;sagewqgag&#39;&#125;</code>, #a &#x3D; 4</p>
<p>table.insert å‡½æ•°åœ¨ arrayæŒ‡å®šä½ç½®æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶<strong>å°†åé¢æ‰€æœ‰å…¶ä»–çš„å…ƒç´ åç§»ã€‚</strong></p>
<p>ä¸å¸¦ä½ç½®å‚æ•°è°ƒç”¨ insertï¼Œå°†ä¼šåœ¨ array<strong>æœ€åä½ç½®</strong>æ’å…¥å…ƒç´ ï¼ˆæ‰€ä»¥ä¸éœ€è¦å…ƒç´ ç§»åŠ¨ï¼‰</p>
<p>note:<em>æ’åºå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°å¹¶ä¸”å¦‚æœåœ¨ array ä¸­æ’åºåç¬¬ä¸€ä¸ªå‚æ•°åœ¨ç¬¬äºŒä¸ªå‚æ•°å‰é¢ï¼Œæ’åºå‡½æ•°å¿…é¡»è¿”å› trueã€‚å¦‚æœæœªæä¾›æ’åºå‡½æ•°ï¼Œsort ä½¿ç”¨é»˜è®¤çš„å°äºæ“ä½œç¬¦è¿›è¡Œæ¯”è¾ƒ</em></p>
<h2 id="20-string-lib"><a href="#20-string-lib" class="headerlink" title="20 string lib"></a>20 string lib</h2><p><code>string.len(s)</code>è¿”å›å­—ç¬¦ä¸² s çš„é•¿åº¦ï¼›<br><code>string.rep(s,n)</code>è¿”å›é‡å¤ n æ¬¡å­—ç¬¦ä¸² s çš„ä¸²ï¼›<br>ä½ ä½¿ç”¨ <code>string.rep(&quot;a&quot;, 2^20)</code>å¯ä»¥åˆ›å»ºä¸€ä¸ª 1M bytes çš„å­—ç¬¦ä¸²ï¼ˆæ¯”å¦‚ï¼Œä¸ºäº†æµ‹è¯•éœ€è¦ï¼‰ ï¼›<br><code>string.lower(s)</code>å°† s ä¸­çš„å¤§å†™å­—æ¯è½¬æ¢æˆå°å†™ï¼ˆ<code>string.upper</code>å°†å°å†™è½¬æ¢æˆå¤§å†™ï¼‰<br><code>string.sub(s,i,j)</code>å‡½æ•°æˆªå–å­—ç¬¦ä¸² s çš„ä»ç¬¬ i ä¸ªå­—ç¬¦åˆ°ç¬¬ j ä¸ªå­—ç¬¦ä¹‹é—´çš„ä¸²ã€‚</p>
<p>Luaä¸­ï¼Œ<em>å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ç´¢å¼•ä» 1 å¼€å§‹ã€‚ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨è´Ÿç´¢å¼•ï¼Œè´Ÿç´¢å¼•ä»å­—ç¬¦ä¸²çš„ç»“å°¾å‘å‰è®¡æ•°ï¼š-1 æŒ‡å‘æœ€åä¸€ä¸ªå­—ç¬¦ï¼Œ-2 æŒ‡å‘å€’æ•°ç¬¬äºŒä¸ªï¼Œä»¥æ­¤ç±»æ¨ã€‚</em><br>note:<em>Lua ä¸­çš„å­—ç¬¦ä¸²æ˜¯æ’å®šä¸å˜çš„ã€‚String.sub å‡½æ•°ä»¥åŠ Lua ä¸­å…¶ä»–çš„å­—ç¬¦ä¸²æ“ä½œå‡½æ•°éƒ½ä¸ä¼šæ”¹å˜å­—ç¬¦ä¸²çš„å€¼ï¼Œè€Œæ˜¯è¿”å›ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ã€‚</em><br>å¦‚æœä½ æƒ³ä¿®æ”¹ä¸€ä¸ªå­—ç¬¦ä¸²å˜é‡çš„å€¼ï¼Œä½ å¿…é¡»å°†å˜é‡èµ‹ç»™ä¸€ä¸ªæ–°çš„å­—ç¬¦ä¸²ï¼š</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="number">2</span>, <span class="number">-2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">97</span>)) <span class="comment">--&gt; a</span></span><br><span class="line">i = <span class="number">99</span>; <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(i, i+<span class="number">1</span>, i+<span class="number">2</span>)) <span class="comment">--&gt; cde</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>)) <span class="comment">--&gt; 97</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>, <span class="number">2</span>)) <span class="comment">--&gt; 98</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>, <span class="number">-1</span>)) <span class="comment">--&gt; 99</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;pi = %.4f&quot;</span>, PI)) <span class="comment">--&gt; pi = 3.1416</span></span><br><span class="line">d = <span class="number">5</span>; m = <span class="number">11</span>; y = <span class="number">1990</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%02d/%02d/%04d&quot;</span>, d, m, y)) <span class="comment">--&gt; 05/11/1990</span></span><br><span class="line">tag, title = <span class="string">&quot;h1&quot;</span>, <span class="string">&quot;a title&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;&lt;%s&gt;%s&lt;/%s&gt;&quot;</span>, tag, title, tag)) <span class="comment">--&gt; &lt;h1&gt;a title&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="20-1-pattern-matching-æ¨¡å¼åŒ¹é…"><a href="#20-1-pattern-matching-æ¨¡å¼åŒ¹é…" class="headerlink" title="20.1 pattern matching æ¨¡å¼åŒ¹é…"></a>20.1 pattern matching æ¨¡å¼åŒ¹é…</h3><p>Luaå¹¶ä¸ä½¿ç”¨POSIXè§„èŒƒçš„æ­£åˆ™è¡¨è¾¾å¼ï¼ˆä¹Ÿå†™ä½œ<strong>regexp</strong>ï¼‰æ¥è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 1 5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, i, j)) <span class="comment">--&gt; hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;world&quot;</span>)) <span class="comment">--&gt; 7 11</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;l&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 3 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;lll&quot;</span>)) <span class="comment">--&gt; nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125; <span class="comment">-- table to store the indices</span></span><br><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    i = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;\n&quot;</span>, i+<span class="number">1</span>) <span class="comment">-- find &#x27;next&#x27; newline</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(t, i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;Lua is cute&quot;</span>, <span class="string">&quot;cute&quot;</span>, <span class="string">&quot;great&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx xii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;Lua is great&quot;</span>, <span class="string">&quot;perl&quot;</span>, <span class="string">&quot;tcl&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axl lii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx lii</span></span><br><span class="line">_, count = <span class="built_in">string</span>.<span class="built_in">gsub</span>(str, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>note:<em>_ åªæ˜¯ä¸€ä¸ªå“‘å…ƒå˜é‡</em></p>
<h3 id="20-2-pattern-æ¨¡å¼"><a href="#20-2-pattern-æ¨¡å¼" class="headerlink" title="20.2 pattern æ¨¡å¼"></a>20.2 pattern æ¨¡å¼</h3><pre><code>+ åŒ¹é…å‰ä¸€å­—ç¬¦ 1 æ¬¡æˆ–å¤šæ¬¡
* åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡
- åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ–å¤šæ¬¡
? åŒ¹é…å‰ä¸€å­—ç¬¦ 0 æ¬¡æˆ– 1 æ¬¡
&#39;[_%a][_%w]*&#39; åŒ¹é… Lua ç¨‹åºä¸­çš„æ ‡ç¤ºç¬¦ï¼šå­—æ¯æˆ–è€…ä¸‹åˆ’çº¿å¼€å¤´çš„å­—æ¯ä¸‹åˆ’çº¿æ•°å­—åºåˆ—ã€‚
åŒ¹é…ä¸€å¯¹åœ†æ‹¬å·()æˆ–è€…æ‹¬å·ä¹‹é—´çš„ç©ºç™½ï¼Œå¯ä»¥ä½¿ç”¨ &#39;%(%s*%)&#39;
</code></pre>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;Deadline is 30/05/1999, firm&quot;</span></span><br><span class="line"><span class="built_in">date</span> = <span class="string">&quot;%d%d/%d%d/%d%d%d%d&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="built_in">date</span>))) <span class="comment">--&gt; 30/05/1999</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;hello, up-down!&quot;</span>, <span class="string">&quot;%A&quot;</span>, <span class="string">&quot;.&quot;</span>)) <span class="comment">--&gt; hello..up.down. 4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;one, and two; and three&quot;</span>, <span class="string">&quot;%a+&quot;</span>, <span class="string">&quot;word&quot;</span>)) <span class="comment">--&gt; word, word word; word word</span></span><br><span class="line"></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">&quot;the number 1298 is even&quot;</span>, <span class="string">&quot;%d+&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i,j) <span class="comment">--&gt; 12 15</span></span><br></pre></td></tr></table></figure>

<h3 id="20-3-matchings-æ•è·"><a href="#20-3-matchings-æ•è·" class="headerlink" title="20.3 matchings æ•è·"></a>20.3 matchings æ•è·</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pair = <span class="string">&quot;name = Anna&quot;</span></span><br><span class="line">_, _, key, value = <span class="built_in">string</span>.<span class="built_in">find</span>(pair, <span class="string">&quot;(%a+)%s*=%s*(%a+)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(key, value) <span class="comment">--&gt; name Anna</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">date</span> = <span class="string">&quot;17/7/1990&quot;</span></span><br><span class="line">_, _, d, m, y = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="built_in">date</span>, <span class="string">&quot;(%d+)/(%d+)/(%d+)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(d, m, y) <span class="comment">--&gt; 17 7 1990</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">[[then he said: &quot;it&#x27;s all right&quot;!]]</span></span><br><span class="line">a, b, c, quotedPart = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;([\&quot;&#x27;])(.-)%1&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(quotedPart) <span class="comment">--&gt; it&#x27;s all right</span></span><br><span class="line"><span class="built_in">print</span>(c) <span class="comment">--&gt; &quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="21-IO-lib"><a href="#21-IO-lib" class="headerlink" title="21. IO lib"></a>21. IO lib</h2><h3 id="21-1-simple-I-O-mode"><a href="#21-1-simple-I-O-mode" class="headerlink" title="21.1 simple I&#x2F;O mode"></a>21.1 simple I&#x2F;O mode</h3><p>io.input å’Œ io.output å‡½æ•°æ¥æ”¹å˜å½“å‰æ–‡ä»¶ã€‚<br>ä¾‹å¦‚io.input(filename)å°±æ˜¯æ‰“å¼€ç»™å®šæ–‡ä»¶ï¼ˆä»¥è¯»æ¨¡å¼ï¼‰ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºå½“å‰è¾“å…¥æ–‡ä»¶ã€‚<br>æ¥ä¸‹æ¥æ‰€æœ‰çš„è¾“å…¥éƒ½æ¥è‡ªäºè¯¥æ–‡ï¼Œç›´åˆ°å†æ¬¡ä½¿ç”¨ io.inputã€‚io.output å‡½æ•°ã€‚<br>ä¸€æ—¦äº§ç”Ÿé”™è¯¯ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šäº§ç”Ÿé”™è¯¯ã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;sin (3) = &quot;</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411200080598672</span></span><br><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;sin (3) = %.4f\n&quot;</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>)))</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ç¼–å†™ä»£ç æ—¶åº”å½“é¿å…åƒ io.write(a..b..c)ï¼›è¿™æ ·çš„ä¹¦å†™ï¼Œè¿™åŒ io.write(a,b,c)çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åè€…å› ä¸ºé¿å…äº†ä¸²è”æ“ä½œï¼Œè€Œæ¶ˆè€—è¾ƒå°‘çš„èµ„æºã€‚</p>
<p>Write å‡½æ•°ä¸ print å‡½æ•°ä¸åŒåœ¨äºï¼Œwrite ä¸é™„åŠ ä»»ä½•é¢å¤–çš„å­—ç¬¦åˆ°è¾“å‡ºä¸­å»ï¼Œä¾‹å¦‚åˆ¶è¡¨ç¬¦ï¼Œæ¢è¡Œç¬¦ç­‰ç­‰ã€‚<br>write å‡½æ•°æ˜¯ä½¿ç”¨å½“å‰è¾“å‡ºæ–‡ä»¶ï¼Œè€Œ print å§‹ç»ˆä½¿ç”¨æ ‡å‡†è¾“å‡ºã€‚<br>printå‡½æ•°ä¼šè‡ªåŠ¨è°ƒç”¨å‚æ•°çš„ tostringæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥æ˜¾ç¤ºå‡ºè¡¨ï¼ˆtablesï¼‰å‡½æ•°ï¼ˆfunctionsï¼‰å’Œ nilã€‚</p>
<p>â€œ*allâ€ è¯»å–æ•´ä¸ªæ–‡ä»¶<br>â€œ*lineâ€ è¯»å–ä¸‹ä¸€è¡Œ<br>â€œ*numberâ€ ä»ä¸²ä¸­è½¬æ¢å‡ºä¸€ä¸ªæ•°å€¼<br>num è¯»å– num ä¸ªå­—ç¬¦åˆ°ä¸²</p>
<p>io.read(â€œ*allâ€)å‡½æ•°ä»å½“å‰ä½ç½®è¯»å–æ•´ä¸ªè¾“å…¥æ–‡ä»¶ã€‚å¦‚æœå½“å‰ä½ç½®åœ¨æ–‡ä»¶æœ«å°¾ï¼Œæˆ–è€…æ–‡ä»¶ä¸ºç©ºï¼Œå‡½æ•°å°†è¿”å›ç©ºä¸²ã€‚<br>io.read(â€œ*lineâ€)å‡½æ•°è¿”å›å½“å‰è¾“å…¥æ–‡ä»¶çš„ä¸‹ä¸€è¡Œï¼ˆä¸åŒ…å«æœ€åçš„æ¢è¡Œç¬¦ï¼‰ã€‚å½“åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œè¿”å›å€¼ä¸º nilï¼ˆè¡¨ç¤ºæ²¡æœ‰ä¸‹ä¸€è¡Œå¯è¿”å›ï¼‰<br><em>è¯¥è¯»å–æ–¹å¼æ˜¯ read å‡½æ•°çš„é»˜è®¤æ–¹å¼ï¼Œæ‰€ä»¥å¯ä»¥ç®€å†™ä¸º io.read()ã€‚</em><br>io.read(â€œ*numberâ€)å‡½æ•°ä»å½“å‰è¾“å…¥æ–‡ä»¶ä¸­è¯»å–å‡ºä¸€ä¸ªæ•°å€¼ã€‚åªæœ‰åœ¨è¯¥å‚æ•°ä¸‹ read å‡½æ•°æ‰è¿”å›æ•°å€¼ï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸²ã€‚<br>å¦‚æœåœ¨å½“å‰ä½ç½®æ‰¾ä¸åˆ°ä¸€ä¸ªæ•°å­—ï¼ˆç”±äºæ ¼å¼ä¸å¯¹ï¼Œæˆ–è€…æ˜¯åˆ°äº†æ–‡ä»¶çš„ç»“å°¾ï¼‰ï¼Œåˆ™è¿”å› nil å¯ä»¥å¯¹æ¯ä¸ªå‚æ•°è®¾ç½®é€‰é¡¹ï¼Œå‡½æ•°å°†è¿”å›å„è‡ªçš„ç»“æœã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">6.0 -3.23 15e12</span></span><br><span class="line"><span class="comment">4.3 234 1000001</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> n1, n2, n3 = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>, <span class="string">&quot;*number&quot;</span>, <span class="string">&quot;*number&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n1 <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">math</span>.<span class="built_in">max</span>(n1, n2, n3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> size = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- good buffer size (8K)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> block = <span class="built_in">io</span>.<span class="built_in">read</span>(size)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> block <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(block)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="21-2-complete-I-O-mode"><a href="#21-2-complete-I-O-mode" class="headerlink" title="21.2 complete I&#x2F;O mode"></a>21.2 complete I&#x2F;O mode</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&quot;r&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> t = f:<span class="built_in">read</span>(<span class="string">&quot;*all&quot;</span>)</span><br><span class="line">f:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> temp = <span class="built_in">io</span>.<span class="built_in">input</span>() <span class="comment">-- save current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(<span class="string">&quot;newinput&quot;</span>) <span class="comment">-- open a new current file</span></span><br><span class="line">... <span class="comment">-- do something with new input</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>():<span class="built_in">close</span>() <span class="comment">-- close current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(temp) <span class="comment">-- restore previous current file</span></span><br></pre></td></tr></table></figure>

<p>I&#x2F;O ä¼˜åŒ–çš„ä¸€ä¸ªå°æŠ€å·§:<br>é€šå¸¸ Lua ä¸­è¯»å–æ•´ä¸ªæ–‡ä»¶è¦æ¯”ä¸€è¡Œä¸€è¡Œçš„è¯»å–ä¸€ä¸ªæ–‡ä»¶å¿«çš„å¤šã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">&quot;*line&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> BUFSIZE = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- 8K</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">io</span>.<span class="built_in">input</span>(<span class="built_in">arg</span>[<span class="number">1</span>]) <span class="comment">-- open input file</span></span><br><span class="line"><span class="keyword">local</span> cc, lc, wc = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> <span class="comment">-- char, line, and word counts</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">&quot;*line&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">lines</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> rest <span class="keyword">then</span> <span class="built_in">lines</span> = <span class="built_in">lines</span> .. rest .. <span class="string">&#x27;\n&#x27;</span> <span class="keyword">end</span></span><br><span class="line">    cc = cc + <span class="built_in">string</span>.<span class="built_in">len</span>(<span class="built_in">lines</span>)</span><br><span class="line">    <span class="comment">-- count words in the chunk</span></span><br><span class="line">    <span class="keyword">local</span> _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">&quot;%S+&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    wc = wc + t</span><br><span class="line">    <span class="comment">-- count newlines in the chunk</span></span><br><span class="line">    _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    lc = lc + t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(lc, wc, cc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> inp = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">1</span>], <span class="string">&quot;rb&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> out = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">2</span>], <span class="string">&quot;wb&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> data = inp:<span class="built_in">read</span>(<span class="string">&quot;*all&quot;</span>)</span><br><span class="line">data = <span class="built_in">string</span>.<span class="built_in">gsub</span>(data, <span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">out:<span class="built_in">write</span>(data)</span><br><span class="line"><span class="built_in">assert</span>(out:<span class="built_in">close</span>())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fsize</span> <span class="params">(file)</span></span></span><br><span class="line"><span class="keyword">local</span> current = file:seek() <span class="comment">-- get current position</span></span><br><span class="line"><span class="keyword">local</span> size = file:seek(<span class="string">&quot;end&quot;</span>) <span class="comment">-- get file size</span></span><br><span class="line">file:seek(<span class="string">&quot;set&quot;</span>, current) <span class="comment">-- restore position</span></span><br><span class="line"><span class="keyword">return</span> size</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="22-system-lib-æ“ä½œç³»ç»Ÿåº“"><a href="#22-system-lib-æ“ä½œç³»ç»Ÿåº“" class="headerlink" title="22 system lib æ“ä½œç³»ç»Ÿåº“"></a>22 system lib æ“ä½œç³»ç»Ÿåº“</h2><p>Lua æ˜¯ä»¥ ANSI C å†™æˆçš„</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- obs: 10800 = 3*60*60 (3 hours)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10800</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>, sec=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10801</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 54000 (obs: 54000 = 10800 + 12*60*60)</span></span><br><span class="line"></span><br><span class="line">temp = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;*t&quot;</span>, <span class="number">906000490</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">&#123;year = 1998, month = 9, day = 16, yday = 259, wday = 4,</span></span><br><span class="line"><span class="comment">hour = 23, min = 48, sec = 10, isdst = false&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">%a abbreviated weekday name (e.g., Wed)</span></span><br><span class="line"><span class="comment">%A full weekday name (e.g., Wednesday)</span></span><br><span class="line"><span class="comment">%b abbreviated month name (e.g., Sep)</span></span><br><span class="line"><span class="comment">%B full month name (e.g., September)</span></span><br><span class="line"><span class="comment">%c date and time (e.g., 09/16/98 23:48:10)</span></span><br><span class="line"><span class="comment">%d day of the month (16) [01-31]</span></span><br><span class="line"><span class="comment">%H hour, using a 24-hour clock (23) [00-23]</span></span><br><span class="line"><span class="comment">%I hour, using a 12-hour clock (11) [01-12]</span></span><br><span class="line"><span class="comment">%M minute (48) [00-59]</span></span><br><span class="line"><span class="comment">%m month (09) [01-12]</span></span><br><span class="line"><span class="comment">%p either &quot;am&quot; or &quot;pm&quot; (pm)</span></span><br><span class="line"><span class="comment">%S second (10) [00-61]</span></span><br><span class="line"><span class="comment">%w weekday (3) [0-6 = Sunday-Saturday]</span></span><br><span class="line"><span class="comment">%x date (e.g., 09/16/98)</span></span><br><span class="line"><span class="comment">%X time (e.g., 23:48:10)</span></span><br><span class="line"><span class="comment">%Y full year (1998)</span></span><br><span class="line"><span class="comment">%y two-digit year (98) [00-99]</span></span><br><span class="line"><span class="comment">%% the character &#x27;%&#x27;</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- äº‹å®ä¸Šå¦‚æœä¸ä½¿ç”¨ä»»ä½•å‚æ•°å°±è°ƒç”¨ dateï¼Œå°±æ˜¯ä»¥%c çš„å½¢å¼è¾“å‡ºã€‚</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;today is %A, in %B&quot;</span>))</span><br><span class="line"><span class="comment">--&gt; today is Tuesday, in May</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;%x&quot;</span>, <span class="number">906000490</span>))</span><br><span class="line"><span class="comment">--&gt; 09/16/1998</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HOME&quot;</span>)) <span class="comment">--&gt; /home/lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDir</span> <span class="params">(dirname)</span></span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;mkdir &quot;</span> .. dirname)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="23-debug-lib"><a href="#23-debug-lib" class="headerlink" title="23. debug lib"></a>23. debug lib</h2><p>debug åº“ç”±ä¸¤ç§å‡½æ•°ç»„æˆï¼šè‡ªçœ(<code>introspective</code>)å‡½æ•°å’Œ <code>hooks</code>ã€‚</p>
<p>è‡ªçœå‡½æ•° <em>ä½¿å¾—æˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¿è¡Œç¨‹åºçš„æŸäº›æ–¹é¢ï¼Œæ¯”å¦‚æ´»åŠ¨å‡½æ•°æ ˆã€å½“å‰æ‰§è¡Œä»£ç çš„è¡Œå·ã€æœ¬åœ°å˜é‡çš„åå’Œå€¼ã€‚</em><br>Hooks <em>å¯ä»¥è·Ÿè¸ªç¨‹åºçš„æ‰§è¡Œæƒ…å†µã€‚</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">debug</span>.<span class="built_in">getinfo</span>(foo)</span><br></pre></td></tr></table></figure>

<p>ä»¥æ•°å­— n è°ƒç”¨ <code>debug.getinfo(n)</code>æ—¶ï¼Œè¿”å›åœ¨ <strong>n çº§æ ˆ</strong>çš„æ´»åŠ¨å‡½æ•°çš„ä¿¡æ¯æ•°æ®ã€‚<br>æ¯”å¦‚ï¼Œå¦‚æœ n&#x3D;1ï¼Œè¿”å›çš„æ˜¯æ­£åœ¨è¿›è¡Œè°ƒç”¨çš„é‚£ä¸ªå‡½æ•°çš„ä¿¡æ¯ã€‚ï¼ˆn&#x3D;0 è¡¨ç¤º C å‡½æ•° getinfo æœ¬èº«ï¼‰<br>å¦‚æœ n æ¯”æ ˆä¸­æ´»åŠ¨å‡½æ•°çš„ä¸ªæ•°å¤§çš„è¯ï¼Œdebug.getinfo è¿”å› nilã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceback</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> level = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level, <span class="string">&quot;Sl&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> info.what == <span class="string">&quot;C&quot;</span> <span class="keyword">then</span> <span class="comment">-- is a C function?</span></span><br><span class="line">            <span class="built_in">print</span>(level, <span class="string">&quot;C function&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- a Lua function</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;[%s]:%d&quot;</span>,</span><br><span class="line">            info.short_src, info.currentline))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        level = level + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">a 10</span></span><br><span class="line"><span class="comment">b 20</span></span><br><span class="line"><span class="comment">x nil</span></span><br><span class="line"><span class="comment">a 4</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">local</span> x</span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">local</span> c = a - b <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> name, value = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">1</span>, a)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">print</span>(name, value)</span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">foo(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getvarvalue</span> <span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">local</span> value, found</span><br><span class="line">    <span class="comment">-- try local variables</span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">2</span>, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">        value = v</span><br><span class="line">        found = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> found <span class="keyword">then</span> <span class="keyword">return</span> value <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- try upvalues</span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>).func</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getupvalue</span>(func, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span> <span class="keyword">return</span> v <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- not found; get global</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getfenv</span>(func)[name]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="23-2-hooks"><a href="#23-2-hooks" class="headerlink" title="23.2 hooks"></a>23.2 hooks</h3><p>Lua ä½¿ç”¨å•ä¸ªå‚æ•°è°ƒç”¨ hooksï¼Œå‚æ•°ä¸ºä¸€ä¸ªæè¿°äº§ç”Ÿè°ƒç”¨çš„äº‹ä»¶ï¼šâ€callâ€ã€â€returnâ€ã€â€lineâ€ æˆ– â€œcountâ€ã€‚</p>
<p>æœ‰å››ç§å¯ä»¥è§¦å‘ä¸€ä¸ª hook çš„äº‹ä»¶ï¼š</p>
<ul>
<li>å½“ Lua è°ƒç”¨ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™ call äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>æ¯æ¬¡å‡½æ•°è¿”å›çš„æ—¶å€™ï¼Œreturn äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>Lua å¼€å§‹æ‰§è¡Œä»£ç çš„æ–°è¡Œæ—¶å€™ï¼Œline äº‹ä»¶å‘ç”Ÿï¼›</li>
<li>è¿è¡ŒæŒ‡å®šæ•°ç›®çš„æŒ‡ä»¤ä¹‹åï¼Œcount äº‹ä»¶å‘ç”Ÿã€‚</li>
</ul>
<blockquote>
<p>C API</p>
</blockquote>
<h2 id="24-C-API-Overview"><a href="#24-C-API-Overview" class="headerlink" title="24. C API Overview"></a>24. C API Overview</h2><p>Lua è§£é‡Šå™¨æ˜¯ä¸€ä¸ªä½¿ç”¨ Lua æ ‡å‡†åº“å®ç°çš„ç‹¬ç«‹çš„è§£é‡Šå™¨ï¼Œå¥¹æ˜¯ä¸€ä¸ªå¾ˆå°çš„åº”ç”¨ï¼ˆæ€»å…±ä¸è¶…è¿‡ 500 è¡Œçš„ä»£ç ï¼‰ã€‚</p>
<p>è§£é‡Šå™¨è´Ÿè´£ç¨‹åºå’Œä½¿ç”¨è€…çš„æ¥å£ï¼š<em>ä»ä½¿ç”¨è€…é‚£é‡Œè·å–æ–‡ä»¶æˆ–è€…å­—ç¬¦ä¸²ï¼Œå¹¶ä¼ ç»™ Lua æ ‡å‡†åº“ï¼ŒLua æ ‡å‡†åº“è´Ÿè´£æœ€ç»ˆçš„ä»£ç è¿è¡Œã€‚</em></p>
<p>ç¬¬ä¸€ç§ï¼ŒC ä½œä¸ºåº”ç”¨ç¨‹åºè¯­è¨€ï¼ŒLua ä½œä¸ºä¸€ä¸ª<strong>åº“</strong>ä½¿ç”¨ï¼›<br>ç¬¬äºŒç§ï¼Œåè¿‡æ¥ï¼ŒLua ä½œä¸ºç¨‹åºè¯­è¨€ï¼ŒC ä½œä¸ºåº“ä½¿ç”¨ã€‚</p>
<p>C API:<br>    - è¯»å†™ Lua å…¨å±€å˜é‡çš„å‡½æ•°ï¼Œ<br>    - è°ƒç”¨ Lua å‡½æ•°çš„å‡½æ•°ï¼Œ<br>    - è¿è¡Œ Lua ä»£ç ç‰‡æ–­çš„å‡½æ•°ï¼Œ<br>    - æ³¨å†Œ C å‡½æ•°ç„¶åå¯ä»¥åœ¨Lua ä¸­è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œç­‰ç­‰ã€‚</p>
<p>å‹æ ˆå‡½æ•°:</p>
<pre><code>- ç©ºå€¼ï¼ˆnilï¼‰ç”¨ lua_pushnilï¼Œ
- æ•°å€¼å‹ï¼ˆdoubleï¼‰ç”¨ lua_pushnumberï¼Œ
- å¸ƒå°”å‹ï¼ˆåœ¨ C ä¸­ç”¨æ•´æ•°è¡¨ç¤ºï¼‰ç”¨lua_pushbooleanï¼Œ
- ä»»æ„çš„å­—ç¬¦ä¸²ï¼ˆchar*ç±»å‹ï¼Œ**å…è®¸åŒ…å«&#39;\0&#39;å­—ç¬¦**ï¼‰ç”¨ lua_pushlstringï¼ŒCè¯­è¨€é£æ ¼ï¼ˆä»¥&#39;\0&#39;ç»“æŸï¼‰çš„å­—ç¬¦ä¸²ï¼ˆconst char*ï¼‰ç”¨ lua_pushstringï¼š
</code></pre>
<p>Lua ä¸­çš„å­—ç¬¦ä¸²ä¸æ˜¯ä»¥é›¶ä¸ºç»“æŸç¬¦çš„ï¼›å®ƒä»¬ä¾èµ–äºä¸€ä¸ªæ˜ç¡®çš„é•¿åº¦ï¼Œå› æ­¤å¯ä»¥åŒ…å«ä»»æ„çš„äºŒè¿›åˆ¶æ•°æ®ã€‚<br>Lua ä»æ¥ä¸ä¿æŒä¸€ä¸ªæŒ‡å‘<strong>å¤–éƒ¨å­—ç¬¦ä¸²</strong>ï¼ˆæˆ–ä»»ä½•å…¶å®ƒå¯¹è±¡ï¼Œé™¤äº† C å‡½æ•°â€”â€”å®ƒæ€»æ˜¯é™æ€æŒ‡é’ˆï¼‰çš„æŒ‡é’ˆã€‚</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int lua_checkstack (lua_State *L, int sz);</span><br></pre></td></tr></table></figure>

<p>lua_isnumber å’Œ lua_isstring å‡½æ•°ä¸æ£€æŸ¥è¿™ä¸ªå€¼æ˜¯å¦æ˜¯æŒ‡å®šçš„ç±»å‹ï¼Œè€Œæ˜¯çœ‹å®ƒ<strong>æ˜¯å¦èƒ½è¢«è½¬æ¢æˆæŒ‡å®šçš„é‚£ç§ç±»å‹</strong>ã€‚ä¾‹å¦‚ï¼Œä»»ä½•æ•°å­—ç±»å‹éƒ½æ»¡è¶³ lua_isstring</p>
<p>lua_type å‡½æ•°ï¼Œå®ƒè¿”å›æ ˆä¸­å…ƒç´ çš„ç±»å‹ã€‚</p>
<p>ç»™å®šçš„å…ƒç´ çš„ç±»å‹ä¸æ­£ç¡®,lua_tobooleanã€lua_tonumber å’Œ lua_strlen è¿”å› 0ï¼Œå…¶ä»–å‡½æ•°è¿”å› NULL</p>
<p>å½“ä¸€ä¸ª C å‡½æ•°è¿”å›åï¼ŒLua ä¼šæ¸…ç†ä»–çš„æ ˆ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *s = lua_tostring(L, <span class="number">-1</span>); <span class="comment">/* any Lua string */</span></span><br><span class="line"><span class="type">size_t</span> l = lua_strlen(L, <span class="number">-1</span>); <span class="comment">/* its length */</span></span><br><span class="line">assert(s[l] == <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">assert(<span class="built_in">strlen</span>(s) &lt;= l);</span><br></pre></td></tr></table></figure>

<p>å‡½æ•° lua_gettop è¿”å›å †æ ˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œå®ƒä¹Ÿæ˜¯æ ˆé¡¶å…ƒç´ çš„ç´¢å¼•</p>
<p>ä¸€ä¸ªè´Ÿæ•°ç´¢å¼•-x å¯¹åº”äºæ­£æ•°ç´¢å¼• gettop-x+1ã€‚</p>
<p>lua_settop è®¾ç½®æ ˆé¡¶ï¼ˆä¹Ÿå°±æ˜¯å †æ ˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼‰ä¸ºä¸€ä¸ªæŒ‡å®šçš„å€¼ã€‚<br>    - å¦‚æœå¼€å§‹çš„æ ˆé¡¶é«˜äºæ–°çš„æ ˆé¡¶ï¼Œé¡¶éƒ¨çš„å€¼è¢«ä¸¢å¼ƒã€‚<br>    - å¦åˆ™ï¼Œä¸ºäº†å¾—åˆ°æŒ‡å®šçš„å¤§å°è¿™ä¸ªå‡½æ•°å‹å…¥ç›¸åº”ä¸ªæ•°çš„ç©ºå€¼ï¼ˆnilï¼‰åˆ°æ ˆä¸Šã€‚</p>
<p>lua_settop(L,0)æ¸…ç©ºå †æ ˆã€‚</p>
<p>å‡½æ•° lua_pushvalue å‹å…¥å †æ ˆä¸ŠæŒ‡å®šç´¢å¼•çš„ä¸€ä¸ªæŠŸè´åˆ°æ ˆé¡¶ï¼›<br>lua_remove ç§»é™¤æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ ï¼Œå¹¶å°†å…¶ä¸Šé¢æ‰€æœ‰çš„å…ƒç´ ä¸‹ç§»æ¥å¡«è¡¥è¿™ä¸ªä½ç½®çš„ç©ºç™½ï¼›<br>lua_insert ç§»åŠ¨æ ˆé¡¶å…ƒç´ åˆ°æŒ‡å®šç´¢å¼•çš„ä½ç½®ï¼Œå¹¶å°†è¿™ä¸ªç´¢å¼•ä½ç½®ä¸Šé¢çš„å…ƒç´ å…¨éƒ¨ä¸Šç§»è‡³æ ˆé¡¶è¢«ç§»åŠ¨ç•™ä¸‹çš„ç©ºéš”ï¼›<br>æœ€åï¼Œlua_replace ä»æ ˆé¡¶å¼¹å‡ºå…ƒç´ å€¼å¹¶å°†å…¶è®¾ç½®åˆ°æŒ‡å®šç´¢å¼•ä½ç½®ï¼Œæ²¡æœ‰ä»»ä½•ç§»åŠ¨æ“ä½œã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">stackDump</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> top = lua_gettop(L);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=top;i++)&#123; <span class="comment">/*repeatforeachlevel*/</span></span><br><span class="line">        <span class="type">int</span> t = lua_type(L, i);</span><br><span class="line">        <span class="keyword">switch</span> (t) &#123;</span><br><span class="line">        <span class="keyword">case</span> LUA_TSTRING: <span class="comment">/* strings */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;`%s&#x27;&quot;</span>, lua_tostring(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TBOOLEAN: <span class="comment">/* booleans */</span></span><br><span class="line">            <span class="built_in">printf</span>(lua_toboolean(L, i) ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TNUMBER: <span class="comment">/* numbers */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%g&quot;</span>, lua_tonumber(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* other values */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, lua_typename(L, t)); </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>); <span class="comment">/* put a separator */</span> &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); <span class="comment">/* end the listing */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    lua_State *L = lua_open();</span><br><span class="line">    lua_pushboolean(L, <span class="number">1</span>); lua_pushnumber(L, <span class="number">10</span>);</span><br><span class="line">    lua_pushnil(L); lua_pushstring(L, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello&#x27; */</span></span><br><span class="line">    lua_pushvalue(L, <span class="number">-4</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello&#x27; true */</span></span><br><span class="line">    lua_replace(L, <span class="number">3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello&#x27; */</span></span><br><span class="line">    lua_settop(L, <span class="number">6</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello&#x27; nil nil */</span></span><br><span class="line">    lua_remove(L, <span class="number">-3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true nil nil */</span></span><br><span class="line">    lua_settop(L, <span class="number">-5</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true */</span></span><br><span class="line">    lua_close(L);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="24-3-C-API-exception-handler"><a href="#24-3-C-API-exception-handler" class="headerlink" title="24.3 C API exception handler"></a>24.3 C API exception handler</h3><p>å½“æˆ‘ä»¬å†™ä¸€ä¸ªåº“ä»£ç æ—¶ï¼ˆä¹Ÿå°±æ˜¯è¢« Lua è°ƒç”¨çš„ C å‡½æ•°ï¼‰é•¿è·³è½¬ï¼ˆlong jumpï¼‰çš„ç”¨å¤„å‡ ä¹å’Œä¸€ä¸ªçœŸæ­£çš„å¼‚å¸¸å¤„ç†ä¸€æ ·çš„æ–¹ä¾¿ï¼Œå› ä¸º Lua æŠ“å–äº†ä»»åŠ¡å¶ç„¶çš„é”™è¯¯ã€‚</p>
<p>panic å‡½æ•°<br>lua_pcall<br>lua_cpcall<br>luaL_error</p>
<h2 id="25-invoking-lua-function"><a href="#25-invoking-lua-function" class="headerlink" title="25. invoking lua function"></a>25. invoking lua function</h2><h2 id="26-invoking-C-function"><a href="#26-invoking-C-function" class="headerlink" title="26. invoking C function"></a>26. invoking C function</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lua_pushcfunction(l, l_sin);</span><br><span class="line">lua_setglobal(l, <span class="string">&quot;mysin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">l_sin</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">double</span> d = luaL_checknumber(L, <span class="number">1</span>);</span><br><span class="line">    lua_pushnumber(L, <span class="built_in">sin</span>(d));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* number of results */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cå‡½æ•°åº“</span></span><br><span class="line">LUAMOD_API <span class="type">int</span></span><br><span class="line"><span class="title function_">luaopen_rmq_core</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_Reg l[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;lwrite&quot;</span>, lrmq_write &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;pack&quot;</span>, lrmq_pack &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;unpack&quot;</span>, lrmq_unpack &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;bind&quot;</span>, lrmq_bind &#125;,</span><br><span class="line">        &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    luaL_checkversion(L);</span><br><span class="line">    luaL_newlib(L,l);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="28-user-defined-types-in-C"><a href="#28-user-defined-types-in-C" class="headerlink" title="28. user-defined types in C"></a>28. user-defined types in C</h2><p>æ¥å£è®¿é—®å½¢å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; userdata: 0x8064d48</span></span><br><span class="line"><span class="built_in">print</span>(array.size(a)) <span class="comment">--&gt; 1000</span></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">1000</span> <span class="keyword">do</span></span><br><span class="line">array.set(a, i, <span class="number">1</span>/i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">newarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n = luaL_checkint(L, <span class="number">1</span>);</span><br><span class="line">    <span class="type">size_t</span> nbytes = <span class="keyword">sizeof</span>(NumArray) + (n - <span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">    NumArray *a = (NumArray *)lua_newuserdata(L, nbytes);</span><br><span class="line">    luaL_getmetatable(L, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    a-&gt;size = n;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* new userdatum is already on the stack */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> NumArray *<span class="title function_">checkarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *ud = luaL_checkudata(L, <span class="number">1</span>, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    luaL_argcheck(L, ud != <span class="literal">NULL</span>, <span class="number">1</span>, <span class="string">&quot;`array&#x27; expected&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (NumArray *)ud;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">getsize</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushnumber(L, a-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">double</span> *<span class="title function_">getelem</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    <span class="type">int</span> index = luaL_checkint(L, <span class="number">2</span>);</span><br><span class="line">    luaL_argcheck(L, <span class="number">1</span> &lt;= index &amp;&amp; index &lt;= a-&gt;size, <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;index out of range&quot;</span>);</span><br><span class="line">    <span class="comment">/* return element address */</span></span><br><span class="line">    <span class="keyword">return</span> &amp;a-&gt;values[index - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">double</span> newvalue = luaL_checknumber(L, <span class="number">3</span>);</span><br><span class="line">    *getelem(L) = newvalue;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">getarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    lua_pushnumber(L, *getelem(L));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_f</span> [] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;new&quot;</span>, newarray&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_m</span> [] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;__tostring&quot;</span>, array2string&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;set&quot;</span>, setarray&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;get&quot;</span>, getarray&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;size&quot;</span>, getsize&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">array2string</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushfstring(L, <span class="string">&quot;array(%d)&quot;</span>, a-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_array</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    lua_pushvalue(L, <span class="number">-2</span>); <span class="comment">/* pushes the metatable */</span></span><br><span class="line">    lua_settable(L, <span class="number">-3</span>); <span class="comment">/* metatable.__index = metatable */</span></span><br><span class="line">    </span><br><span class="line">    luaL_openlib(L, <span class="literal">NULL</span>, arraylib_m, <span class="number">0</span>);</span><br><span class="line">    luaL_openlib(L, <span class="string">&quot;array&quot;</span>, arraylib_f, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>note:<em>luaL_openlib çš„å¦ä¸€ä¸ªç‰¹å¾ï¼Œç¬¬ä¸€æ¬¡è°ƒç”¨ï¼Œå½“æˆ‘ä»¬ä¼ é€’ä¸€ä¸ª NULLä½œä¸ºåº“åæ—¶ï¼ŒluaL_openlib å¹¶æ²¡æœ‰åˆ›å»ºä»»ä½•åŒ…å«å‡½æ•°çš„è¡¨ï¼›ç›¸åï¼Œä»–è®¤ä¸ºå°è£…å‡½æ•°çš„è¡¨åœ¨æ ˆå†…ï¼Œä½äºä¸´æ—¶çš„ upvalues çš„ä¸‹é¢ã€‚</em></p>
<p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°è£…å‡½æ•°çš„è¡¨æ˜¯ metatable æœ¬èº«ï¼Œä¹Ÿå°±æ˜¯ luaL_openlib æ”¾ç½®æ–¹æ³•çš„åœ°æ–¹ã€‚*</p>
<p>é¢å‘å¯¹è±¡è®¿é—®å½¢å¼:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a:size()) <span class="comment">--&gt; 1000</span></span><br><span class="line">a:set(<span class="number">10</span>, <span class="number">3.4</span>)</span><br><span class="line"><span class="built_in">print</span>(a:get(<span class="number">10</span>)) <span class="comment">--&gt; 3.4</span></span><br></pre></td></tr></table></figure>

<h2 id="29-resource-managerment-èµ„æºç®¡ç†"><a href="#29-resource-managerment-èµ„æºç®¡ç†" class="headerlink" title="29. resource managerment èµ„æºç®¡ç†"></a>29. resource managerment èµ„æºç®¡ç†</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="comment">/* forward declaration for the iterator function */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_iter</span> <span class="params">(lua_State *L)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">l_dir</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = luaL_checkstring(L, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* create a userdatum to store a DIR address */</span></span><br><span class="line">    DIR **d = (DIR **)lua_newuserdata(L, <span class="keyword">sizeof</span>(DIR *));</span><br><span class="line">    <span class="comment">/* set its metatable */</span></span><br><span class="line">    luaL_getmetatable(L, <span class="string">&quot;LuaBook.dir&quot;</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">/* try to open the given directory */</span></span><br><span class="line">    *d = opendir(path);</span><br><span class="line">    <span class="keyword">if</span> (*d == <span class="literal">NULL</span>) <span class="comment">/* error opening the directory? */</span></span><br><span class="line">    luaL_error(L, <span class="string">&quot;cannot open %s: %s&quot;</span>, path,</span><br><span class="line">    strerror(errno));</span><br><span class="line">    <span class="comment">/* creates and returns the iterator function</span></span><br><span class="line"><span class="comment">        (its sole upvalue, the directory userdatum,</span></span><br><span class="line"><span class="comment">        is already on the stack top */</span></span><br><span class="line">    lua_pushcclosure(L, dir_iter, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_iter</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, lua_upvalueindex(<span class="number">1</span>));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = readdir(d)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    lua_pushstring(L, entry-&gt;d_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* no more values to return */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_gc</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (d) closedir(d);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_dir</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">&quot;LuaBook.dir&quot;</span>);</span><br><span class="line">    <span class="comment">/* set its __gc field */</span></span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">    lua_pushcfunction(L, dir_gc);</span><br><span class="line">    lua_settable(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">/* register the `dir&#x27; function */</span></span><br><span class="line">    lua_pushcfunction(L, l_dir);</span><br><span class="line">    lua_setglobal(L, <span class="string">&quot;dir&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Lua-ç‰ˆæœ¬æ›´æ–°è®°å½•"><a href="#Lua-ç‰ˆæœ¬æ›´æ–°è®°å½•" class="headerlink" title="Lua ç‰ˆæœ¬æ›´æ–°è®°å½•"></a>Lua ç‰ˆæœ¬æ›´æ–°è®°å½•</h2><h3 id="ä¸­æ–‡ç‰ˆ"><a href="#ä¸­æ–‡ç‰ˆ" class="headerlink" title="ä¸­æ–‡ç‰ˆ"></a>ä¸­æ–‡ç‰ˆ</h3><h4 id="è‡ª-Lua-5-3-ä»¥æ¥çš„å˜åŒ–"><a href="#è‡ª-Lua-5-3-ä»¥æ¥çš„å˜åŒ–" class="headerlink" title="è‡ª Lua 5.3 ä»¥æ¥çš„å˜åŒ–"></a>è‡ª Lua 5.3 ä»¥æ¥çš„å˜åŒ–</h4><p>ä»¥ä¸‹æ˜¯ Lua 5.4 å¼•å…¥çš„ä¸»è¦å˜åŒ–ã€‚å‚è€ƒæ‰‹å†Œåˆ—å‡ºäº†å¿…é¡»å¼•å…¥çš„ä¸å…¼å®¹æ€§ã€‚</p>
<h5 id="ä¸»è¦å˜åŒ–"><a href="#ä¸»è¦å˜åŒ–" class="headerlink" title="ä¸»è¦å˜åŒ–"></a>ä¸»è¦å˜åŒ–</h5><ul>
<li>åƒåœ¾æ”¶é›†çš„æ–°ç”Ÿä»£æ¨¡å¼(æ–°æ–¹æ³• æ„å‘³ç€æ›´é¢‘ç¹åœ°å¯åŠ¨è¾ƒçŸ­çš„è·Ÿè¸ªï¼Œä»…æ¶µç›–æœ€è¿‘åˆ›å»ºçš„å¯¹è±¡ã€‚ ä»…åœ¨çŸ­æš‚çš„çˆ¬ç½‘ä¹‹åæ— æ³•è¾¾åˆ°æ‰€éœ€çš„å†…å­˜æ¶ˆè€—æŒ‡æ ‡æ—¶ï¼Œæ‰æ‰§è¡Œæ‰€æœ‰å¯¹è±¡çš„å®Œå…¨çˆ¬ç½‘ã€‚ è¿™ç§æ–¹æ³•å¯å®ç°æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„å†…å­˜æ¶ˆè€— åœ¨å­˜å‚¨å¤§é‡å­˜åœ¨æ—¶é—´çŸ­çš„å¯¹è±¡çš„æƒ…å†µä¸‹ã€‚)</li>
<li>å¾…å…³é—­å˜é‡</li>
<li>å¸¸é‡å˜é‡</li>
<li>userdata å¯ä»¥æœ‰å¤šä¸ªç”¨æˆ·å€¼</li>
<li>math.random çš„æ–°å®ç°</li>
<li>è­¦å‘Šç³»ç»Ÿ</li>
<li>å…³äºå‡½æ•°å‚æ•°å’Œè¿”å›å€¼çš„è°ƒè¯•ä¿¡æ¯</li>
<li>æ•´æ•° â€˜forâ€™ å¾ªç¯çš„æ–°è¯­ä¹‰</li>
<li>å¯é€‰çš„ â€˜initâ€™ å‚æ•°ç”¨äº â€˜string.gmatchâ€™</li>
<li>æ–°å‡½æ•° â€˜lua_resetthreadâ€™ å’Œ â€˜coroutine.closeâ€™</li>
<li>å­—ç¬¦ä¸²åˆ°æ•°å­—çš„å¼ºåˆ¶è½¬æ¢ç§»è‡³å­—ç¬¦ä¸²åº“</li>
<li>å½“ç¼©å°å†…å­˜å—æ—¶ï¼Œå…è®¸åˆ†é…å‡½æ•°å¤±è´¥</li>
<li>â€˜string.formatâ€™ ä¸­çš„æ–°æ ¼å¼ â€˜%pâ€™</li>
<li>utf8 åº“æ¥å—æœ€å¤š 2^31 çš„ä»£ç ç‚¹</li>
</ul>
<h4 id="è‡ª-Lua-5-2-ä»¥æ¥çš„å˜åŒ–"><a href="#è‡ª-Lua-5-2-ä»¥æ¥çš„å˜åŒ–" class="headerlink" title="è‡ª Lua 5.2 ä»¥æ¥çš„å˜åŒ–"></a>è‡ª Lua 5.2 ä»¥æ¥çš„å˜åŒ–</h4><p>ä»¥ä¸‹æ˜¯ Lua 5.3 å¼•å…¥çš„ä¸»è¦å˜åŒ–ã€‚å‚è€ƒæ‰‹å†Œåˆ—å‡ºäº†å¿…é¡»å¼•å…¥çš„ä¸å…¼å®¹æ€§ã€‚</p>
<h5 id="ä¸»è¦å˜åŒ–-1"><a href="#ä¸»è¦å˜åŒ–-1" class="headerlink" title="ä¸»è¦å˜åŒ–"></a>ä¸»è¦å˜åŒ–</h5><ul>
<li>æ•´æ•°ï¼ˆé»˜è®¤ 64 ä½ï¼‰</li>
<li>å®˜æ–¹æ”¯æŒ 32 ä½æ•°å­—</li>
<li>ä½è¿ç®—ç¬¦</li>
<li>åŸºæœ¬çš„ utf-8 æ”¯æŒ</li>
<li>ç”¨äºæ‰“åŒ…å’Œè§£åŒ…å€¼çš„å‡½æ•°</li>
<li>ä»¥ä¸‹æ˜¯ Lua 5.3 å¼•å…¥çš„å…¶ä»–å˜åŒ–ï¼š</li>
</ul>
<h5 id="è¯­è¨€"><a href="#è¯­è¨€" class="headerlink" title="è¯­è¨€"></a>è¯­è¨€</h5><ul>
<li>userdata å¯ä»¥æœ‰ä»»ä½• Lua å€¼ä½œä¸ºç”¨æˆ·å€¼</li>
<li>å‘ä¸‹å–æ•´é™¤æ³•</li>
<li>ä¸€äº›å…ƒæ–¹æ³•çš„æ›´çµæ´»è§„åˆ™</li>
</ul>
<h5 id="åº“"><a href="#åº“" class="headerlink" title="åº“"></a>åº“</h5><ul>
<li>ipairs å’Œ table åº“å°Šé‡å…ƒæ–¹æ³•</li>
<li>string.dump ä¸­çš„ strip é€‰é¡¹</li>
<li>table åº“å°Šé‡å…ƒæ–¹æ³•</li>
<li>æ–°å‡½æ•° table.move</li>
<li>æ–°å‡½æ•° string.pack</li>
<li>æ–°å‡½æ•° string.unpack</li>
<li>æ–°å‡½æ•° string.packsize</li>
</ul>
<h5 id="C-API"><a href="#C-API" class="headerlink" title="C API"></a>C API</h5><ul>
<li>æ›´ç®€å•çš„ C ä¸­çš„å»¶ç»­å‡½æ•° API</li>
<li>lua_gettable å’Œç±»ä¼¼å‡½æ•°è¿”å›ç»“æœå€¼çš„ç±»å‹</li>
<li>lua_dump ä¸­çš„ strip é€‰é¡¹</li>
<li>æ–°å‡½æ•°ï¼šlua_geti</li>
<li>æ–°å‡½æ•°ï¼šlua_seti</li>
<li>æ–°å‡½æ•°ï¼šlua_isyieldable</li>
<li>æ–°å‡½æ•°ï¼šlua_numbertointeger</li>
<li>æ–°å‡½æ•°ï¼šlua_rotate</li>
<li>æ–°å‡½æ•°ï¼šlua_stringtonumber</li>
</ul>
<h5 id="Lua-ç‹¬ç«‹è§£é‡Šå™¨"><a href="#Lua-ç‹¬ç«‹è§£é‡Šå™¨" class="headerlink" title="Lua ç‹¬ç«‹è§£é‡Šå™¨"></a>Lua ç‹¬ç«‹è§£é‡Šå™¨</h5><ul>
<li>å¯ç”¨ä½œè®¡ç®—å™¨ï¼›æ— éœ€å‰ç¼€ â€˜&#x3D;â€™</li>
<li>arg è¡¨å¯¹æ‰€æœ‰ä»£ç å¯ç”¨</li>
</ul>
<h4 id="è‡ª-Lua-5-1-ä»¥æ¥çš„å˜åŒ–"><a href="#è‡ª-Lua-5-1-ä»¥æ¥çš„å˜åŒ–" class="headerlink" title="è‡ª Lua 5.1 ä»¥æ¥çš„å˜åŒ–"></a>è‡ª Lua 5.1 ä»¥æ¥çš„å˜åŒ–</h4><p>ä»¥ä¸‹æ˜¯ Lua 5.2 å¼•å…¥çš„ä¸»è¦å˜åŒ–ã€‚å‚è€ƒæ‰‹å†Œåˆ—å‡ºäº†å¿…é¡»å¼•å…¥çš„ä¸å…¼å®¹æ€§ã€‚</p>
<h5 id="ä¸»è¦å˜åŒ–-2"><a href="#ä¸»è¦å˜åŒ–-2" class="headerlink" title="ä¸»è¦å˜åŒ–"></a>ä¸»è¦å˜åŒ–</h5><ul>
<li>å¯æŒ‚èµ·çš„ pcall å’Œå…ƒæ–¹æ³•</li>
<li>å…¨å±€å˜é‡çš„æ–°è¯æ³•æ–¹æ¡ˆ</li>
<li>çŸ­å‘½è¡¨</li>
<li>ä½è¿ç®—çš„æ–°åº“</li>
<li>è½»é‡çº§ C å‡½æ•°</li>
<li>ç´§æ€¥åƒåœ¾æ”¶é›†å™¨</li>
<li>goto è¯­å¥</li>
<li>è¡¨çš„ç»ˆç»“å™¨<br>ä»¥ä¸‹æ˜¯ Lua 5.2 å¼•å…¥çš„å…¶ä»–å˜åŒ–ï¼š</li>
</ul>
<h5 id="è¯­è¨€-1"><a href="#è¯­è¨€-1" class="headerlink" title="è¯­è¨€"></a>è¯­è¨€</h5><ul>
<li>çº¿ç¨‹æˆ–å‡½æ•°ä¸å†æœ‰ fenv</li>
<li>è¡¨å°Šé‡ __len å…ƒæ–¹æ³•</li>
<li>å­—ç¬¦ä¸²ä¸­çš„åå…­è¿›åˆ¶å’Œ \z è½¬ä¹‰</li>
<li>æ”¯æŒåå…­è¿›åˆ¶æµ®ç‚¹æ•°</li>
<li>ä¸åŒç±»å‹çš„é¡ºåºå…ƒæ–¹æ³•</li>
<li>ä¸å†éªŒè¯æ“ä½œç ä¸€è‡´æ€§</li>
<li>é’©å­äº‹ä»¶ â€œtail returnâ€ è¢« â€œtail callâ€ å–ä»£</li>
<li>ç©ºè¯­å¥</li>
<li>break è¯­å¥å¯ä»¥å‡ºç°åœ¨å—çš„ä¸­é—´</li>
</ul>
<h5 id="åº“-1"><a href="#åº“-1" class="headerlink" title="åº“"></a>åº“</h5><ul>
<li>é€šè¿‡ xpcall è°ƒç”¨çš„å‡½æ•°çš„å‚æ•°</li>
<li>load å’Œ loadfile çš„å¯é€‰ â€˜modeâ€™ å‚æ•°ï¼ˆæ§åˆ¶äºŒè¿›åˆ¶ x æ–‡æœ¬ï¼‰</li>
<li>load å’Œ loadfile çš„å¯é€‰ â€˜envâ€™ å‚æ•°ï¼ˆåŠ è½½å—çš„ç¯å¢ƒï¼‰</li>
<li>loadlib å¯ä»¥åŠ è½½å…·æœ‰å…¨å±€åç§°çš„åº“ï¼ˆRTLD_GLOBALï¼‰</li>
<li>æ–°å‡½æ•° package.searchpath</li>
<li>æ¨¡å—åŠ è½½æ—¶æ¥æ”¶å®ƒä»¬çš„è·¯å¾„</li>
<li>math.log ä¸­çš„å¯é€‰åŸºæ•°</li>
<li>string.rep ä¸­çš„å¯é€‰åˆ†éš”ç¬¦</li>
<li>file:write è¿”å›æ–‡ä»¶</li>
<li>å…³é—­ç®¡é“è¿”å›é€€å‡ºçŠ¶æ€</li>
<li>os.exit å¯ä»¥å…³é—­çŠ¶æ€</li>
<li>æ–°å…ƒæ–¹æ³• __pairs å’Œ __ipairs</li>
<li>collectgarbage å’Œ lua_gc çš„æ–°é€‰é¡¹ â€˜isrunningâ€™</li>
<li>è¾¹ç•Œæ¨¡å¼</li>
<li>æ¨¡å¼ä¸­çš„ \0</li>
<li>io.read çš„æ–°é€‰é¡¹ *L</li>
<li>io.lines çš„é€‰é¡¹</li>
<li>debug.getlocal å¯ä»¥è®¿é—®å‡½æ•°çš„å¯å˜å‚æ•°</li>
</ul>
<h5 id="C-API-1"><a href="#C-API-1" class="headerlink" title="C API"></a>C API</h5><ul>
<li>æ³¨å†Œè¡¨ä¸­é¢„å®šä¹‰çš„ä¸»çº¿ç¨‹</li>
<li>æ–°å‡½æ•° lua_absindex, lua_arith, lua_compare, lua_copy, lua_len, lua_rawgetp, lua_rawsetp, lua_upvalueid, lua_upvaluejoin, lua_version.</li>
<li>æ–°å‡½æ•° luaL_checkversion, luaL_setmetatable, luaL_testudata, luaL_tolstring.</li>
<li>lua_pushstring å’Œ pushlstring è¿”å›å­—ç¬¦ä¸²</li>
<li>debug API ä¸­å¯ç”¨çš„ nparams å’Œ isvararg</li>
<li>æ–°çš„ lua_Unsigned</li>
</ul>
<h5 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h5><ul>
<li>æ¯ä¸ªå‡½æ•°çš„æœ€å¤§å¸¸é‡æé«˜åˆ° 226</li>
<li>åƒåœ¾æ”¶é›†çš„ä»£é™…æ¨¡å¼ï¼ˆå®éªŒæ€§ï¼‰</li>
<li>NaN æŠ€å·§ï¼ˆå®éªŒæ€§ï¼‰</li>
<li>ctypes çš„å†…éƒ¨ï¼ˆä¸å¯å˜ï¼‰ç‰ˆæœ¬</li>
<li>å­—ç¬¦ä¸²ç¼“å†²åŒºçš„æ›´ç®€å•å®ç°</li>
<li>è§£æå™¨ä½¿ç”¨æ›´å°‘çš„ C æ ˆç©ºé—´ï¼ˆä¸å†æœ‰è‡ªåŠ¨æ•°ç»„ï¼‰</li>
</ul>
<h5 id="Lua-ç‹¬ç«‹è§£é‡Šå™¨-1"><a href="#Lua-ç‹¬ç«‹è§£é‡Šå™¨-1" class="headerlink" title="Lua ç‹¬ç«‹è§£é‡Šå™¨"></a>Lua ç‹¬ç«‹è§£é‡Šå™¨</h5><ul>
<li>æ–°çš„ -E é€‰é¡¹ä»¥é¿å…ç¯å¢ƒå˜é‡</li>
<li>å¤„ç†éå­—ç¬¦ä¸²é”™è¯¯æ¶ˆæ¯</li>
</ul>
<h3 id="è‹±æ–‡åŸç‰ˆ"><a href="#è‹±æ–‡åŸç‰ˆ" class="headerlink" title="è‹±æ–‡åŸç‰ˆ"></a>è‹±æ–‡åŸç‰ˆ</h3><h4 id="Changes-since-Lua-5-3"><a href="#Changes-since-Lua-5-3" class="headerlink" title="Changes since Lua 5.3"></a>Changes since Lua 5.3</h4><p>Here are the main changes introduced in Lua 5.4. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes"><a href="#Main-changes" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>new generational mode for garbage collection</li>
<li>to-be-closed variables</li>
<li>const variables</li>
<li>userdata can have multiple user values</li>
<li>new implementation for math.random</li>
<li>warning system</li>
<li>debug information about function arguments and returns</li>
<li>new semantics for the integer â€˜forâ€™ loop</li>
<li>optional â€˜initâ€™ argument to â€˜string.gmatchâ€™</li>
<li>new functions â€˜lua_resetthreadâ€™ and â€˜coroutine.closeâ€™</li>
<li>string-to-number coercions moved to the string library</li>
<li>allocation function allowed to fail when shrinking a memory block</li>
<li>new format â€˜%pâ€™ in â€˜string.formatâ€™</li>
<li>utf8 library accepts codepoints up to 2^31</li>
</ul>
<h4 id="Changes-since-Lua-5-2"><a href="#Changes-since-Lua-5-2" class="headerlink" title="Changes since Lua 5.2"></a>Changes since Lua 5.2</h4><p>Here are the main changes introduced in Lua 5.3. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes-1"><a href="#Main-changes-1" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>integers (64-bit by default)</li>
<li>official support for 32-bit numbers</li>
<li>bitwise operators</li>
<li>basic utf-8 support</li>
<li>functions for packing and unpacking values</li>
<li>Here are the other changes introduced in Lua 5.3:</li>
</ul>
<h5 id="Language"><a href="#Language" class="headerlink" title="Language"></a>Language</h5><ul>
<li>userdata can have any Lua value as uservalue</li>
<li>floor division</li>
<li>more flexible rules for some metamethods</li>
</ul>
<h5 id="Libraries"><a href="#Libraries" class="headerlink" title="Libraries"></a>Libraries</h5><ul>
<li>ipairs and the table library respect metamethods</li>
<li>strip option in string.dump</li>
<li>table library respects metamethods</li>
<li>new function table.move</li>
<li>new function string.pack</li>
<li>new function string.unpack</li>
<li>new function string.packsize</li>
</ul>
<h5 id="C-API-2"><a href="#C-API-2" class="headerlink" title="C API"></a>C API</h5><ul>
<li>simpler API for continuation functions in C</li>
<li>lua_gettable and similar functions return type of resulted value</li>
<li>strip option in lua_dump</li>
<li>new function: lua_geti</li>
<li>new function: lua_seti</li>
<li>new function: lua_isyieldable</li>
<li>new function: lua_numbertointeger</li>
<li>new function: lua_rotate</li>
<li>new function: lua_stringtonumber</li>
</ul>
<h5 id="Lua-standalone-interpreter"><a href="#Lua-standalone-interpreter" class="headerlink" title="Lua standalone interpreter"></a>Lua standalone interpreter</h5><ul>
<li>can be used as calculator; no need to prefix with â€˜&#x3D;â€™</li>
<li>arg table available to all code</li>
</ul>
<h4 id="Changes-since-Lua-5-1"><a href="#Changes-since-Lua-5-1" class="headerlink" title="Changes since Lua 5.1"></a>Changes since Lua 5.1</h4><p>Here are the main changes introduced in Lua 5.2. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes-2"><a href="#Main-changes-2" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>yieldable pcall and metamethods</li>
<li>new lexical scheme for globals</li>
<li>ephemeron tables</li>
<li>new library for bitwise operations</li>
<li>light C functions</li>
<li>emergency garbage collector</li>
<li>goto statement</li>
<li>finalizers for tables<br>Here are the other changes introduced in Lua 5.2:</li>
</ul>
<h5 id="Language-1"><a href="#Language-1" class="headerlink" title="Language"></a>Language</h5><ul>
<li>no more fenv for threads or functions</li>
<li>tables honor the __len metamethod</li>
<li>hex and \z escapes in strings</li>
<li>support for hexadecimal floats</li>
<li>order metamethods work for different types</li>
<li>no more verification of opcode consistency</li>
<li>hook event â€œtail returnâ€ replaced by â€œtail callâ€</li>
<li>empty statement</li>
<li>break statement may appear in the middle of a block</li>
</ul>
<h5 id="Libraries-1"><a href="#Libraries-1" class="headerlink" title="Libraries"></a>Libraries</h5><ul>
<li>arguments for function called through xpcall</li>
<li>optional â€˜modeâ€™ argument to load and loadfile (to control binary x text)</li>
<li>optional â€˜envâ€™ argument to load and loadfile (environment for loaded chunk)</li>
<li>loadlib may load libraries with global names (RTLD_GLOBAL)</li>
<li>new function package.searchpath</li>
<li>modules receive their paths when loaded</li>
<li>optional base in math.log</li>
<li>optional separator in string.rep</li>
<li>file:write returns file</li>
<li>closing a pipe returns exit status</li>
<li>os.exit may close state</li>
<li>new metamethods __pairs and __ipairs</li>
<li>new option â€˜isrunningâ€™ for collectgarbage and lua_gc</li>
<li>frontier patterns</li>
<li>\0 in patterns</li>
<li>new option *L for io.read</li>
<li>options for io.lines</li>
<li>debug.getlocal can access function varargs</li>
</ul>
<h5 id="C-API-3"><a href="#C-API-3" class="headerlink" title="C API"></a>C API</h5><ul>
<li>main thread predefined in the registry</li>
<li>new functions lua_absindex, lua_arith, lua_compare, lua_copy, lua_len, lua_rawgetp, lua_rawsetp, lua_upvalueid, lua_upvaluejoin, lua_version.</li>
<li>new functions luaL_checkversion, luaL_setmetatable, luaL_testudata, luaL_tolstring.</li>
<li>lua_pushstring and pushlstring return string</li>
<li>nparams and isvararg available in debug API</li>
<li>new lua_Unsigned</li>
</ul>
<h5 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h5><ul>
<li>max constants per function raised to 226</li>
<li>generational mode for garbage collection (experimental)</li>
<li>NaN trick (experimental)</li>
<li>internal (immutable) version of ctypes</li>
<li>simpler implementation for string buffers</li>
<li>parser uses much less C-stack space (no more auto arrays)</li>
</ul>
<h5 id="Lua-standalone-interpreter-1"><a href="#Lua-standalone-interpreter-1" class="headerlink" title="Lua standalone interpreter"></a>Lua standalone interpreter</h5><ul>
<li>new -E option to avoid environment variables</li>
<li>handling of non-string error messages</li>
</ul>
<h2 id="Lua-5-4-ç‰ˆæœ¬æ›´æ–°"><a href="#Lua-5-4-ç‰ˆæœ¬æ›´æ–°" class="headerlink" title="Lua 5.4 ç‰ˆæœ¬æ›´æ–°"></a>Lua 5.4 ç‰ˆæœ¬æ›´æ–°</h2><p>Lua5.4å·²ç»è¿›å…¥rc(Release Candidate)çŠ¶æ€ï¼Œç›¸ä¿¡å¾ˆå¿«å°±ä¼šå‘å¸ƒæ­£å¼ç‰ˆã€‚è¿™ä¸ªç‰ˆæœ¬åœ¨è¯­è¨€å±‚é¢ä¸Šä¿®æ”¹çš„ä¸œè¥¿å¹¶ä¸å¤šï¼Œä½†æ˜¯é»˜è®¤çš„GCè¢«æ¢æˆäº†â€œåˆ†ä»£å¼GCâ€ï¼Œè¿™å¯¹äºé‚£äº›ç»å¸¸äº§ç”ŸçŸ­æœŸå¯¹è±¡çš„ç¨‹åºåº”è¯¥ä¼šæœ‰å¾ˆæ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚GCå¸¦æ¥çš„è´Ÿæ‹…æ°¸è¿œæ˜¯è‡ªåŠ¨å†…å­˜ç®¡ç†è¯­è¨€çš„ä¸€å¤§ç—›ç‚¹ï¼Œå¦‚æœèƒ½åœ¨è¿™ä¸€ç‚¹ä¸Šå–å¾—çªç ´ï¼Œé‚£è‚¯å®šæ¯”æä¾›æ›´å¤šè¯­æ³•ç³–æ¥å¾—æœ‰ä»·å€¼ã€‚</p>
<p>æ­¤å¤–5.4å¯ä»¥æŒ‡å®šå±€éƒ¨å˜é‡çš„å±æ€§ï¼Œç”¨è¿™æ ·çš„è¯­æ³•ï¼š</p>
<p>local a <NAME> &#x3D; 3<br>NAMEå¯ä»¥æ˜¯constæˆ–closeï¼Œä¸ºconstæ—¶è¡¨ç¤ºconstå˜é‡(const variables)ï¼Œconstå˜é‡å¯ä»¥å¸®åŠ©ç¼–è¯‘å™¨ä½œä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ä¸‹é¢çš„ä»£ç ï¼š</p>
<p>local a <const> &#x3D; 4<br>local b &#x3D; a + 7<br>print(b)<br>ç¼–è¯‘å™¨ä¼šæŠŠaæ¶ˆé™¤æ‰ï¼Œç›´æ¥ç»™bèµ‹11ã€‚è¿™ç§ä¼˜åŒ–æ˜¯æœ‰é™çš„ï¼Œå¯¹äºåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼Œèƒ½å¤Ÿæœ‰æ•ˆå‡å°‘å¯„å­˜å™¨çš„è®¿é—®ï¼Œä½†å¯¹äºtableè²Œä¼¼ç›Šå¤„ä¸å¤§ã€‚ä»£ç æ–‡ä»¶å¦‚æœéœ€è¦ä¸€äº›æ•°å€¼å¸¸é‡ï¼Œå¯ä»¥å†™æˆconstå˜é‡ï¼Œæ¯”å¦‚ï¼š</p>
<p>local MAX_LEN <const> &#x3D; 20<br>function check_name(name)<br>    return #name &lt;&#x3D; MAX_LEN<br>end<br>åœ¨check_nameä¸­å°±æ²¡æœ‰upvalueçš„è®¿é—®ï¼Œè€Œæ˜¯ç›´æ¥è½¬æ¢æˆå’Œ20çš„æ¯”è¾ƒã€‚</p>
<p>closeå˜é‡(To-be-closed Variables)éœ€è¦å’Œcloseå…ƒæ–¹æ³•ç»“åˆä½¿ç”¨ï¼Œåœ¨å˜é‡è¶…å‡ºä½œç”¨åŸŸæ—¶ï¼Œä¼šè°ƒç”¨å˜é‡çš„closeå…ƒæ–¹æ³•ï¼Œè¿™å¬èµ·æ¥æ˜¯ä¸æ˜¯æœ‰ç‚¹åƒC++çš„RAIIç”¨æ³•ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<p>local function newlock()<br>    local lock &#x3D; {<br>        acquire &#x3D; function()<br>            print(â€œacquire lockâ€)<br>        end,<br>        release &#x3D; function()<br>            print(â€œrelease lockâ€)<br>        end,<br>    }<br>    return lock<br>end</p>
<p>local function lockguard(lock)<br>    local wrap &#x3D; {<br>        lock &#x3D; lock<br>    }<br>    lock.acquire()<br>    return setmetatable(wrap, {__close &#x3D; function(t, err)<br>        t.lock.release()<br>    end})<br>end</p>
<p>local lock &#x3D; newlock()<br>do<br>    for i &#x3D; 1, 3 do<br>        local l <close> &#x3D; lockguard(lock)<br>        print(i)<br>        error(â€œerrâ€)<br>    end<br>end<br>å®šä¹‰local l <close>åï¼Œæ— è®ºæ˜¯å¦æœ‰é”™è¯¯ï¼Œreleaseéƒ½èƒ½å¾—åˆ°è°ƒç”¨ï¼›ä»è¿™ä¸ªä¾‹å­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œcloseå˜é‡ä¸€èˆ¬ç”¨äºéœ€è¦åŠæ—¶é‡Šæ”¾èµ„æºçš„æƒ…å†µï¼›å¦åˆ™Luaçš„GCå¯ä»¥åº”ä»˜å¤§å¤šæ•°æƒ…å†µã€‚</p>
<p>é™¤äº†ä¸Šé¢æåˆ°çš„ç‰¹æ€§ï¼Œè¿˜æœ‰ä¸€äº›æ–°çš„ä¿®æ”¹ç½—åˆ—å¦‚ä¸‹ï¼š</p>
<p>userdataç°åœ¨å¯ä»¥å…³è”å¤šä¸ªuserå€¼ï¼ŒCçš„APIä¹Ÿæœ‰ç›¸åº”çš„ä¿®æ”¹ï¼Œå¦‚æœæˆ‘ä»¬æ–°å»ºçš„userdataæ²¡æœ‰å…³è”å€¼ï¼Œåˆ™å°½é‡ä½¿ç”¨lua_newuserdatauvï¼Œè¿™æ ·æ›´é«˜æ•ˆï¼Œlua_newuserdataä»…ä»…ä¸ºäº†å…¼å®¹ï¼Œä¸”é»˜è®¤ä¼šå…³è”1ä¸ªå€¼ã€‚<br>math.randomä½¿ç”¨äº†æ–°çš„ç®—æ³•ã€‚<br>åç¨‹åº“æä¾›äº†æ–°çš„APIcoroutine.closeå’Œlua_resetthreadï¼Œcoroutine.closeåªèƒ½åœ¨æŒ‚èµ·æˆ–æ­»äº¡çŠ¶æ€ä¸‹è°ƒç”¨ï¼ŒæŒ‚èµ·çŠ¶æ€ä¸‹ä¼šä½¿ç”¨åç¨‹è¿›å…¥æ­»äº¡çŠ¶æ€ï¼Œå¹¶ä¸”å…³é—­æ‰€æœ‰çš„closeå˜é‡ã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://zirpon.github.io">ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://zirpon.github.io" target="_blank">ZepungğŸ‰Blog</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/lua/">lua</a></div><div class="post-share"><div class="social-share" data-image="/img/404-bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2019/03/04/Golang-%E6%BA%90%E7%A0%81-CentOS-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-note/" title="Golang æºç ç¼–è¯‘å®‰è£… CentOS 7 note"><img class="cover" src="/img/header_img/tag-bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">Golang æºç ç¼–è¯‘å®‰è£… CentOS 7 note</div></div><div class="info-2"><div class="info-item-1">1. Prefix éœ€è¦ä¸‹è½½çš„æ–‡ä»¶: Download  go1.12.src.tar.gz go1.4.3.src.tar.gz gcc glibc-devel   go1.4ä»¥ä¸Šç‰ˆæœ¬å®‰è£… ä¾èµ– go1.4 éœ€è¦å…ˆç¼–è¯‘å®‰è£…go1.4, å¦åˆ™ä¼šæŠ¥é”™ (è¿™ä¸ªè®¾å®š å¾ˆå¥‡æ€ª ä¸è¿‡ never mind just do it) æŠ¥é”™æç¤ºä¿¡æ¯å¦‚ä¸‹:  123Building Go cmd/dist using /root/go1.4.ERROR: Cannot find /root/go1.4/bin/go.Set $GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4. å®‰è£… gcc ç”¨äºç¼–è¯‘ go 1.4 1yum install -y gcc glibc-devel  2. Install go1.4.3.src.tar.gz2.1 å®‰è£… go1.4.31234mkdir /root/go1.4tar -xvf go1.4.3.src.tar.gz -C /root/go1.4cd...</div></div></div></a><a class="pagination-related" href="/2021/01/06/%E5%81%A5%E8%BA%AB%E7%AC%94%E8%AE%B0/" title="å¥èº«ç¬”è®°"><img class="cover" src="/img/header_img/roman.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">å¥èº«ç¬”è®°</div></div><div class="info-2"><div class="info-item-1"> èƒ¸ï¼š é£é¸Ÿ æ¨ä¸¾ ä¿¯å§æ’‘èƒŒï¼š å“‘é“ƒå•è‡‚åˆ’èˆ¹ å¼•ä½“å‘ä¸Š æ‚¬æŒ‚å¸¦åå‘åˆ’èˆ¹ ä¿¯å§æ’‘ è®©èƒŒéƒ¨ä¸¤å—è‚Œè‚‰å¤¹ç´§çš„åŠ¨ä½œè‚©ï¼š è‚©æ¨ ä¾§å¹³ä¸¾ é¢æ‹‰ è€¸è‚©è…¿ï¼š åªèƒ½æ·±è¹² é«˜ä½è‡€æ¡¥è‡‚ï¼šè‡‚å±ˆä¼¸ äºŒå¤´å¼¯ä¸¾ ä¸‰å¤´æ‹‰ä¼¸(æ‰¶å¢™æ‹¿æ°´ç“¶å‘åæ‹‰ä¼¸) å•ä¸ªæ°´ç“¶1.1kg ä¸åŠ›ç«­æ¢ å¤§æ°´ç“¶æˆ–è€…å“‘é“ƒ    èƒ¸ èƒŒ è‚© è…¿ æ‰‹è‡‚                                                     ...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Begin"><span class="toc-text">1. Begin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-chunk"><span class="toc-text">1.1 chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-lua-command-line"><span class="toc-text">1.4 lua command line</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-lua-basic-type"><span class="toc-text">2. lua basic type</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-string"><span class="toc-text">2.4 string</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Function"><span class="toc-text">2.5 Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Userdata-and-Threads"><span class="toc-text">2.6 Userdata and Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-expression-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">3. expression è¡¨è¾¾å¼</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Relational-operators"><span class="toc-text">3.2 Relational operators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-logical-operator-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">3.3 logical operator é€»è¾‘è¿ç®—ç¬¦</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-operator-priority-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">3.5 operator priority ä¼˜å…ˆçº§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-table-constructor-%E8%A1%A8%E7%9A%84%E6%9E%84%E9%80%A0"><span class="toc-text">3.6 table constructor è¡¨çš„æ„é€ </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-basic-syntax-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">4. basic syntax åŸºæœ¬è¯­æ³•</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-local-variable-code-block-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F-%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-text">4.2  local variable &amp; code block å±€éƒ¨å˜é‡ ä»£ç å—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-break-return"><span class="toc-text">4.3 break return</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-function"><span class="toc-text">5. function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-multi-result-return"><span class="toc-text">5.1 multi result return</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-variable-parameter-%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="toc-text">5.2 variable parameter å¯å˜å‚æ•°</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-named-parameter-%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0"><span class="toc-text">5.3 named parameter å‘½åå‚æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-function-plus-%E5%86%8D%E8%AE%BA%E5%87%BD%E6%95%B0"><span class="toc-text">6. function plus å†è®ºå‡½æ•°</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-proper-tail-calls-%E5%B0%BE%E8%B0%83%E7%94%A8"><span class="toc-text">6.3 proper tail calls å°¾è°ƒç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-iterator-genericity-for-%E8%BF%AD%E4%BB%A3%E5%99%A8-%E6%B3%9B%E5%9E%8Bfor"><span class="toc-text">7. iterator &amp; genericity for è¿­ä»£å™¨ æ³›å‹for</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-genericity-for-%E6%B3%9B%E5%9E%8B-for-%E7%9A%84%E8%AF%AD%E4%B9%89"><span class="toc-text">7.2 genericity for æ³›å‹ for çš„è¯­ä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-iterator-without-status-%E6%97%A0%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">7.3 iterator without status æ— çŠ¶æ€çš„è¿­ä»£å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-multi-status-iterator-%E5%A4%9A%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">7.3 multi status iterator å¤šçŠ¶æ€çš„è¿­ä»£å™¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-compile-run-debug-%E7%BC%96%E8%AF%91-%E8%BF%90%E8%A1%8C-%E8%B0%83%E8%AF%95"><span class="toc-text">8. compile run debug ç¼–è¯‘ è¿è¡Œ è°ƒè¯•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-require"><span class="toc-text">8.1 require</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-C-Packages"><span class="toc-text">8.2 C Packages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-error-%E9%94%99%E8%AF%AF"><span class="toc-text">8.3 error é”™è¯¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-exception-pcall"><span class="toc-text">8.4 exception &amp; pcall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-exception-msg-xpcall"><span class="toc-text">8.5 exception msg &amp; xpcall</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-0-coroutine"><span class="toc-text">9.0 coroutine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-filter-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">9.2 filter è¿‡æ»¤å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-iterator-%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">9.3 iterator è¿­ä»£å™¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-pre-emptive-multi-thread-%E9%9D%9E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">9.4 pre-emptive multi thread éæŠ¢å å¼å¤šçº¿ç¨‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-datastruct"><span class="toc-text">11. datastruct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-array-%E6%95%B0%E7%BB%84"><span class="toc-text">11.1 array æ•°ç»„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-matrix-multidimensional-array-%E9%98%B5-%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84"><span class="toc-text">11.2 matrix &amp; multidimensional array é˜µ å¤šç»´æ•°ç»„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-linked-list-s%E9%93%BE%E8%A1%A8"><span class="toc-text">11.3 linked list sé“¾è¡¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-queen-dique-s%E9%98%9F%E5%88%97-%E5%8F%8C%E7%AB%AF%E9%98%9F%E5%88%97"><span class="toc-text">11.4 queen &amp; dique sé˜Ÿåˆ— åŒç«¯é˜Ÿåˆ—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-set-package-%E9%9B%86%E5%90%88-%E5%8C%85"><span class="toc-text">11.5 set &amp; package é›†åˆ åŒ…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-6-string-buffer-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%93%E5%86%B2"><span class="toc-text">11.6 string buffer å­—ç¬¦ä¸²ç¼“å†²</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-data-file-storage-Persistence-%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">12. data file storage &amp; Persistence æ•°æ®æ–‡ä»¶ä¸æŒä¹…åŒ–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-metatables-metamethods"><span class="toc-text">13. metatables metamethods</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-arithmetic-operation-metamethods-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%9A%84-matamethods"><span class="toc-text">13.1  arithmetic operation metamethods ç®—æœ¯è¿ç®—çš„ matamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-relational-operation-metamethods-%E5%85%B3%E7%B3%BB%E8%BF%90%E7%AE%97%E7%9A%84-metamethods"><span class="toc-text">13.2 relational operation metamethods å…³ç³»è¿ç®—çš„ metamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-others-metamethods"><span class="toc-text">13.3 others metamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-table-relative-metamethods-%E8%A1%A8%E7%9B%B8%E5%85%B3-metamethods"><span class="toc-text">13.4 table relative metamethods è¡¨ç›¸å…³ metamethods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-1-The-index-Metamethod"><span class="toc-text">13.4.1 The __index Metamethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-2-The-newindex-Metamethod"><span class="toc-text">13.4.2 The __newindex Metamethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-3-table-default-value-%E6%9C%89%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9A%84%E8%A1%A8"><span class="toc-text">13.4.3 table default value æœ‰é»˜è®¤å€¼çš„è¡¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-4-table-monitor-%E7%9B%91%E6%8E%A7%E8%A1%A8"><span class="toc-text">13.4.4 table monitor ç›‘æ§è¡¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-5-readonly-table-%E5%8F%AA%E8%AF%BB%E8%A1%A8"><span class="toc-text">13.4.5 readonly table åªè¯»è¡¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-environment-%E7%8E%AF%E5%A2%83"><span class="toc-text">14. environment ç¯å¢ƒ</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-dynamic-access-global-value-%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E5%90%8D%E5%AD%97%E8%AE%BF%E9%97%AE%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">14.1 dynamic access global value ä½¿ç”¨åŠ¨æ€åå­—è®¿é—®å…¨å±€å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-delcare-global-value-%E5%A3%B0%E6%98%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">14.2 delcare global value å£°æ˜å…¨å±€å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-un-global-environment-%E9%9D%9E%E5%85%A8%E5%B1%80%E7%9A%84%E7%8E%AF%E5%A2%83"><span class="toc-text">14.3 un-global environment éå…¨å±€çš„ç¯å¢ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-package"><span class="toc-text">15 package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-package-file"><span class="toc-text">15.3 package &amp; file</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-object-oriented-programming-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1"><span class="toc-text">16 object-oriented programming é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-3-multiple-inheritance-%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF"><span class="toc-text">16.3 multiple inheritance å¤šé‡ç»§æ‰¿</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-4-private-%E7%A7%81%E6%9C%89%E6%80%A7"><span class="toc-text">16.4 private ç§æœ‰æ€§</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-5-Single-Method-%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-text">16.5 Single-Method çš„å¯¹è±¡å®ç°æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-weak-table"><span class="toc-text">17 weak table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17-1-%E8%AE%B0%E5%BF%86%E5%87%BD%E6%95%B0"><span class="toc-text">17.1 è®°å¿†å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-%E6%95%B0%E5%AD%A6%E5%BA%93"><span class="toc-text">18. æ•°å­¦åº“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-table-lib"><span class="toc-text">19. table lib</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-string-lib"><span class="toc-text">20 string lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-1-pattern-matching-%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="toc-text">20.1 pattern matching æ¨¡å¼åŒ¹é…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-2-pattern-%E6%A8%A1%E5%BC%8F"><span class="toc-text">20.2 pattern æ¨¡å¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-3-matchings-%E6%8D%95%E8%8E%B7"><span class="toc-text">20.3 matchings æ•è·</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-IO-lib"><span class="toc-text">21. IO lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-1-simple-I-O-mode"><span class="toc-text">21.1 simple I&#x2F;O mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-2-complete-I-O-mode"><span class="toc-text">21.2 complete I&#x2F;O mode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-system-lib-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%BA%93"><span class="toc-text">22 system lib æ“ä½œç³»ç»Ÿåº“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-debug-lib"><span class="toc-text">23. debug lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#23-2-hooks"><span class="toc-text">23.2 hooks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-C-API-Overview"><span class="toc-text">24. C API Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-C-API-exception-handler"><span class="toc-text">24.3 C API exception handler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-invoking-lua-function"><span class="toc-text">25. invoking lua function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-invoking-C-function"><span class="toc-text">26. invoking C function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#28-user-defined-types-in-C"><span class="toc-text">28. user-defined types in C</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#29-resource-managerment-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-text">29. resource managerment èµ„æºç®¡ç†</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-text">Lua ç‰ˆæœ¬æ›´æ–°è®°å½•</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E7%89%88"><span class="toc-text">ä¸­æ–‡ç‰ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-3-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">è‡ª Lua 5.3 ä»¥æ¥çš„å˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96"><span class="toc-text">ä¸»è¦å˜åŒ–</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-2-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">è‡ª Lua 5.2 ä»¥æ¥çš„å˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96-1"><span class="toc-text">ä¸»è¦å˜åŒ–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80"><span class="toc-text">è¯­è¨€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93"><span class="toc-text">åº“</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-%E7%8B%AC%E7%AB%8B%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="toc-text">Lua ç‹¬ç«‹è§£é‡Šå™¨</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-1-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">è‡ª Lua 5.1 ä»¥æ¥çš„å˜åŒ–</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96-2"><span class="toc-text">ä¸»è¦å˜åŒ–</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80-1"><span class="toc-text">è¯­è¨€</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93-1"><span class="toc-text">åº“</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-1"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">å®ç°</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-%E7%8B%AC%E7%AB%8B%E8%A7%A3%E9%87%8A%E5%99%A8-1"><span class="toc-text">Lua ç‹¬ç«‹è§£é‡Šå™¨</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8B%B1%E6%96%87%E5%8E%9F%E7%89%88"><span class="toc-text">è‹±æ–‡åŸç‰ˆ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-3"><span class="toc-text">Changes since Lua 5.3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes"><span class="toc-text">Main changes</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-2"><span class="toc-text">Changes since Lua 5.2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes-1"><span class="toc-text">Main changes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Language"><span class="toc-text">Language</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Libraries"><span class="toc-text">Libraries</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-2"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-standalone-interpreter"><span class="toc-text">Lua standalone interpreter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-1"><span class="toc-text">Changes since Lua 5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes-2"><span class="toc-text">Main changes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Language-1"><span class="toc-text">Language</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Libraries-1"><span class="toc-text">Libraries</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-3"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Implementation"><span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-standalone-interpreter-1"><span class="toc-text">Lua standalone interpreter</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-5-4-%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0"><span class="toc-text">Lua 5.4 ç‰ˆæœ¬æ›´æ–°</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By ãƒãƒ£ãƒ³ ã‚¼ãƒ—ãƒ³</div><div class="framework-info"><span>æ¡†æ¶ </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>ä¸»é¢˜ </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  æ•°æ®åŠ è½½ä¸­</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="æœç´¢æ–‡ç« " type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>