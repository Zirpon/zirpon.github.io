<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Lua 5.0 ~ 5.4 学习笔记 | Zepung🐉Blog</title><meta name="author" content="チャン ゼプン"><meta name="copyright" content="チャン ゼプン"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1. Begin1.1 chunkChunk 是一系列语句，Lua 执行的每一块语句，比如一个文件或者交互模式下的每一行都是一个 Chunk。每个语句结尾的分号（;）是可选的，但如果同一行有多个语句最好用；分开(but valid)Chunk可以很大，在 Lua 中几个 MByte 的 Chunk 是很常见的 交互模式下 键入文件结束符可以退出交互模式（Ctrl-D in Unix, Ctrl-Z">
<meta property="og:type" content="article">
<meta property="og:title" content="Lua 5.0 ~ 5.4 学习笔记">
<meta property="og:url" content="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Zepung🐉Blog">
<meta property="og:description" content="1. Begin1.1 chunkChunk 是一系列语句，Lua 执行的每一块语句，比如一个文件或者交互模式下的每一行都是一个 Chunk。每个语句结尾的分号（;）是可选的，但如果同一行有多个语句最好用；分开(but valid)Chunk可以很大，在 Lua 中几个 MByte 的 Chunk 是很常见的 交互模式下 键入文件结束符可以退出交互模式（Ctrl-D in Unix, Ctrl-Z">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://zirpon.github.io/img/404-bg.jpg">
<meta property="article:published_time" content="2019-04-06T07:32:12.000Z">
<meta property="article:modified_time" content="2025-03-17T04:04:45.766Z">
<meta property="article:author" content="チャン ゼプン">
<meta property="article:tag" content="lua">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://zirpon.github.io/img/404-bg.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Lua 5.0 ~ 5.4 学习笔记",
  "url": "https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/",
  "image": "https://zirpon.github.io/img/404-bg.jpg",
  "datePublished": "2019-04-06T07:32:12.000Z",
  "dateModified": "2025-03-17T04:04:45.766Z",
  "author": [
    {
      "@type": "Person",
      "name": "チャン ゼプン",
      "url": "https://zirpon.github.io/"
    }
  ]
}</script><link rel="shortcut icon" href="/img/timg.jpeg"><link rel="canonical" href="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":-1,"unescape":false,"languages":{"hits_empty":"未找到符合您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"已切换为繁体中文","cht_to_chs":"已切换为简体中文","day_to_night":"已切换为深色模式","night_to_day":"已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Lua 5.0 ~ 5.4 学习笔记',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background: linear-gradient(20deg, #0062be, #925696, #cc426e, #fb0347);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/IMG_5015.JPG" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">26</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">70</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/404-bg.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><img class="site-icon" src="/img/timg.jpeg" alt="Logo"><span class="site-name">Zepung🐉Blog</span></a><a class="nav-page-title" href="/"><span class="site-name">Lua 5.0 ~ 5.4 学习笔记</span></a></span><div id="menus"><div id="search-button"><span class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></span></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">Lua 5.0 ~ 5.4 学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2019-04-06T07:32:12.000Z" title="发表于 2019-04-06 15:32:12">2019-04-06</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-03-17T04:04:45.766Z" title="更新于 2025-03-17 12:04:45">2025-03-17</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">17.5k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>75分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="1-Begin"><a href="#1-Begin" class="headerlink" title="1. Begin"></a>1. Begin</h2><h3 id="1-1-chunk"><a href="#1-1-chunk" class="headerlink" title="1.1 chunk"></a>1.1 chunk</h3><p>Chunk 是一系列语句，Lua 执行的每一<strong>块</strong>语句，比如<strong>一个文件</strong>或者<strong>交互模式</strong>下的<em>每一行</em>都是一个 Chunk。<br>每个语句结尾的分号（;）是可选的，但如果同一行有多个语句最好用；分开(but valid)<br>Chunk可以很大，在 Lua 中几个 MByte 的 Chunk 是很常见的</p>
<p>交互模式下 键入文件结束符可以退出交互模式（Ctrl-D in Unix, Ctrl-Z in DOS&#x2F;Windows），或者调用 OS 库的 os.exit()函数也可以退出</p>
<blockquote>
<p>prompt&gt; lua -la -lb</p>
</blockquote>
<p>命令首先在一个 Chunk 内先运行 a 然后运行 b。（注意：-l 选项会调用 require，将会在指定的目录下搜索文件，如果环境变量没有设好，上面的命令可能不能正确运行。)</p>
<blockquote>
<p>lua -i -la -lb</p>
</blockquote>
<p>将在一个 Chunk 内先运行 a 然后运行 b，最后直接进入交互模式</p>
<p>最好不要使用下划线加大写字母的标示符，因为 Lua 的保留字也是这样的。</p>
<h3 id="1-4-lua-command-line"><a href="#1-4-lua-command-line" class="headerlink" title="1.4 lua command line"></a>1.4 lua command line</h3><ul>
<li><p>-e：直接将命令传入 Lua</p>
<blockquote>
<p>prompt&gt; lua -e “print(math.sin(12))” –&gt; -0.53657291800043</p>
</blockquote>
</li>
<li><p>-l：加载一个文件.</p>
</li>
<li><p>-i：进入交互模式.<br>  _PROMPT 内置变量作为交互模式的提示符</p>
<blockquote>
<p>prompt&gt; lua -i -e “_PROMPT&#x3D;’ lua&gt; ‘“<br>lua&gt;</p>
</blockquote>
</li>
</ul>
<p>Lua 的运行过程，在运行参数之前，Lua 会查找环境变量 <code>LUA_INIT</code> 的值，</p>
<ul>
<li>如果变量存在并且<code>值</code>为<code>@filename</code>，Lua 将<strong>加载</strong>指定文件。</li>
<li>如果变量存在但<code>不是以@开头</code>，Lua假定 filename 为 Lua 代码文件并且<strong>运行</strong>他。</li>
</ul>
<p>全局变量 <code>arg</code> 存放 Lua 的命令行参数。在运行以前，Lua 使用所有参数构造 arg 表。</p>
<ul>
<li>脚本名索引为 0，</li>
<li>脚本的参数从 1 开始增加。</li>
<li>脚本前面的参数从-1 开始减少</li>
</ul>
<blockquote>
<p>prompt&gt; lua -e “sin&#x3D;math.sin” script a b<br>arg 表如下：</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">arg</span>[<span class="number">-3</span>] = <span class="string">&quot;lua&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-2</span>] = <span class="string">&quot;-e&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">-1</span>] = <span class="string">&quot;sin=math.sin&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">0</span>] = <span class="string">&quot;script&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">1</span>] = <span class="string">&quot;a&quot;</span></span><br><span class="line"><span class="built_in">arg</span>[<span class="number">2</span>] = <span class="string">&quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="2-lua-basic-type"><a href="#2-lua-basic-type" class="headerlink" title="2. lua basic type"></a>2. lua basic type</h2><p>Lua 是动态类型语言，变量不要类型定义。<br>Lua 中有8 个基本类型分别为：<code>nil、boolean、number、string、userdata、function、thread 和 table</code>。<br>函数 <code>type</code> 可以测试给定变量或者值的类型。</p>
<p>在控制结构的条件中除了 <code>false</code> 和 <code>nil</code> 为假，其他值都为真。<br>所以 Lua 认为 <code>0</code> 和<code>空串</code>都是真。</p>
<p><code>number</code>表示实数，Lua 中没有整数。</p>
<p>note: <em><strong>一般有个错误的看法 CPU 运算浮点数比整数慢。事实不是如此，用实数代替整数不会有什么误差（除非数字大于 100,000,000,000,000）。</strong></em><br>Lua的 numbers 可以处理任何长整数不用担心误差。</p>
<p>note: 你也可以在编译 <code>Lua</code> 的时候使用长整型或者<code>单精度浮点型</code>代替 numbers，在一些平台硬件<code>不支持浮点数</code>的情况下这个特性是非常有用的，具体的情况请参考 Lua 发布版所附的详细说明。</p>
<h3 id="2-4-string"><a href="#2-4-string" class="headerlink" title="2.4 string"></a>2.4 string</h3><p>字符的序列, lua 是 8 位字节，所以字符串可以包含任何数值字符，包括嵌入的 0。<br>这意味着你可以存储任意的二进制数据在一个字符串里。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="string">&quot;one string&quot;</span></span><br><span class="line">b = <span class="built_in">string</span>.<span class="built_in">gsub</span>(a, <span class="string">&quot;one&quot;</span>, <span class="string">&quot;another&quot;</span>) <span class="comment">-- change string parts</span></span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; one string</span></span><br><span class="line"><span class="built_in">print</span>(b) <span class="comment">--&gt; another string</span></span><br></pre></td></tr></table></figure>

<p>Lua 可以高效的处理长字符串，<code>1M</code> 的 string 在 Lua 中是很常见的。可以使用<code>单引号</code>或者<code>双引号</code>表示字符串</p>
<p>还可以在字符串中使用\ddd（ddd 为三位十进制数字）方式表示字母。</p>
<blockquote>
<p>“alo\n123&quot;“<br>‘\97lo\10\04923”‘<br>是相同的</p>
</blockquote>
<p>还可以使用<code>[[...]]</code>表示字符串。<br>这种形式的字符串可以包含<code>多行</code>也，可以嵌套且<code>不会解释转义序列</code>，如果<code>第一个字符</code>是<code>换行符</code>会被自动<strong>忽略</strong>掉。</p>
<p>种形式的字符串用来包含一段代码是非常方便的。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">page = <span class="string">[[</span></span><br><span class="line"><span class="string">&lt;HTML&gt;</span></span><br><span class="line"><span class="string">&lt;HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;TITLE&gt;An HTML Page&lt;/TITLE&gt;</span></span><br><span class="line"><span class="string">&lt;/HEAD&gt;</span></span><br><span class="line"><span class="string">&lt;BODY&gt;</span></span><br><span class="line"><span class="string">Lua</span></span><br><span class="line"><span class="string">[[a text between double brackets]]</span></span><br><span class="line"><span class="string">&lt;/BODY&gt;</span></span><br><span class="line"><span class="string">&lt;/HTML&gt;</span></span><br><span class="line"><span class="string">]]</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(page)</span><br></pre></td></tr></table></figure>

<p>运行时，Lua 会自动在 string 和 numbers 之间自动进行类型转换，当一个字符串使<br>用算术操作符时，string 就会被转成数字。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">&quot;10&quot;</span> + <span class="number">1</span>) <span class="comment">--&gt; 11</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;10 + 1&quot;</span>) <span class="comment">--&gt; 10 + 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;-5.3e - 10&quot;</span> * <span class="string">&quot;2&quot;</span>) <span class="comment">--&gt; -1.06e-09</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;hello&quot;</span> + <span class="number">1</span>) <span class="comment">-- ERROR (cannot convert &quot;hello&quot;)</span></span><br></pre></td></tr></table></figure>

<p><code>..</code>在 Lua 中是字符串连接符，当在一个<code>数字</code>后面写<code>..</code>时，必须<code>加上空格</code>以防止被解释错</p>
<p>显式将 string 转成数字可以使用函数 <code>tonumber()</code>，如果 string 不是正确的数字该函数将返回 <code>nil</code>。</p>
<p>可以调用<code>tostring()</code>将数字转成字符串，这种转换一直有效</p>
<h3 id="2-5-Function"><a href="#2-5-Function" class="headerlink" title="2.5 Function"></a>2.5 Function</h3><p>函数是<code>第一类值</code>（和其他变量相同），意味着</p>
<ul>
<li>函数可以存储在变量中，</li>
<li>可以作为函数的参数，</li>
<li>也可以作为函数的返回值。</li>
</ul>
<h3 id="2-6-Userdata-and-Threads"><a href="#2-6-Userdata-and-Threads" class="headerlink" title="2.6 Userdata and Threads"></a>2.6 Userdata and Threads</h3><ul>
<li>userdata 可以将 C 数据存放在 Lua 变量中，</li>
<li>userdata 在 Lua 中预定义操作<code>赋值</code>和<code>相等比较</code></li>
</ul>
<h2 id="3-expression-表达式"><a href="#3-expression-表达式" class="headerlink" title="3. expression 表达式"></a>3. expression 表达式</h2><h3 id="3-2-Relational-operators"><a href="#3-2-Relational-operators" class="headerlink" title="3.2 Relational operators"></a>3.2 Relational operators</h3><p>关系运算符</p>
<blockquote>
<p>&lt; &gt; &lt;&#x3D; &gt;&#x3D; &#x3D;&#x3D; ~&#x3D;</p>
</blockquote>
<ul>
<li>Lua 通过<code>引用</code>比较<code>tables、userdata、functions</code>。也就是说当且仅当两者表示同一个对象时相等。</li>
<li>Lua 比较数字按传统的数字大小进行，</li>
<li>比较字符串按字母的顺序进行，但是字母顺序依赖于本地环境</li>
</ul>
<h3 id="3-3-logical-operator-逻辑运算符"><a href="#3-3-logical-operator-逻辑运算符" class="headerlink" title="3.3 logical operator 逻辑运算符"></a>3.3 logical operator 逻辑运算符</h3><blockquote>
<p>and or not</p>
</blockquote>
<p>一个很实用的技巧：如果 x 为 false 或者 nil 则给 x 赋初始值 v</p>
<blockquote>
<p>x &#x3D; x or v</p>
</blockquote>
<p>C 语言中的三元运算符</p>
<blockquote>
<p>(a and b) or c &#x3D;&#x3D;&gt; a ? b : c</p>
</blockquote>
<h3 id="3-5-operator-priority-优先级"><a href="#3-5-operator-priority-优先级" class="headerlink" title="3.5 operator priority 优先级"></a>3.5 operator priority 优先级</h3><p>从高到低的顺序：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">^</span><br><span class="line"><span class="keyword">not</span> - (unary)</span><br><span class="line">* /</span><br><span class="line">+ -</span><br><span class="line">..</span><br><span class="line">&lt; &gt; &lt;= &gt;= ~= ==</span><br><span class="line"><span class="keyword">and</span></span><br><span class="line"><span class="keyword">or</span></span><br></pre></td></tr></table></figure>

<p>除了^和..外所有的二元运算符都是<code>左连接</code>的。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a+i &lt; b/<span class="number">2</span>+<span class="number">1</span> &lt;<span class="comment">--&gt; (a+i) &lt; ((b/2)+1)</span></span><br><span class="line"><span class="number">5</span>+x^<span class="number">2</span>*<span class="number">8</span> &lt;<span class="comment">--&gt; 5+((x^2)*8)</span></span><br><span class="line">a &lt; y <span class="keyword">and</span> y &lt;= z &lt;<span class="comment">--&gt; (a &lt; y) and (y &lt;= z)</span></span><br><span class="line">-x^<span class="number">2</span> &lt;<span class="comment">--&gt; -(x^2)</span></span><br><span class="line">x^y^z &lt;<span class="comment">--&gt; x^(y^z)</span></span><br></pre></td></tr></table></figure>

<h3 id="3-6-table-constructor-表的构造"><a href="#3-6-table-constructor-表的构造" class="headerlink" title="3.6 table constructor 表的构造"></a>3.6 table constructor 表的构造</h3><p>最简单的构造函数是<code>&#123;&#125;</code>，用来创建一个<code>空表</code>。</p>
<p>使用 table 构造一个 list：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list = <span class="literal">nil</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line"> list = &#123;<span class="built_in">next</span>=list, value=line&#125;</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>嵌套构造函数</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">polyline = &#123;color=<span class="string">&quot;blue&quot;</span>, thickness=<span class="number">2</span>, npoints=<span class="number">4</span>,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">0</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">-10</span>, y=<span class="number">1</span>&#125;,</span><br><span class="line"> &#123;x=<span class="number">0</span>, y=<span class="number">1</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>不能使用负索引初始化一个表中元素，</li>
<li>字符串索引也不能被恰当的表示。</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">opnames = &#123;</span><br><span class="line">    [<span class="string">&quot;+&quot;</span>] = <span class="string">&quot;add&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;-&quot;</span>] = <span class="string">&quot;sub&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;*&quot;</span>] = <span class="string">&quot;mul&quot;</span>,</span><br><span class="line">    [<span class="string">&quot;/&quot;</span>] = <span class="string">&quot;div&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i = <span class="number">20</span>; s = <span class="string">&quot;-&quot;</span></span><br><span class="line">a = &#123;[i+<span class="number">0</span>] = s, [i+<span class="number">1</span>] = s..s, [i+<span class="number">2</span>] = s..s..s,&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(opnames[s]) <span class="comment">--&gt; sub</span></span><br><span class="line"><span class="built_in">print</span>(a[<span class="number">22</span>]) <span class="comment">--&gt; ---</span></span><br></pre></td></tr></table></figure>

<ul>
<li>注意：不推荐数组下标<code>从 0 开始</code>，否则<code>很多标准库不能使用</code>。</li>
<li>在构造函数的<code>最后的</code>“,”是可选的，可以方便以后的扩展。</li>
<li>在构造函数中域分隔符逗号（”,”）可以用分号（”;”）替代，通常我们使用分号用来分割不同类型的表元素。</li>
</ul>
<p>如果真的想要数组下标从 0 开始：</p>
<blockquote>
<p>days &#x3D; {[0]&#x3D;”Sunday”, “Monday”, “Tuesday”, “Wednesday”, “Thursday”, “Friday”, “Saturday”}<br>{x&#x3D;10, y&#x3D;45; “one”, “two”, “three”}</p>
</blockquote>
<h3 id="4-basic-syntax-基本语法"><a href="#4-basic-syntax-基本语法" class="headerlink" title="4. basic syntax 基本语法"></a>4. basic syntax 基本语法</h3><blockquote>
<p>a, b &#x3D; 10, 2<em>x &lt;–&gt; a&#x3D;10; b&#x3D;2</em>x</p>
</blockquote>
<p>遇到赋值语句 Lua 会先计算右边所有的值然后再执行赋值操作，所以我们可以这样<br>进行交换变量的值：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x, y = y, x <span class="comment">-- swap &#x27;x&#x27; for &#x27;y&#x27;</span></span><br><span class="line">a[i], a[j] = a[j], a[i] <span class="comment">-- swap &#x27;a[i]&#x27; for &#x27;a[i]&#x27;</span></span><br></pre></td></tr></table></figure>

<p>当变量个数和值的个数不一致时，Lua 会一直以变量个数为基础采取以下策略：</p>
<ul>
<li>a. 变量个数&gt;值的个数 按变量个数补足 nil</li>
<li>b. 变量个数&lt;值的个数 多余的值会被忽略</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a, b, c = <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 1 nil</span></span><br><span class="line">a, b = a+<span class="number">1</span>, b+<span class="number">1</span>, b+<span class="number">2</span> <span class="comment">-- value of b+2 is ignored</span></span><br><span class="line"><span class="built_in">print</span>(a,b) <span class="comment">--&gt; 1 2</span></span><br><span class="line">a, b, c = <span class="number">0</span></span><br><span class="line"><span class="built_in">print</span>(a,b,c) <span class="comment">--&gt; 0 nil nil</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-local-variable-code-block-局部变量-代码块"><a href="#4-2-local-variable-code-block-局部变量-代码块" class="headerlink" title="4.2  local variable &amp; code block 局部变量 代码块"></a>4.2  local variable &amp; code block 局部变量 代码块</h3><p>使用 <code>local</code> 创建一个局部变量，与全局变量不同，局部变量只在被声明的那个代码块内有效。代码块：指一个<code>控制结构</code>内，一个<code>函数体</code>，或者一个 <code>chunk</code>（变量被声明的那个文件或者文本串）</p>
<p>应该尽可能的使用局部变量，有两个好处：</p>
<ol>
<li>避免命名冲突</li>
<li>访问局部变量的速度比全局变量更快.</li>
</ol>
<blockquote>
<p>do … end</p>
</blockquote>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">elseif</span> conditions <span class="keyword">then</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> condition <span class="keyword">do</span></span><br><span class="line">    statements</span><br><span class="line"><span class="keyword">end</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">repeat</span></span><br><span class="line">    statements;</span><br><span class="line"><span class="keyword">until</span> conditions;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 数值 for 循环:</span></span><br><span class="line"><span class="keyword">for</span> var=exp1,exp2,exp3 <span class="keyword">do</span></span><br><span class="line">    loop-part</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 范型 for 循环：</span></span><br><span class="line"><span class="comment">-- print all values of array &#x27;a&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span> <span class="built_in">print</span>(k) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="4-3-break-return"><a href="#4-3-break-return" class="headerlink" title="4.3 break return"></a>4.3 break return</h3><p>有时候为了调试或者其他目的需要在 block 的中间使用 return 或者 break，可以显式的使用 do..end 来实现：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">--&lt;&lt; SYNTAX ERROR</span></span><br><span class="line">    <span class="comment">-- &#x27;return&#x27; is the last statement in the next block</span></span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">return</span> <span class="keyword">end</span> <span class="comment">-- OK</span></span><br><span class="line">    ... <span class="comment">-- statements not reached</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="5-function"><a href="#5-function" class="headerlink" title="5. function"></a>5. function</h2><p>调用函数的时候，如果参数列表为空，必须使用()表明是函数调用。</p>
<p>当函数<code>只有一个参数</code>并且这个参数是<code>字符串</code>或者<code>表构造</code>的时候，()是可选的：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">&quot;Hello World&quot;</span>     <span class="comment">--&gt; print(&quot;Hello World&quot;)</span></span><br><span class="line"><span class="built_in">dofile</span> <span class="string">&#x27;a.lua&#x27;</span>          <span class="comment">--&gt; dofile (&#x27;a.lua&#x27;)</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">[[a multi-line</span></span><br><span class="line"><span class="string">    message]]</span>)</span><br><span class="line"></span><br><span class="line">f&#123;x=<span class="number">10</span>, y=<span class="number">20</span>&#125;   <span class="comment">--&gt; f(&#123;x=10, y=20&#125;)</span></span><br><span class="line"><span class="built_in">type</span>&#123;&#125;          <span class="comment">--&gt; type(&#123;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 面向对象方式调用函数的语法</span></span><br><span class="line">o:foo(x) <span class="comment">-- &gt; o.foo(o, x)</span></span><br></pre></td></tr></table></figure>

<p>string.find，其返回匹配串<code>“开始和结束的下标”</code>（如果不存在匹配串返回 <code>nil</code>）。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">&quot;hello Lua users&quot;</span>, <span class="string">&quot;Lua&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s, e) <span class="comment">--&gt; 7 9</span></span><br></pre></td></tr></table></figure>

<h3 id="5-1-multi-result-return"><a href="#5-1-multi-result-return" class="headerlink" title="5.1 multi result return"></a>5.1 multi result return</h3><p>返回多个结果值</p>
<ul>
<li><p>作为表达式调用函数</p>
<ol>
<li>当调用<code>作为表达式最后一个参数</code>或者<code>仅有一个参数</code>时，根据变量个数函数尽可能多地返回多个值，不足补 nil，超出舍去。</li>
<li>其他情况下，函数调用<code>仅返回第一个值</code>（如果没有返回值为 nil）</li>
</ol>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo0</span> <span class="params">()</span></span> <span class="keyword">end</span> <span class="comment">-- returns no results</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo1</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span> <span class="keyword">end</span> <span class="comment">-- returns 1 result</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo2</span> <span class="params">()</span></span> <span class="keyword">return</span> <span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span> <span class="keyword">end</span> <span class="comment">-- returns 2 results</span></span><br><span class="line"></span><br><span class="line">x,y = foo2(), <span class="number">20</span> <span class="comment">-- x=&#x27;a&#x27;, y=20</span></span><br><span class="line">x,y = foo0(), <span class="number">20</span>, <span class="number">30</span> <span class="comment">-- x=&#x27;nil&#x27;, y=20, 30 is discarded</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>作为函数参数调用</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(foo2(), <span class="number">1</span>) <span class="comment">--&gt; a 1</span></span><br><span class="line"><span class="built_in">print</span>(foo2() .. <span class="string">&quot;x&quot;</span>) <span class="comment">--&gt; ax</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在表构造函数 调用</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;foo0(), foo2(), <span class="number">4</span>&#125; <span class="comment">-- a[1] = nil, a[2] = &#x27;a&#x27;, a[3] = 4</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>return f()这种类型的返回 f()返回的<code>所有值</code></p>
</li>
<li><p>可以使用圆括号强制使调用返回一个值。</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>((foo0())) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">print</span>((foo1())) <span class="comment">--&gt; a</span></span><br><span class="line"><span class="built_in">print</span>((foo2())) <span class="comment">--&gt; a</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p>函数多值返回的特殊函数 unpack，接受一个数组作为输入参数，返回数组的所有元素。<br>unpack 被用来实现范型调用机制，在 C 语言中可以使用函数指针调用可变的函数，可以声明参数可变的函数，但不能两者同时可变。</p>
<p>在 Lua 中如果你想调用可变参数的可变函数只需要这样</p>
<blockquote>
<p>f(unpack(a))</p>
</blockquote>
<p>预定义的 unpack 函数是用 C 语言实现的，我们也可以用 Lua 来完成：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unpack</span><span class="params">(t, i)</span></span></span><br><span class="line">    i = i <span class="keyword">or</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> t[i] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> t[i], <span class="built_in">unpack</span>(t, i + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-variable-parameter-可变参数"><a href="#5-2-variable-parameter-可变参数" class="headerlink" title="5.2 variable parameter 可变参数"></a>5.2 variable parameter 可变参数</h3><p>Lua 函数可以接受可变数目的参数，和 C 语言类似在函数参数列表中使用三点<code>（...）</code>表示函数有可变的参数。<br>Lua 将函数的参数放在一个叫 <code>arg</code> 的表中，除了参数以外，<code>arg表</code>中还有一个<code>域 n</code> 表示参数的个数。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">g</span> <span class="params">(a, b, ...)</span></span> <span class="keyword">end</span></span><br><span class="line">CALL PARAMETERS</span><br><span class="line">g(<span class="number">3</span>) a=<span class="number">3</span>, b=<span class="literal">nil</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;n=<span class="number">0</span>&#125;</span><br><span class="line">g(<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>) a=<span class="number">3</span>, b=<span class="number">4</span>, <span class="built_in">arg</span>=&#123;<span class="number">5</span>, <span class="number">8</span>; n=<span class="number">2</span>&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们只想要 string.find 返回的第二个值：一个典型的方法是使用虚变量（下划线）</p>
<blockquote>
<p>local _, x &#x3D; string.find(s, p)</p>
</blockquote>
<h3 id="5-3-named-parameter-命名参数"><a href="#5-3-named-parameter-命名参数" class="headerlink" title="5.3 named parameter 命名参数"></a>5.3 named parameter 命名参数</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rename</span> <span class="params">(arg)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">os</span>.<span class="built_in">rename</span>(<span class="built_in">arg</span>.old, <span class="built_in">arg</span>.new)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">rename</span>&#123;old=<span class="string">&quot;temp.lua&quot;</span>, new=<span class="string">&quot;temp1.lua&quot;</span>&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="6-function-plus-再论函数"><a href="#6-function-plus-再论函数" class="headerlink" title="6. function plus 再论函数"></a>6. function plus 再论函数</h2><p>note: <em><strong>Lua 中的函数是带有词法定界（lexical scoping）的第一类值（first-class values）。</strong></em></p>
<p>**第一类值(first-class values)**指：<em><strong>在 Lua 中函数和其他值（数值、字符串）一样，函数可以被存放在变量中，也可以存放在表中，可以作为函数的参数，还可以作为函数的返回值。</strong></em></p>
<p>**词法定界(lexical scoping)**指：<em><strong>被嵌套的函数可以访问他外部函数中的变量。这一特性给 Lua 提供了强大的编程能力。</strong></em></p>
<p>Lua 中我们经常这样写：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>这实际上是利用 Lua 提供的“语法上的甜头”（<em><strong>syntactic sugar</strong></em>）的结果，下面是原本的函数：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- why you try like that? because i dont&#x27;t like sugar</span></span><br><span class="line">foo = <span class="function"><span class="keyword">function</span> <span class="params">(x)</span></span> <span class="keyword">return</span> <span class="number">2</span>*x <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 根据学生的成绩从高到低对学生进行排序， 这里的 names, grades 作用域是这个chunk的全局</span></span><br><span class="line">names = &#123;<span class="string">&quot;Peter&quot;</span>, <span class="string">&quot;Paul&quot;</span>, <span class="string">&quot;Mary&quot;</span>&#125;</span><br><span class="line">grades = &#123;Mary = <span class="number">10</span>, Paul = <span class="number">7</span>, Peter = <span class="number">8</span>&#125;</span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line"><span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>以其他函数作为参数的函数在 Lua 中被称作<code>高级函数</code>，高级函数在 Lua 中并没有特权，只是 Lua 把函数当作<code>第一类函数</code>处理的一个简单的结果。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sortbygrade</span> <span class="params">(names, grades)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">sort</span>(names, <span class="function"><span class="keyword">function</span> <span class="params">(n1, n2)</span></span></span><br><span class="line">        <span class="keyword">return</span> grades[n1] &gt; grades[n2] <span class="comment">-- compare the grades</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>包含在 sortbygrade 函数内部的 sort 中的匿名函数可以访问 sortbygrade 的参数grades，<br>在<code>匿名函数内部</code> grades 不是全局变量也不是局部变量，我们称作<code>外部的局部变量</code>（external local variable）或者 <code>upvalue</code>。</p>
<p>技术上来讲，<code>闭包</code>指值而不是指函数，函数仅仅是闭包的一个<code>原型声明</code>；</p>
<blockquote>
<p>闭包的声明周期?</p>
</blockquote>
<p>简单的说<code>闭包</code> 是 <em><strong>一个函数加上它可以正确访问的 upvalues。</strong></em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Lib = &#123;&#125;</span><br><span class="line">Lib.foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span></span><br><span class="line">Lib.goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span></span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;</span><br><span class="line">    foo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x + y <span class="keyword">end</span>,</span><br><span class="line">    goo = <span class="function"><span class="keyword">function</span> <span class="params">(x,y)</span></span> <span class="keyword">return</span> x - y <span class="keyword">end</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">--------------</span></span><br><span class="line">Lib = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.foo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Lib.goo</span> <span class="params">(x,y)</span></span></span><br><span class="line">    <span class="keyword">return</span> x - y</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>Lua 把 <code>chunk</code> 当作<code>函数</code>处理，在 chunk 内可以声明<code>局部函数</code>（<em><strong>仅仅在 chunk 内可见</strong></em>），词法定界保证了包内的<code>其他函数</code><strong>可以调用</strong>此函数。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- error usage</span></span><br><span class="line"><span class="keyword">local</span> fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>) <span class="comment">-- buggy</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>上面这种方式导致 Lua 编译时遇到 fact(n-1)并<em>不知道他是局部函数</em> <code>fact</code>，Lua 会去查找是否有这样的<em>全局函数</em> <code>fact</code>。<br>为了解决这个问题我们必须在<em>定义函数以前</em> 先<strong>声明</strong>:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> fact</span><br><span class="line">fact = <span class="function"><span class="keyword">function</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> n*fact(n<span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>但是 Lua 扩展了他的语法使得可以在直接递归函数定义时使用两种方式都可以。</em><br>note:<em>在定义<code>非</code>直接递归局部函数时要<strong>先声明</strong>然后定义才可以</em></p>
<h3 id="6-3-proper-tail-calls-尾调用"><a href="#6-3-proper-tail-calls-尾调用" class="headerlink" title="6.3 proper tail calls 尾调用"></a>6.3 proper tail calls 尾调用</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(x)</span></span></span><br><span class="line">    <span class="keyword">return</span> g(x)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><em>这种情况下当被调用函数 g 结束时程序<strong>不需要返回</strong>到<code>调用者 f</code>；</em><br><em>所以<strong>尾调用之后</strong>程序不需要在栈中保留关于*<em>调用者的任何信息</em></em>。*<br><em>一些编译器比如 <strong>Lua 解释器</strong>利用这种特性在处理尾调用时<strong>不使用额外的栈</strong>，我们称这种语言*<em>支持</em></em><code>正确的尾调用</code>。*</p>
<p>note:<em>由于尾调用不需要使用栈空间，那么尾调用<strong>递归的层次</strong>可以无限制的。例如下面调用不论 n 为何值*<em>不会导致栈溢出</em></em>。*</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span> <span class="keyword">then</span> <span class="keyword">return</span> foo(n - <span class="number">1</span>) <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非尾调用</span></span><br><span class="line"><span class="keyword">return</span> g(x) + <span class="number">1</span> <span class="comment">-- must do the addition</span></span><br><span class="line"><span class="keyword">return</span> x <span class="keyword">or</span> g(x) <span class="comment">-- must adjust to 1 result</span></span><br><span class="line"><span class="keyword">return</span> (g(x)) <span class="comment">-- must adjust to 1 result</span></span><br></pre></td></tr></table></figure>

<p>可以将尾调用理解成一种 goto，在<strong>状态机的编程</strong>领域尾调用是非常有用的。<br>状态机的应用要求函数记住每一个状态，改变状态只需要 goto(or call)一个特定的函数。</p>
<p>传统模式的编译器对于尾调用的处理方式就像处理其他普通函数调用一样，总会在调用时创建一个新的栈帧（stack frame）并将其推入调用栈顶部，用于表示该次函数调用。</p>
<p>当一个函数调用发生时，计算机必须 “记住” 调用函数的位置 —— 返回位置，才可以在调用结束时带着返回值回到该位置，返回位置一般存在调用栈上。在尾调用这种特殊情形中，计算机理论上可以<em>不需要记住尾调用的位置</em>而<em>从被调用的函数直接<strong>带着返回值</strong>返回调用函数的返回位置</em>（相当于直接连续返回两次）。<br>尾调用消除即是在不改变当前调用栈（也不添加新的返回位置）的情况下跳到新函数的一种优化（完全不改变调用栈是不可能的，还是需要校正调用栈上形式参数与局部变量的信息。）</p>
<p>由于当前函数帧上包含局部变量等等大部分的东西都不需要了，当前的<em>函数帧经过适当的更动</em>以后可以<em>直接当作被尾调用的函数的帧使用</em>，然后程序即可以跳到被尾调用的函数。产生这种函数帧更动代码与 “jump”（而不是一般常规函数调用的代码）的过程称作<strong>尾调用消除(Tail Call Elimination)<strong>或</strong>尾调用优化(Tail Call Optimization, TCO)</strong>。尾调用优化让位于尾位置的函数调用跟 goto 语句性能一样高，也因此使得高效的结构编程成为现实。</p>
<p>然而，对于 <strong>C++</strong> 等语言来说，在函数最后 return g(x); 并不一定是尾递归——在返回之前很可能涉及到<strong>对象的析构函数</strong>，使得 g(x) 不是最后执行的那个。这可以通过返回值优化来解决。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(data1, data2)</span></span></span><br><span class="line">   a(data1)</span><br><span class="line">   <span class="keyword">return</span> b(data2)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">汇编代码:</span><br><span class="line">```asm</span><br><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; 透过栈指针（sp）取得 data1 并放到暂用暂存器。</span><br><span class="line">  push reg            ; 将 data1 放到栈上以便 a 使用。</span><br><span class="line">  call a              ; a 使用 data1。</span><br><span class="line">  pop                 ; 把 data1 從栈上拿掉。</span><br><span class="line">  mov  reg,[sp+data2] ; 透过栈指針（sp）取得 data2 並放到暂用暂存器。</span><br><span class="line">  push reg            ; 将 data2 放到栈上以便 b 使用。</span><br><span class="line">  call b              ; b 使用 data2。</span><br><span class="line">  pop                 ; 把 data2 從栈上拿掉。</span><br><span class="line">  ret</span><br></pre></td></tr></table></figure>

<p>优化后汇编代码:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">foo:</span><br><span class="line">  mov  reg,[sp+data1] ; 透过栈指针（sp）取得 data1 并放到暂用暂存器。</span><br><span class="line">  push reg            ; 将 data1 放到栈上以便 a 使用。</span><br><span class="line">  call a              ; a 使用 data1。</span><br><span class="line">  pop                 ; 把 data1 從栈上拿掉。</span><br><span class="line">  mov  reg,[sp+data2] ; 透过栈指針（sp）取得 data2 並放到暂用暂存器。  </span><br><span class="line">  mov  [sp+data1],reg ; 把 data2 放到 b 预期的位置。</span><br><span class="line">  jmp  b              ; b 使用 data2 並返回到调用 foo 的函数。</span><br></pre></td></tr></table></figure>

<h2 id="7-iterator-genericity-for-迭代器-泛型for"><a href="#7-iterator-genericity-for-迭代器-泛型for" class="headerlink" title="7. iterator &amp; genericity for 迭代器 泛型for"></a>7. iterator &amp; genericity for 迭代器 泛型for</h2><p>创建一个<code>闭包</code>必须要创建其外部局部变量。<br>所以一个典型的闭包的结构包含两个函数：一个是<code>闭包</code>自己；另一个是工厂（<code>创建闭包的函数</code>）。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">list_iter</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> n = #t</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &lt;= n <span class="keyword">then</span> <span class="keyword">return</span> t[i] <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line">iter = list_iter(t) <span class="comment">-- creates the iterator</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> element = iter() <span class="comment">-- calls the iterator</span></span><br><span class="line">    <span class="keyword">if</span> element == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 泛型 for</span></span><br><span class="line">t = &#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>&#125;</span><br><span class="line"><span class="keyword">for</span> element <span class="keyword">in</span> list_iter(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(element)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>这个例子中 list_iter 是一个工厂，每次调用他都会创建一个新的闭包（迭代器本身）</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 迭代器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">allwords</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- current line</span></span><br><span class="line">    <span class="keyword">local</span> pos = <span class="number">1</span> <span class="comment">-- current position in the line</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator function</span></span><br><span class="line">        <span class="keyword">while</span> line <span class="keyword">do</span> <span class="comment">-- repeat while there are lines</span></span><br><span class="line">            <span class="keyword">local</span> s, e = <span class="built_in">string</span>.<span class="built_in">find</span>(line, <span class="string">&quot;%w+&quot;</span>, pos)</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">then</span> <span class="comment">-- found a word</span></span><br><span class="line">                pos = e + <span class="number">1</span> <span class="comment">-- next position is after this word</span></span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(line, s, e) <span class="comment">-- return the word</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                line = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- word not found; try next line</span></span><br><span class="line">                pos = <span class="number">1</span> <span class="comment">-- restart from first position</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span> <span class="comment">-- no more lines: end of traversal</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- usage:</span></span><br><span class="line"><span class="keyword">for</span> word <span class="keyword">in</span> allwords() <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(word)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-2-genericity-for-泛型-for-的语义"><a href="#7-2-genericity-for-泛型-for-的语义" class="headerlink" title="7.2 genericity for 泛型 for 的语义"></a>7.2 genericity for 泛型 for 的语义</h3><p>一般式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> var_1, ..., var_n <span class="keyword">in</span> explist <span class="keyword">do</span> block <span class="keyword">end</span></span><br><span class="line"><span class="comment">-- ==&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> _f, _s, _var = explist</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> var_1, ... , var_n = _f(_s, _var)</span><br><span class="line">        _var = var_1</span><br><span class="line">        <span class="keyword">if</span> _var == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        block</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-iterator-without-status-无状态的迭代器"><a href="#7-3-iterator-without-status-无状态的迭代器" class="headerlink" title="7.3 iterator without status 无状态的迭代器"></a>7.3 iterator without status 无状态的迭代器</h3><p>note:<em>迭代的状态包括被遍历的表（循环过程中不会改变的<code>状态常量</code>）和当前的索引下标（<code>控制变量</code>），</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">iter</span> <span class="params">(a, i)</span></span></span><br><span class="line">    i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">local</span> v = a[i]</span><br><span class="line">    <span class="keyword">if</span> v <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> i, v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ipairs</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">return</span> iter, a, <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>当 Lua 调用 ipairs(a)开始循环时，他获取三个值:迭代函数 iter，状态常量 a 和控制变量初始值 0；然后 Lua 调用 iter(a,0)返回 1,a[1]（除非 a[1]&#x3D;nil）；直到<strong>第一个</strong>非 nil 元素</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> n</span><br><span class="line"><span class="comment">-- n = nil 全部</span></span><br><span class="line"><span class="comment">-- n = 1 打印从2 开始</span></span><br><span class="line"><span class="comment">-- n = 0 出错</span></span><br><span class="line">dd=&#123;<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="number">3</span>,&#125;</span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">next</span>, dd, n <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="7-3-multi-status-iterator-多状态的迭代器"><a href="#7-3-multi-status-iterator-多状态的迭代器" class="headerlink" title="7.3 multi status iterator 多状态的迭代器"></a>7.3 multi status iterator 多状态的迭代器</h3><h2 id="8-compile-run-debug-编译-运行-调试"><a href="#8-compile-run-debug-编译-运行-调试" class="headerlink" title="8. compile run debug 编译 运行 调试"></a>8. compile run debug 编译 运行 调试</h2><p>note: <em>解释型语言的特征不在于他们是否被编译，而是<code>编译器</code>是<code>语言运行时</code>的一部分</em></p>
<p>loadfile:<em>编译代码成中间码并且返回编译后的 chunk 作为一个函数，而不执行代码；</em></p>
<p>note:<em>在发生错误的情况下，loadfile 返回 nil 和错误信息，这样我们就可以自定义错误处理</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="built_in">loadstring</span>(<span class="string">&quot;i = i + 1&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>note:<em>f 将是一个函数，调用时执行 i&#x3D;i+1</em></p>
<p>Lua 把每一个 chunk 都作为一个<code>匿名函数</code>处理。<br>例如：chunk “a &#x3D; 1”，<br><code>loadstring</code> 返回与其等价的 <code>function () a = 1 end</code>与其他函数一样，<br>chunks 可以定义局部变量也可以返回值：<code>f = loadstring(&quot;local a = 10; return a + 20&quot;)</code></p>
<p>note:<em>loadfile 和 loadstring 都不会抛出错误，如果发生错误他们将返回 nil 加上错误信息：</em><br>note:<em>Lua 中的<code>函数定义</code>是发生在<code>运行时的赋值</code>而不是发生在编译时。</em></p>
<p>如果你想快捷的调用 dostring（比如加载并运行），可以这样<br><code>loadstring(s)()</code></p>
<p>如果加载的内容存在<code>语法错误</code>的话，loadstring 返回 nil 和错误信息（attempt to call a nil value）；为了返回更清楚的错误信息可以使用 assert：<br><code>assert(loadstring(s))()</code></p>
<p>note:<em>每次调用 loadstring 都会重新编译,loadstring 编译的时候不关心词法范围</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line">f = <span class="built_in">loadstring</span>(<span class="string">&quot;i = i + 1&quot;</span>)</span><br><span class="line">g = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> i = i + <span class="number">1</span> <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>note:<em>这个例子中，和想象的一样 <code>g</code> 使用*<em>局部变量</em></em> i，然而 <code>f</code> 使用<strong>全局变量</strong> i；<code>loadstring</code> 总是在<strong>全局环境</strong>中<strong>编译</strong>他的串。*</p>
<p>note:<em>loadstring 期望一个 chunk，即语句。如果想要加载<code>表达式</code>，需要在表达式前加 <code>return</code>，那样将返回表达式的值。</em></p>
<h2 id="8-1-require"><a href="#8-1-require" class="headerlink" title="8.1 require"></a>8.1 require</h2><ul>
<li><em>会搜索目录加载文件</em></li>
<li><em>会判断是否文件已经加载避免重复加载同一文件</em></li>
<li><em>?;?.lua;c:\windows?;&#x2F;usr&#x2F;local&#x2F;lua&#x2F;?&#x2F;?.lua</em></li>
<li><em>require 和 dofile 完成同样的功能</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span> lili</span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">lili</span></span><br><span class="line"><span class="comment">lili.lua</span></span><br><span class="line"><span class="comment">c:\windows\lili</span></span><br><span class="line"><span class="comment">/usr/local/lua/lili/lili.lua</span></span><br><span class="line"><span class="comment">]]</span></span><br></pre></td></tr></table></figure>

<p>note:<em>表中保留加载的文件的虚名，而不是实文件名。所以如果你使用不同的虚文件名 require同一个文件两次，将会加载两次该文件。比如 require “foo”和 require “foo.lua”，将会加载 foo.lua 两次,全局变量<code>_LOADED</code> 访问文件名列表, <code>_REQUIREDNAME</code></em></p>
<h3 id="8-2-C-Packages"><a href="#8-2-C-Packages" class="headerlink" title="8.2 C Packages"></a>8.2 C Packages</h3><p>note:<em>动态连接库不是 ANSI C 的一部分，也就是说在标准 C 中实现动态连接是很困难的。</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">path</span> = <span class="string">&quot;/usr/local/lua/lib/libluasocket.so&quot;</span></span><br><span class="line"><span class="comment">-- or path = &quot;C:\\windows\\luasocket.dll&quot;</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">loadlib</span>(<span class="built_in">path</span>, <span class="string">&quot;luaopen_socket&quot;</span>))</span><br><span class="line">f() <span class="comment">-- actually open the library</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-error-错误"><a href="#8-3-error-错误" class="headerlink" title="8.3 error 错误"></a>8.3 error 错误</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span> <span class="string">&quot;enter a number:&quot;</span></span><br><span class="line">n = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="built_in">error</span>(<span class="string">&quot;invalid input&quot;</span>) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="8-4-exception-pcall"><a href="#8-4-exception-pcall" class="headerlink" title="8.4 exception &amp; pcall"></a>8.4 exception &amp; pcall</h3><h3 id="8-5-exception-msg-xpcall"><a href="#8-5-exception-msg-xpcall" class="headerlink" title="8.5 exception msg &amp; xpcall"></a>8.5 exception msg &amp; xpcall</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">error</span>(<span class="string">&quot;string expected&quot;</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>())</span><br></pre></td></tr></table></figure>

<h2 id="9-0-coroutine"><a href="#9-0-coroutine" class="headerlink" title="9.0 coroutine"></a>9.0 coroutine</h2><p>协同程序（coroutine）<em>与多线程情况下的线程比较类似：有自己的堆栈，自己的局部变量，有自己的指令指针，但是和其他协同程序共享全局变量等很多信息。</em></p>
<p>线程和协同程序的主要不同在于：在多处理器情况下，从概念上来讲多线程程序同时运行多个线程；而协同程序是通过协作来完成，在<strong>任一指定时刻只有一个协同程序在运行</strong>，并且这个正在运行的协同程序只有在明确的被要求挂起的时候才会被挂起。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="built_in">print</span>(<span class="string">&quot;hi&quot;</span>) <span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(co) <span class="comment">--&gt; thread: 0x8071d98</span></span><br></pre></td></tr></table></figure>

<p>note:<em>协同有三个状态：挂起态、运行态、停止态.当我们创建一个协同程序时他开始的状态为挂起态，也就是说我们创建协同程序的时候不会自动运行，</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; suspended</span></span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">status</span>(co)) <span class="comment">--&gt; dead</span></span><br><span class="line"></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">10</span> <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, i)</span><br><span class="line">        <span class="built_in">coroutine</span>.<span class="built_in">yield</span>()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 协同程序处于终止状态 激活他，resume 将返回 false 和错误信息。</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)) <span class="comment">--&gt; false cannot resume dead coroutine</span></span><br></pre></td></tr></table></figure>

<p>note:<em>resume 运行在保护模式下，因此如果协同内部存在错误 Lua 并不会抛出错误而是将错误返回给 resume 函数。</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- yield 返回的额外的参数也将会传递给 resume。</span></span><br><span class="line">co = <span class="built_in">coroutine</span>.<span class="built_in">create</span> (<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;co&quot;</span>, <span class="built_in">coroutine</span>.<span class="built_in">yield</span>())</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line"><span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co, <span class="number">4</span>, <span class="number">5</span>) <span class="comment">--&gt; co 4 5</span></span><br></pre></td></tr></table></figure>

<ul>
<li>resume 把额外的参数传递给协同的主程序。</li>
<li>resume 返回除了 true 以外的其他部分将作为参数传递给相应的 yield, yield 返回的额外的参数也将会传递给 resume。</li>
<li>当协同代码结束时主函数返回的值都会传给相应的 resume</li>
</ul>
<p>对称协同:<em>由执行到挂起之间状态转换的函数是相同的。</em><br>不对称协同(半协同):<em>挂起一个正在执行的协同的函数与使一 个被挂起的协同再次执行的函数是不同的</em></p>
<h3 id="9-2-filter-过滤器"><a href="#9-2-filter-过滤器" class="headerlink" title="9.2 filter 过滤器"></a>9.2 filter 过滤器</h3><p>过滤器:<em>指在生产者与消费者之间，可以对数据 进行某些转换处理。过滤器在同一时间既是生产者又是消费者，他请求生产者生产值并 且转换格式后传给消费者</em></p>
<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">receive</span> <span class="params">(prod)</span></span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, value = <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(prod)</span><br><span class="line">   <span class="keyword">return</span> value</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">send</span> <span class="params">(x)</span></span></span><br><span class="line">   <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(x)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">producer</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = <span class="built_in">io</span>.<span class="built_in">read</span>() <span class="comment">-- produce new value</span></span><br><span class="line">            send(x)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span> <span class="params">(prod)</span></span></span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">       <span class="keyword">local</span> line = <span class="number">1</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">            x = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%5d %s&quot;</span>, line, x)</span><br><span class="line">            send(x) <span class="comment">-- send it to consumer</span></span><br><span class="line">            line = line + <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">consumer</span> <span class="params">(prod)</span></span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> x = receive(prod) <span class="comment">-- get new value</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(x, <span class="string">&quot;\n&quot;</span>) <span class="comment">-- consume new value</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">consumer(filter(producer()))</span><br></pre></td></tr></table></figure>

<h3 id="9-3-iterator-迭代器"><a href="#9-3-iterator-迭代器" class="headerlink" title="9.3 iterator 迭代器"></a>9.3 iterator 迭代器</h3><p>origin:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        printResult(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">       <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">&quot; &quot;</span>)</span><br><span class="line">   <span class="keyword">end</span></span><br><span class="line">   <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">permgen (&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>&#125;, <span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>example:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">permgen</span> <span class="params">(a, n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">       <span class="built_in">coroutine</span>.<span class="built_in">yield</span>(a)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>,n <span class="keyword">do</span></span><br><span class="line">            <span class="comment">-- put i-th element as the last one</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">            <span class="comment">-- generate all permutations of the other elements</span></span><br><span class="line">            permgen(a, n - <span class="number">1</span>)</span><br><span class="line">            <span class="comment">-- restore i-th element</span></span><br><span class="line">            a[n], a[i] = a[i], a[n]</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">local</span> n = #a</span><br><span class="line">    <span class="keyword">local</span> co = <span class="built_in">coroutine</span>.<span class="built_in">create</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="comment">-- iterator</span></span><br><span class="line">        <span class="keyword">local</span> code, res = <span class="built_in">coroutine</span>.<span class="built_in">resume</span>(co)</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printResult</span> <span class="params">(a)</span></span></span><br><span class="line">    <span class="keyword">for</span> i,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">io</span>.<span class="built_in">write</span>(v, <span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> perm&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125; <span class="keyword">do</span></span><br><span class="line">   printResult(p)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>coroutine.wrap:<em>wrap 创建一个协同程序;不同的是 wrap 不返回协 同本身，而是返回一个函数，当这个函数被调用时将 resume 协同</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">perm</span> <span class="params">(a)</span></span></span><br><span class="line">   <span class="keyword">local</span> n = #a</span><br><span class="line">   <span class="keyword">return</span> <span class="built_in">coroutine</span>.<span class="built_in">wrap</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> permgen(a, n) <span class="keyword">end</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="9-4-pre-emptive-multi-thread-非抢占式多线程"><a href="#9-4-pre-emptive-multi-thread-非抢占式多线程" class="headerlink" title="9.4 pre-emptive multi thread 非抢占式多线程"></a>9.4 pre-emptive multi thread 非抢占式多线程</h3><p>note:<em>协同是非抢占式的。 当一个协同正在运行时，不能在外部终止他。只能通过显示的调用 yield 挂起他的执行。</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">协同是非抢占式的。 当一个协同正在运行时，不能在外部终止他。只能通过显示的调用 <span class="built_in">yield</span> 挂起他的执行。</span><br></pre></td></tr></table></figure>

<hr>
<blockquote>
<p>table &amp; object</p>
</blockquote>
<h2 id="11-datastruct"><a href="#11-datastruct" class="headerlink" title="11. datastruct"></a>11. datastruct</h2><h3 id="11-1-array-数组"><a href="#11-1-array-数组" class="headerlink" title="11.1 array 数组"></a>11.1 array 数组</h3><h3 id="11-2-matrix-multidimensional-array-阵-多维数组"><a href="#11-2-matrix-multidimensional-array-阵-多维数组" class="headerlink" title="11.2 matrix &amp; multidimensional array 阵 多维数组"></a>11.2 matrix &amp; multidimensional array 阵 多维数组</h3><p>稀疏矩阵:<em>指矩阵的大部分元素都为空或者 0 的矩阵。</em></p>
<h3 id="11-3-linked-list-s链表"><a href="#11-3-linked-list-s链表" class="headerlink" title="11.3 linked list s链表"></a>11.3 linked list s链表</h3><h3 id="11-4-queen-dique-s队列-双端队列"><a href="#11-4-queen-dique-s队列-双端队列" class="headerlink" title="11.4 queen &amp; dique s队列 双端队列"></a>11.4 queen &amp; dique s队列 双端队列</h3><p>note:<em>Lua 的 table 库提供的 insert 和 remove 操作来实现队列，但这种方式 实现的队列针对<strong>大数据量</strong>时效率太低</em></p>
<p>note:<em>有效的方式是使用两个索引下标，一个表示第一个元素，另一个表示最后一个元素。</em></p>
<h3 id="11-5-set-package-集合-包"><a href="#11-5-set-package-集合-包" class="headerlink" title="11.5 set &amp; package 集合 包"></a>11.5 set &amp; package 集合 包</h3><h3 id="11-6-string-buffer-字符串缓冲"><a href="#11-6-string-buffer-字符串缓冲" class="headerlink" title="11.6 string buffer 字符串缓冲"></a>11.6 string buffer 字符串缓冲</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- WARNING: bad code ahead!!</span></span><br><span class="line"><span class="keyword">local</span> buff = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   buff = buff .. line .. <span class="string">&quot;\n&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>假定在 loop 中间，buff 已经是一个 50KB 的字符串， 每一行的大小为 20bytes，<br>当 Lua 执行 <code>buff..line..&quot;\n&quot;</code>时，她创建了一个新的字符串大小为 50,020 bytes，并且从 buff 中将 50KB 的字符串拷贝到新串中。<br>老的字符串变成了垃圾数据，两轮循环之后，将有两个老串包含超过 100KB 的垃圾 数据。这个时候 Lua 会做出正确的决定，进行他的垃圾收集并释放 100KB 的内存。问题 在于每两次循环 Lua 就要进行一次垃圾收集，读取整个文件需要进行 200 次垃圾收集。 并且它的内存使用是整个文件大小的三倍。</p>
<p>note:<em>其它的采用垃圾收集算法的并且字符串不可变的语言 也都存在这个问题。Java 专门提供 StringBuffer 来改善这种情况。</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newStack</span> <span class="params">()</span></span></span><br><span class="line">   <span class="keyword">return</span> &#123;<span class="string">&quot;&quot;</span>&#125;   <span class="comment">-- starts with an empty string</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">addString</span> <span class="params">(stack, s)</span></span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(stack,s) <span class="comment">--push&#x27;s&#x27;intothethestack for i=#stack-1, 1, -1 do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i]) &gt; <span class="built_in">string</span>.<span class="built_in">len</span>(stack[i+<span class="number">1</span>]) <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    stack[i] = stack[i] .. stack[i+<span class="number">1</span>]</span><br><span class="line">    stack[i+<span class="number">1</span>] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> s = newStack()</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   addString(s, line .. <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = toString(s)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 或者</span></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="built_in">io</span>.<span class="built_in">lines</span>() <span class="keyword">do</span></span><br><span class="line">   <span class="built_in">table</span>.<span class="built_in">insert</span>(t, line)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">s = <span class="built_in">table</span>.<span class="built_in">concat</span>(t, <span class="string">&quot;\n&quot;</span>) .. <span class="string">&quot;\n&quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="12-data-file-storage-Persistence-数据文件与持久化"><a href="#12-data-file-storage-Persistence-数据文件与持久化" class="headerlink" title="12. data file storage &amp; Persistence 数据文件与持久化"></a>12. data file storage &amp; Persistence 数据文件与持久化</h2><blockquote>
<p>string.format(“%q”, o)</p>
</blockquote>
<h2 id="13-metatables-metamethods"><a href="#13-metatables-metamethods" class="headerlink" title="13. metatables metamethods"></a>13. metatables metamethods</h2><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1 = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, t1)</span><br><span class="line"><span class="built_in">assert</span>(<span class="built_in">getmetatable</span>(t) == t1)</span><br></pre></td></tr></table></figure>

<p>note:<em>一组相关的表可以共享一个 metatable (描述他们共同的行为)。一个表也可以是<strong>自身</strong>的 metatable(描述其私有行为)。</em></p>
<h3 id="13-1-arithmetic-operation-metamethods-算术运算的-matamethods"><a href="#13-1-arithmetic-operation-metamethods-算术运算的-matamethods" class="headerlink" title="13.1  arithmetic operation metamethods 算术运算的 matamethods"></a>13.1  arithmetic operation metamethods 算术运算的 matamethods</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">Set = &#123;&#125;</span><br><span class="line">Set.mt = &#123;&#125; <span class="comment">-- metatable for sets</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.new</span> <span class="params">(t)</span></span></span><br><span class="line">   <span class="keyword">local</span> set = &#123;&#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(set, Set.mt)</span><br><span class="line">   <span class="keyword">for</span> _, l <span class="keyword">in</span> <span class="built_in">ipairs</span>(t) <span class="keyword">do</span> set[l] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> set</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.union</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">getmetatable</span>(a) ~= Set.mt <span class="keyword">or</span> <span class="built_in">getmetatable</span>(b) ~= Set.mt <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;attempt to `add&#x27; a set with a non-set value&quot;</span>, <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(b) <span class="keyword">do</span> res[k] = <span class="literal">true</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.intersection</span> <span class="params">(a,b)</span></span></span><br><span class="line">   <span class="keyword">local</span> res = Set.new&#123;&#125;</span><br><span class="line">   <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">res[k] = b[k]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> res</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.tostring</span> <span class="params">(set)</span></span></span><br><span class="line">   <span class="keyword">local</span> s = <span class="string">&quot;&#123;&quot;</span></span><br><span class="line">   <span class="keyword">local</span> sep = <span class="string">&quot;&quot;</span></span><br><span class="line">   <span class="keyword">for</span> e <span class="keyword">in</span> <span class="built_in">pairs</span>(set) <span class="keyword">do</span></span><br><span class="line">s = s .. sep .. e</span><br><span class="line">sep = <span class="string">&quot;, &quot;</span> <span class="keyword">end</span></span><br><span class="line">   <span class="keyword">return</span> s .. <span class="string">&quot;&#125;&quot;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Set.print</span> <span class="params">(s)</span></span></span><br><span class="line">   <span class="built_in">print</span>(Set.<span class="built_in">tostring</span>(s))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s1 = Set.new&#123;<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>, <span class="number">50</span>&#125;</span><br><span class="line">s2 = Set.new&#123;<span class="number">30</span>, <span class="number">1</span>&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s1))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">getmetatable</span>(s2))     <span class="comment">--&gt; table: 00672B60</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__add</span> = Set.union</span><br><span class="line"></span><br><span class="line">s3 = s1 + s2</span><br><span class="line">Set.<span class="built_in">print</span>(s3) <span class="comment">--&gt; &#123;1, 10, 20, 30, 50&#125;</span></span><br><span class="line"></span><br><span class="line">Set.mt.<span class="built_in">__mul</span> = Set.intersection</span><br><span class="line">Set.<span class="built_in">print</span>((s1 + s2)*s1)     <span class="comment">--&gt; &#123;10, 20, 30, 50&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>note:<em>除了__add,__mul, 还有__sub(减),__div(除),__unm(负),__pow(幂)，我们也可以定义__concat 定义连接行为。</em></p>
<p>如果两个操作数有不同的 metatable, Lua 选择 metamethod 的原则:</p>
<ul>
<li>如果第一个参数存在带有__add 域的 metatable，Lua 使用它作为 metamethod，和第二个参数无关;</li>
<li>否则第二个参数存在带有__add 域的 metatable，Lua 使用它作为 metamethod 否则报错。</li>
</ul>
<h3 id="13-2-relational-operation-metamethods-关系运算的-metamethods"><a href="#13-2-relational-operation-metamethods-关系运算的-metamethods" class="headerlink" title="13.2 relational operation metamethods 关系运算的 metamethods"></a>13.2 relational operation metamethods 关系运算的 metamethods</h3><p>note:<em>__eq（等于），__lt（小于） ，和__le（小于等于)</em></p>
<p>note:<em><code>当我们遇到偏序（partial order）情况，也就是说，并不是所有的元素都可以正确的被排序情况。例如，在大多数机器上浮点数不能被排序，因为他的值不是一个数字（Not a Number 即 NaN）</code></em></p>
<p>note:<em>根据 IEEE 754 的标准，NaN 表示一个未定义的值，比如 0&#x2F;0 的结果。该标准指出任何涉及到 NaN 比较的结果都应为 false。也就是说，NaN &lt;&#x3D; x 总是 false，x &lt; NaN 也总是 false。这样一来，在这种情况下 a &lt;&#x3D; b 转换为 not (b &lt; a)就不再正确了。</em></p>
<p>note:<em>&lt;&#x3D;代表集合的包含：a &lt;&#x3D; b 表示集合 a 是集合 b 的子集。这种意义下，可能 a &lt;&#x3D; b 和 b &lt; a 都是 false；</em></p>
<p>note:<em>关系元算的 metamethods 不支持混合类型运算</em></p>
<p>note:<em>试图比较一个字符串和一个数字，Lua 将抛出错误.相似的，如果你试图比较两个带有不同 metamethods 的对象，Lua 也将抛出错误。</em></p>
<p>note:<em>但相等比较从来不会抛出错误，如果两个对象有不同的 metamethod，比较的结果为false，甚至可能不会调用 metamethod.</em></p>
<p>note:<em>仅当两个有共同的 metamethod 的对象进行相等比较的时候，Lua 才会调用对应的 metamethod。</em></p>
<h3 id="13-3-others-metamethods"><a href="#13-3-others-metamethods" class="headerlink" title="13.3 others metamethods"></a>13.3 others metamethods</h3><p>note:<em><code>print</code> 函数总是调用 tostring 来格式化它的输出, tostring 会首先检查对象是否存在一个带有<code>__tostring</code>域的 metatable。</em></p>
<p>假定你想保护你的集合使其使用者既看不到也不能修改 metatables。<br>如果你对 metatable 设置了__metatable 的值， getmetatable 将返回这个域的值，而调用 setmetatable将会出错：</p>
<blockquote>
<p>Set.mt.__metatable &#x3D; “not your business”</p>
</blockquote>
<h3 id="13-4-table-relative-metamethods-表相关-metamethods"><a href="#13-4-table-relative-metamethods-表相关-metamethods" class="headerlink" title="13.4 table relative metamethods 表相关 metamethods"></a>13.4 table relative metamethods 表相关 metamethods</h3><h4 id="13-4-1-The-index-Metamethod"><a href="#13-4-1-The-index-Metamethod" class="headerlink" title="13.4.1 The __index Metamethod"></a>13.4.1 The __index Metamethod</h4><p>note:<em>当我们访问一个表的不存在的域，这种访问触发 lua 解释器去查找__index metamethod</em><br>note:<em>__index metamethod 不需要非是一个函数，他也可以是一个表。</em></p>
<ul>
<li>它是一个函数的时候，Lua 将 table 和缺少的域作为参数调用这个函数；</li>
<li>他是一个表的时候，Lua 将在这个表中看是否有缺少的域。</li>
</ul>
<h4 id="13-4-2-The-newindex-Metamethod"><a href="#13-4-2-The-newindex-Metamethod" class="headerlink" title="13.4.2 The __newindex Metamethod"></a>13.4.2 The __newindex Metamethod</h4><p>note:<em>当你给表的一个缺少的域赋值，解释器就会查找__newindex metamethod,如果存在则调用这个函数而不进行赋值操作。</em></p>
<p>调用rawset(t,k,v)不掉用任何 metamethod 对表 t 的 k 域赋值为 v。</p>
<h4 id="13-4-3-table-default-value-有默认值的表"><a href="#13-4-3-table-default-value-有默认值的表" class="headerlink" title="13.4.3 table default value 有默认值的表"></a>13.4.3 table default value 有默认值的表</h4><h4 id="13-4-4-table-monitor-监控表"><a href="#13-4-4-table-monitor-监控表" class="headerlink" title="13.4.4 table monitor 监控表"></a>13.4.4 table monitor 监控表</h4><p>单表监控</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125; <span class="comment">-- original table (created somewhere)</span></span><br><span class="line"><span class="comment">-- keep a private access to original table</span></span><br><span class="line"><span class="keyword">local</span> _t = t</span><br><span class="line"><span class="comment">-- create proxy</span></span><br><span class="line">t = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line"><span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*access to element &quot;</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">    <span class="keyword">return</span> _t[k] <span class="comment">-- access the original table</span></span><br><span class="line"><span class="keyword">end</span>,</span><br><span class="line"><span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;*update of element &quot;</span> .. <span class="built_in">tostring</span>(k) ..</span><br><span class="line">    <span class="string">&quot; to &quot;</span> .. <span class="built_in">tostring</span>(v))</span><br><span class="line">    _t[k] = v <span class="comment">-- update original table</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(t, mt)</span><br></pre></td></tr></table></figure>

<p>note:<em>注意：不幸的是，这个设计不允许我们遍历表。</em></p>
<p>多表监控</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- create private index</span></span><br><span class="line"><span class="keyword">local</span> index = &#123;&#125;</span><br><span class="line"><span class="comment">-- create metatable</span></span><br><span class="line"><span class="keyword">local</span> mt = &#123;</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*access to element &quot;</span> .. <span class="built_in">tostring</span>(k))</span><br><span class="line">        <span class="keyword">return</span> t[index][k] <span class="comment">-- access the original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;*update of element &quot;</span> .. <span class="built_in">tostring</span>(k) .. <span class="string">&quot; to &quot;</span>.. <span class="built_in">tostring</span>(v))</span><br><span class="line">        t[index][k] = v <span class="comment">-- update original table</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">track</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    proxy[index] = t</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h4 id="13-4-5-readonly-table-只读表"><a href="#13-4-5-readonly-table-只读表" class="headerlink" title="13.4.5 readonly table 只读表"></a>13.4.5 readonly table 只读表</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readOnly</span> <span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">local</span> proxy = &#123;&#125;</span><br><span class="line">    <span class="keyword">local</span> mt = &#123; <span class="comment">-- create metatable</span></span><br><span class="line">        <span class="built_in">__index</span> = t,</span><br><span class="line">        <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t,k,v)</span></span></span><br><span class="line">            <span class="built_in">error</span>(<span class="string">&quot;attempt to update a read-only table&quot;</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">setmetatable</span>(proxy, mt)</span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">days = readOnly&#123;<span class="string">&quot;Sunday&quot;</span>, <span class="string">&quot;Monday&quot;</span>, <span class="string">&quot;Tuesday&quot;</span>, <span class="string">&quot;Wednesday&quot;</span>,<span class="string">&quot;Thursday&quot;</span>, <span class="string">&quot;Friday&quot;</span>, <span class="string">&quot;Saturday&quot;</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="14-environment-环境"><a href="#14-environment-环境" class="headerlink" title="14. environment 环境"></a>14. environment 环境</h2><h3 id="14-1-dynamic-access-global-value-使用动态名字访问全局变量"><a href="#14-1-dynamic-access-global-value-使用动态名字访问全局变量" class="headerlink" title="14.1 dynamic access global value 使用动态名字访问全局变量"></a>14.1 dynamic access global value 使用动态名字访问全局变量</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getfield</span> <span class="params">(f)</span></span></span><br><span class="line">    <span class="keyword">local</span> v = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">&quot;[%w_]+&quot;</span>) <span class="keyword">do</span></span><br><span class="line">        v = v[w]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setfield</span> <span class="params">(f, v)</span></span></span><br><span class="line">    <span class="keyword">local</span> t = <span class="built_in">_G</span> <span class="comment">-- start with the table of globals</span></span><br><span class="line">    <span class="keyword">for</span> w, d <span class="keyword">in</span> <span class="built_in">string</span>.<span class="built_in">gfind</span>(f, <span class="string">&quot;([%w_]+)(.?)&quot;</span>) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> d == <span class="string">&quot;.&quot;</span> <span class="keyword">then</span> <span class="comment">-- not last field?</span></span><br><span class="line">            t[w] = t[w] <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create table if absent</span></span><br><span class="line">            t = t[w] <span class="comment">-- get the table</span></span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- last field</span></span><br><span class="line">            t[w] = v <span class="comment">-- do the assignment</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="14-2-delcare-global-value-声明全局变量"><a href="#14-2-delcare-global-value-声明全局变量" class="headerlink" title="14.2 delcare global value 声明全局变量"></a>14.2 delcare global value 声明全局变量</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> declaredNames = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">declare</span> <span class="params">(name, initval)</span></span></span><br><span class="line">    <span class="built_in">rawset</span>(<span class="built_in">_G</span>, name, initval)</span><br><span class="line">    declaredNames[name] = <span class="literal">true</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(<span class="built_in">_G</span>, &#123;</span><br><span class="line">    <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, n, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;attempt to write to undeclared var. &quot;</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">rawset</span>(t, n, v) <span class="comment">-- do the actual set</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">    <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(_, n)</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> declaredNames[n] <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;attempt to read undeclared var. &quot;</span>..n, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="14-3-un-global-environment-非全局的环境"><a href="#14-3-un-global-environment-非全局的环境" class="headerlink" title="14.3 un-global environment 非全局的环境"></a>14.3 un-global environment 非全局的环境</h3><p>note:<em>当你安装一个 metatable 去控制全局访问时，你的整个程序都必须遵循同一个指导方针。如果你想使用标准库，标准库中可能使用到没有声明的全局变量，你将碰到坏运。</em></p>
<p>Setfenv:<em>接受函数和新的环境作为参数。除了使用函数本身，还可以指定一个数字表示栈顶的活动函数。数字 1 代表当前函数，数字 2 代表调用当前函数的函数</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment to a new empty table</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;&#125;)</span><br><span class="line"><span class="built_in">print</span>(a)</span><br></pre></td></tr></table></figure>

<p>必须在单独的 chunk 内运行这段代码，如果你在交互模式逐行运行他，每一行都是一个不同的函数，调用 setfenv 只会影响他自己的那一行</p>
<p>封装: populate</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>

<p>继承封装</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span> <span class="comment">-- create a global variable</span></span><br><span class="line"><span class="comment">-- change current environment</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, &#123;<span class="built_in">_G</span> = <span class="built_in">_G</span>&#125;)</span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(a) <span class="comment">--&gt; nil</span></span><br><span class="line"><span class="built_in">_G</span>.<span class="built_in">print</span>(<span class="built_in">_G</span>.a) <span class="comment">--&gt; 1</span></span><br></pre></td></tr></table></figure>

<p>note:<em>当你创建一个新的函数时，他从创建他的函数继承了环境变量</em><br>note:<em>如果一个chunk 改变了他自己的环境，这个 chunk 所有在改变之后定义的函数都共享相同的环境，都会受到影响。这对创建<strong>命名空间</strong>是非常有用的机制</em></p>
<h2 id="15-package"><a href="#15-package" class="headerlink" title="15 package"></a>15 package</h2><p>note:<em>大多数语言中，packages 不是<strong>第一类值(first-class values)</strong>（也就是说，他们不能存储在变量里，不能作为函数参数。。。 ）</em></p>
<ul>
<li>对每一个函数定义都必须显示的在前面加上包的名称。</li>
<li>同一包内的函数<code>相互调用</code>必须在被调用函数前<strong>指定包名</strong>。</li>
</ul>
<p>缺点:</p>
<ul>
<li><em>修改函数的状态(公有变成私有或者私有变成公有)我们必须修改函数得*<em>调用方式</em></em>。*</li>
<li><em>访问同一个package 内的其他公有的实体写法冗余，必须加上前缀 P.。</em></li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">checkComplex</span> <span class="params">(c)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ((<span class="built_in">type</span>(c) == <span class="string">&quot;table&quot;</span>) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.r) <span class="keyword">and</span> <span class="built_in">tonumber</span>(c.i)) <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;bad complex number&quot;</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">new</span> <span class="params">(r, i)</span></span> <span class="keyword">return</span> &#123;r=r, i=i&#125; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span> <span class="params">(c1, c2)</span></span></span><br><span class="line">    checkComplex(c1);</span><br><span class="line">    checkComplex(c2);</span><br><span class="line">    <span class="keyword">return</span> new(c1.r + c2.r, c1.i + c2.i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 列表放在后面 因为必须首先定义局部函数</span></span><br><span class="line">complex = &#123;</span><br><span class="line">    new = new,</span><br><span class="line">    add = add,</span><br><span class="line">    <span class="built_in">sub</span> = <span class="built_in">sub</span>,</span><br><span class="line">    mul = mul,</span><br><span class="line">    div = div,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="15-3-package-file"><a href="#15-3-package-file" class="headerlink" title="15.3 package &amp; file"></a>15.3 package &amp; file</h3><pre><code>note:*当 require 加载一个文件的时候，它定义了一个变量来表示虚拟的文件名*

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 不需要 require 就可以使用 package</span></span><br><span class="line"><span class="keyword">local</span> P = &#123;&#125; <span class="comment">-- package</span></span><br><span class="line"><span class="keyword">if</span> _REQUIREDNAME == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    complex = P</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">_G</span>[_REQUIREDNAME] = P</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

note:*我们可以在同一个文件之内定义多个 packages，我们需要做的只是将每一个 package 放在一个 **do 代码块***内，这样 local 变量才能被限制在那个代码块中*

自动加载

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> location = &#123;</span><br><span class="line">foo = <span class="string">&quot;/usr/local/lua/lib/pack1_1.lua&quot;</span>,</span><br><span class="line">goo = <span class="string">&quot;/usr/local/lua/lib/pack1_1.lua&quot;</span>,</span><br><span class="line">foo1 = <span class="string">&quot;/usr/local/lua/lib/pack1_2.lua&quot;</span>,</span><br><span class="line">goo1 = <span class="string">&quot;/usr/local/lua/lib/pack1_3.lua&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pack1 = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">setmetatable</span>(pack1, &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, funcname)</span></span></span><br><span class="line">    <span class="keyword">local</span> file = location[funcname]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> file <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">error</span>(<span class="string">&quot;package pack1 does not define &quot;</span> .. funcname)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">assert</span>(<span class="built_in">loadfile</span>(file))()    <span class="comment">-- load and run definition</span></span><br><span class="line">    <span class="keyword">return</span> t[funcname]          <span class="comment">-- return the function</span></span><br><span class="line"><span class="keyword">end</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> pack1</span><br></pre></td></tr></table></figure>
</code></pre>
<h2 id="16-object-oriented-programming-面向对象程序设计"><a href="#16-object-oriented-programming-面向对象程序设计" class="headerlink" title="16 object-oriented programming 面向对象程序设计"></a>16 object-oriented programming 面向对象程序设计</h2><ul>
<li>示例代码 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Account = &#123;</span><br><span class="line">    balance=<span class="number">0</span>,</span><br><span class="line">    withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(self, v)</span></span></span><br><span class="line">        <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:deposit</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance + v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Account.deposit(Account, <span class="number">200.00</span>)</span><br><span class="line">Account:withdraw(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Account:new</span> <span class="params">(o)</span></span></span><br><span class="line">    o = o <span class="keyword">or</span> &#123;&#125; <span class="comment">-- create object if user does not provide one</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(o, <span class="built_in">self</span>)</span><br><span class="line">    <span class="built_in">self</span>.<span class="built_in">__index</span> = <span class="built_in">self</span></span><br><span class="line">    <span class="keyword">return</span> o</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">a = Account:new&#123;balance = <span class="number">0</span>&#125;</span><br><span class="line">a:deposit(<span class="number">100.00</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">getmetatable</span>(a).<span class="built_in">__index</span>.deposit(a, <span class="number">100.00</span>)</span><br><span class="line">Account.deposit(a, <span class="number">100.00</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="16-3-multiple-inheritance-多重继承"><a href="#16-3-multiple-inheritance-多重继承" class="headerlink" title="16.3 multiple inheritance 多重继承"></a>16.3 multiple inheritance 多重继承</h3><pre><code> 多重继承意味着一个类拥有多个父类
</code></pre>
<h3 id="16-4-private-私有性"><a href="#16-4-private-私有性" class="headerlink" title="16.4 private 私有性"></a>16.4 private 私有性</h3><pre><code> 通过闭包实现私有性

 <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newAccount</span> <span class="params">(initialBalance)</span></span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">self</span> = &#123;</span><br><span class="line">        balance = initialBalance,</span><br><span class="line">        LIM = <span class="number">10000.00</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> withdraw = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance - v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> deposit = <span class="function"><span class="keyword">function</span> <span class="params">(v)</span></span></span><br><span class="line">    <span class="built_in">self</span>.balance = <span class="built_in">self</span>.balance + v</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> extra = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">self</span>.balance &gt; <span class="built_in">self</span>.LIM <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">self</span>.balance*<span class="number">0.10</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> getBalance = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">self</span>.balance + <span class="built_in">self</span>.extra()</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">--local getBalance = function () return self.balance end</span></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        withdraw = withdraw,</span><br><span class="line">        deposit = deposit,</span><br><span class="line">        getBalance = getBalance</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">acc1 = newAccount(<span class="number">100.00</span>)</span><br><span class="line">acc1.withdraw(<span class="number">40.00</span>)</span><br><span class="line"><span class="built_in">print</span>(acc1.getBalance())    <span class="comment">--&gt; 60</span></span><br></pre></td></tr></table></figure>
</code></pre>
<h3 id="16-5-Single-Method-的对象实现方法"><a href="#16-5-Single-Method-的对象实现方法" class="headerlink" title="16.5 Single-Method 的对象实现方法"></a>16.5 Single-Method 的对象实现方法</h3><pre><code> <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">newObject</span> <span class="params">(value)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">(action, v)</span></span></span><br><span class="line">        <span class="keyword">if</span> action == <span class="string">&quot;get&quot;</span> <span class="keyword">then</span> <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">elseif</span> action == <span class="string">&quot;set&quot;</span> <span class="keyword">then</span> value = v</span><br><span class="line">        <span class="keyword">else</span> <span class="built_in">error</span>(<span class="string">&quot;invalid action&quot;</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">d = newObject(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">&quot;get&quot;</span>)) <span class="comment">--&gt; 0</span></span><br><span class="line">d(<span class="string">&quot;set&quot;</span>, <span class="number">10</span>)</span><br><span class="line"><span class="built_in">print</span>(d(<span class="string">&quot;get&quot;</span>)) <span class="comment">--&gt; 10</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<h2 id="17-weak-table"><a href="#17-weak-table" class="headerlink" title="17 weak table"></a>17 weak table</h2><p>一个 weak 引用是指<em>一个不被 Lua 认为是垃圾的对象的引用。</em><br>如果一个对象所有的引用指向都是weak，对象将被收集，而那些 weak 引用将会被删除。<br>如果一个对象只存在于 weak tables 中，Lua 将会最终将它收集。</p>
<p>三种类型的 weak tables：</p>
<ul>
<li><p>weak keys 组成的 tables；</p>
</li>
<li><p>weak values 组成的 tables；</p>
</li>
<li><p>以及纯 weak tables 类型，他们的 keys 和 values 都是 weak 的。</p>
<p>  表的 weak 性由他的 metatable 的__mode 域来指定的。</p>
  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">b = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(a, b)</span><br><span class="line">b.<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span> <span class="comment">-- now &#x27;a&#x27; has weak keys</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates first key</span></span><br><span class="line">a[&#123;key&#125;] = <span class="number">1</span></span><br><span class="line">key = &#123;&#125; <span class="comment">-- creates second key</span></span><br><span class="line">a[key] = <span class="number">2</span></span><br><span class="line"><span class="built_in">collectgarbage</span>() <span class="comment">-- forces a garbage collection cycle</span></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span> <span class="built_in">print</span>(v) <span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p>  第二个赋值语句 key&#x3D;{}覆盖了第一个 key 的值。当垃圾收集器工作时，在其他地方没有指向第一个 key 的引用，所以它被收集了</p>
<p>  note:<em>只有对象才可以从一个 weak table 中被收集。比如数字和布尔值类型的值，都是不会被收集的。</em></p>
<p>  example:*如果我们在 table 中插入了一个数值型的 key（在前面那个例子中），它将永远不会被收集器从 table 中移除。当然，如果对应于这个数值型 key 的 <strong>vaule</strong>被收集，那么它的整个入口将会从 weak table 中被移除。*</p>
<p>  note:<em>一个字符串不会从 weak tables 中被移除（除非它所关联的 vaule 被收集）</em></p>
<h3 id="17-1-记忆函数"><a href="#17-1-记忆函数" class="headerlink" title="17.1 记忆函数"></a>17.1 记忆函数</h3><p>  如果这个结果表中有 weak 值，每次的垃圾收集循环都会移除当前时间内所有未被使用的结果</p>
<pre><code>  <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> results = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(results, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;) <span class="comment">-- make values weak</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRGB</span> <span class="params">(r, g, b)</span></span></span><br><span class="line">    <span class="keyword">local</span> key = r .. <span class="string">&quot;-&quot;</span> .. g .. <span class="string">&quot;-&quot;</span> .. b</span><br><span class="line">    <span class="keyword">if</span> results[key] <span class="keyword">then</span> <span class="keyword">return</span> results[key]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> newcolor = &#123;red = r, green = g, blue = b&#125;</span><br><span class="line">        results[key] = newcolor</span><br><span class="line">        <span class="keyword">return</span> newcolor</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ul>
<blockquote>
<p>标准库</p>
</blockquote>
<h2 id="18-数学库"><a href="#18-数学库" class="headerlink" title="18. 数学库"></a>18. 数学库</h2><p>三角函数库（sin, cos, tan, asin, acos, etc.）<br>幂指函数（exp, log, log10），<br>舍入函数（floor, ceil）、<br>max、min，加上一个变量 pi。</p>
<p>所有的三角函数都在弧度单位下工作。<strong>（Lua4.0 以前在度数下工作。）</strong><br>你可以使用 <code>deg</code>和 <code>rad</code> 函数在度和弧度之间转换。</p>
<p>math.random 用来产生伪随机数，有三种调用方式：</p>
<ul>
<li>第一：不带参数，将产生 [0,1)范围内的随机数.</li>
<li>第二：带一个参数 n，将产生 1 &lt;&#x3D; x &lt;&#x3D; n 范围内的随机数 x.</li>
<li>第三：带两个参数 a 和 b,将产生 a &lt;&#x3D; x &lt;&#x3D; b 范围内的随机数 x.</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">math</span>.<span class="built_in">randomseed</span>(<span class="built_in">os</span>.<span class="built_in">time</span>())</span><br></pre></td></tr></table></figure>

<h2 id="19-table-lib"><a href="#19-table-lib" class="headerlink" title="19. table lib"></a>19. table lib</h2><p>table.getn table.setn 已经弃用</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;<span class="literal">nil</span>, <span class="number">1</span>, <span class="number">2</span>, key = <span class="string">&#x27;1234321&#x27;</span>, <span class="literal">nil</span>, <span class="number">15</span>, <span class="string">&#x27;sagewqgag&#x27;</span>, <span class="literal">nil</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">pairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(a) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;ddd&#x27;</span>,k,v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;len:&#x27;</span>,#a)</span><br></pre></td></tr></table></figure>

<p>ipairs iterate number index until first <code>nil</code><br>pairs iterate all except <code>nil</code><br>when <code>&#123;nil, 1, 2, key = &#39;1234321&#39;, nil, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 6<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, nil, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 2<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, 15, &#39;sagewqgag&#39;, nil&#125;</code>, #a &#x3D; 4<br>when <code>&#123;1, 2, key = &#39;1234321&#39;, 15, &#39;sagewqgag&#39;&#125;</code>, #a &#x3D; 4</p>
<p>table.insert 函数在 array指定位置插入一个元素，并<strong>将后面所有其他的元素后移。</strong></p>
<p>不带位置参数调用 insert，将会在 array<strong>最后位置</strong>插入元素（所以不需要元素移动）</p>
<p>note:<em>排序函数有两个参数并且如果在 array 中排序后第一个参数在第二个参数前面，排序函数必须返回 true。如果未提供排序函数，sort 使用默认的小于操作符进行比较</em></p>
<h2 id="20-string-lib"><a href="#20-string-lib" class="headerlink" title="20 string lib"></a>20 string lib</h2><p><code>string.len(s)</code>返回字符串 s 的长度；<br><code>string.rep(s,n)</code>返回重复 n 次字符串 s 的串；<br>你使用 <code>string.rep(&quot;a&quot;, 2^20)</code>可以创建一个 1M bytes 的字符串（比如，为了测试需要） ；<br><code>string.lower(s)</code>将 s 中的大写字母转换成小写（<code>string.upper</code>将小写转换成大写）<br><code>string.sub(s,i,j)</code>函数截取字符串 s 的从第 i 个字符到第 j 个字符之间的串。</p>
<p>Lua中，<em>字符串的第一个字符索引从 1 开始。你也可以使用负索引，负索引从字符串的结尾向前计数：-1 指向最后一个字符，-2 指向倒数第二个，以此类推。</em><br>note:<em>Lua 中的字符串是恒定不变的。String.sub 函数以及 Lua 中其他的字符串操作函数都不会改变字符串的值，而是返回一个新的字符串。</em><br>如果你想修改一个字符串变量的值，你必须将变量赋给一个新的字符串：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="number">2</span>, <span class="number">-2</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(<span class="number">97</span>)) <span class="comment">--&gt; a</span></span><br><span class="line">i = <span class="number">99</span>; <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">char</span>(i, i+<span class="number">1</span>, i+<span class="number">2</span>)) <span class="comment">--&gt; cde</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>)) <span class="comment">--&gt; 97</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>, <span class="number">2</span>)) <span class="comment">--&gt; 98</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">byte</span>(<span class="string">&quot;abc&quot;</span>, <span class="number">-1</span>)) <span class="comment">--&gt; 99</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;pi = %.4f&quot;</span>, PI)) <span class="comment">--&gt; pi = 3.1416</span></span><br><span class="line">d = <span class="number">5</span>; m = <span class="number">11</span>; y = <span class="number">1990</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;%02d/%02d/%04d&quot;</span>, d, m, y)) <span class="comment">--&gt; 05/11/1990</span></span><br><span class="line">tag, title = <span class="string">&quot;h1&quot;</span>, <span class="string">&quot;a title&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;&lt;%s&gt;%s&lt;/%s&gt;&quot;</span>, tag, title, tag)) <span class="comment">--&gt; &lt;h1&gt;a title&lt;/h1&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="20-1-pattern-matching-模式匹配"><a href="#20-1-pattern-matching-模式匹配" class="headerlink" title="20.1 pattern matching 模式匹配"></a>20.1 pattern matching 模式匹配</h3><p>Lua并不使用POSIX规范的正则表达式（也写作<strong>regexp</strong>）来进行模式匹配。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;hello world&quot;</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;hello&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 1 5</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, i, j)) <span class="comment">--&gt; hello</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;world&quot;</span>)) <span class="comment">--&gt; 7 11</span></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;l&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i, j) <span class="comment">--&gt; 3 3</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;lll&quot;</span>)) <span class="comment">--&gt; nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = &#123;&#125; <span class="comment">-- table to store the indices</span></span><br><span class="line"><span class="keyword">local</span> i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    i = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;\n&quot;</span>, i+<span class="number">1</span>) <span class="comment">-- find &#x27;next&#x27; newline</span></span><br><span class="line">    <span class="keyword">if</span> i == <span class="literal">nil</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(t, i)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;Lua is cute&quot;</span>, <span class="string">&quot;cute&quot;</span>, <span class="string">&quot;great&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx xii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;Lua is great&quot;</span>, <span class="string">&quot;perl&quot;</span>, <span class="string">&quot;tcl&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; Lua is great</span></span><br><span class="line"></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axl lii</span></span><br><span class="line">s = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;all lii&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;x&quot;</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(s) <span class="comment">--&gt; axx lii</span></span><br><span class="line">_, count = <span class="built_in">string</span>.<span class="built_in">gsub</span>(str, <span class="string">&quot; &quot;</span>, <span class="string">&quot; &quot;</span>)</span><br></pre></td></tr></table></figure>

<p>note:<em>_ 只是一个哑元变量</em></p>
<h3 id="20-2-pattern-模式"><a href="#20-2-pattern-模式" class="headerlink" title="20.2 pattern 模式"></a>20.2 pattern 模式</h3><pre><code>+ 匹配前一字符 1 次或多次
* 匹配前一字符 0 次或多次
- 匹配前一字符 0 次或多次
? 匹配前一字符 0 次或 1 次
&#39;[_%a][_%w]*&#39; 匹配 Lua 程序中的标示符：字母或者下划线开头的字母下划线数字序列。
匹配一对圆括号()或者括号之间的空白，可以使用 &#39;%(%s*%)&#39;
</code></pre>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;Deadline is 30/05/1999, firm&quot;</span></span><br><span class="line"><span class="built_in">date</span> = <span class="string">&quot;%d%d/%d%d/%d%d%d%d&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">sub</span>(s, <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="built_in">date</span>))) <span class="comment">--&gt; 30/05/1999</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;hello, up-down!&quot;</span>, <span class="string">&quot;%A&quot;</span>, <span class="string">&quot;.&quot;</span>)) <span class="comment">--&gt; hello..up.down. 4</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="string">&quot;one, and two; and three&quot;</span>, <span class="string">&quot;%a+&quot;</span>, <span class="string">&quot;word&quot;</span>)) <span class="comment">--&gt; word, word word; word word</span></span><br><span class="line"></span><br><span class="line">i, j = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="string">&quot;the number 1298 is even&quot;</span>, <span class="string">&quot;%d+&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(i,j) <span class="comment">--&gt; 12 15</span></span><br></pre></td></tr></table></figure>

<h3 id="20-3-matchings-捕获"><a href="#20-3-matchings-捕获" class="headerlink" title="20.3 matchings 捕获"></a>20.3 matchings 捕获</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pair = <span class="string">&quot;name = Anna&quot;</span></span><br><span class="line">_, _, key, value = <span class="built_in">string</span>.<span class="built_in">find</span>(pair, <span class="string">&quot;(%a+)%s*=%s*(%a+)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(key, value) <span class="comment">--&gt; name Anna</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">date</span> = <span class="string">&quot;17/7/1990&quot;</span></span><br><span class="line">_, _, d, m, y = <span class="built_in">string</span>.<span class="built_in">find</span>(<span class="built_in">date</span>, <span class="string">&quot;(%d+)/(%d+)/(%d+)&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(d, m, y) <span class="comment">--&gt; 17 7 1990</span></span><br><span class="line"></span><br><span class="line">s = <span class="string">[[then he said: &quot;it&#x27;s all right&quot;!]]</span></span><br><span class="line">a, b, c, quotedPart = <span class="built_in">string</span>.<span class="built_in">find</span>(s, <span class="string">&quot;([\&quot;&#x27;])(.-)%1&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(quotedPart) <span class="comment">--&gt; it&#x27;s all right</span></span><br><span class="line"><span class="built_in">print</span>(c) <span class="comment">--&gt; &quot;</span></span><br></pre></td></tr></table></figure>

<h2 id="21-IO-lib"><a href="#21-IO-lib" class="headerlink" title="21. IO lib"></a>21. IO lib</h2><h3 id="21-1-simple-I-O-mode"><a href="#21-1-simple-I-O-mode" class="headerlink" title="21.1 simple I&#x2F;O mode"></a>21.1 simple I&#x2F;O mode</h3><p>io.input 和 io.output 函数来改变当前文件。<br>例如io.input(filename)就是打开给定文件（以读模式），并将其设置为当前输入文件。<br>接下来所有的输入都来自于该文，直到再次使用 io.input。io.output 函数。<br>一旦产生错误两个函数都会产生错误。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="string">&quot;sin (3) = &quot;</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>), <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411200080598672</span></span><br><span class="line">&gt; <span class="built_in">io</span>.<span class="built_in">write</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;sin (3) = %.4f\n&quot;</span>, <span class="built_in">math</span>.<span class="built_in">sin</span>(<span class="number">3</span>)))</span><br><span class="line"><span class="comment">--&gt; sin (3) = 0.1411</span></span><br></pre></td></tr></table></figure>

<p>在编写代码时应当避免像 io.write(a..b..c)；这样的书写，这同 io.write(a,b,c)的效果是一样的。但是后者因为避免了串联操作，而消耗较少的资源。</p>
<p>Write 函数与 print 函数不同在于，write 不附加任何额外的字符到输出中去，例如制表符，换行符等等。<br>write 函数是使用当前输出文件，而 print 始终使用标准输出。<br>print函数会自动调用参数的 tostring方法，所以可以显示出表（tables）函数（functions）和 nil。</p>
<p>“*all” 读取整个文件<br>“*line” 读取下一行<br>“*number” 从串中转换出一个数值<br>num 读取 num 个字符到串</p>
<p>io.read(“*all”)函数从当前位置读取整个输入文件。如果当前位置在文件末尾，或者文件为空，函数将返回空串。<br>io.read(“*line”)函数返回当前输入文件的下一行（不包含最后的换行符）。当到达文件末尾，返回值为 nil（表示没有下一行可返回）<br><em>该读取方式是 read 函数的默认方式，所以可以简写为 io.read()。</em><br>io.read(“*number”)函数从当前输入文件中读取出一个数值。只有在该参数下 read 函数才返回数值，而不是字符串。<br>如果在当前位置找不到一个数字（由于格式不对，或者是到了文件的结尾），则返回 nil 可以对每个参数设置选项，函数将返回各自的结果。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">6.0 -3.23 15e12</span></span><br><span class="line"><span class="comment">4.3 234 1000001</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> n1, n2, n3 = <span class="built_in">io</span>.<span class="built_in">read</span>(<span class="string">&quot;*number&quot;</span>, <span class="string">&quot;*number&quot;</span>, <span class="string">&quot;*number&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> n1 <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">math</span>.<span class="built_in">max</span>(n1, n2, n3))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> size = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- good buffer size (8K)</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line"><span class="keyword">local</span> block = <span class="built_in">io</span>.<span class="built_in">read</span>(size)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> block <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">write</span>(block)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="21-2-complete-I-O-mode"><a href="#21-2-complete-I-O-mode" class="headerlink" title="21.2 complete I&#x2F;O mode"></a>21.2 complete I&#x2F;O mode</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> f = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(filename, <span class="string">&quot;r&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> t = f:<span class="built_in">read</span>(<span class="string">&quot;*all&quot;</span>)</span><br><span class="line">f:<span class="built_in">close</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> temp = <span class="built_in">io</span>.<span class="built_in">input</span>() <span class="comment">-- save current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(<span class="string">&quot;newinput&quot;</span>) <span class="comment">-- open a new current file</span></span><br><span class="line">... <span class="comment">-- do something with new input</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>():<span class="built_in">close</span>() <span class="comment">-- close current file</span></span><br><span class="line"><span class="built_in">io</span>.<span class="built_in">input</span>(temp) <span class="comment">-- restore previous current file</span></span><br></pre></td></tr></table></figure>

<p>I&#x2F;O 优化的一个小技巧:<br>通常 Lua 中读取整个文件要比一行一行的读取一个文件快的多。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">&quot;*line&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> BUFSIZE = <span class="number">2</span>^<span class="number">13</span> <span class="comment">-- 8K</span></span><br><span class="line"><span class="keyword">local</span> f = <span class="built_in">io</span>.<span class="built_in">input</span>(<span class="built_in">arg</span>[<span class="number">1</span>]) <span class="comment">-- open input file</span></span><br><span class="line"><span class="keyword">local</span> cc, lc, wc = <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span> <span class="comment">-- char, line, and word counts</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> <span class="built_in">lines</span>, rest = f:<span class="built_in">read</span>(BUFSIZE, <span class="string">&quot;*line&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">lines</span> <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> rest <span class="keyword">then</span> <span class="built_in">lines</span> = <span class="built_in">lines</span> .. rest .. <span class="string">&#x27;\n&#x27;</span> <span class="keyword">end</span></span><br><span class="line">    cc = cc + <span class="built_in">string</span>.<span class="built_in">len</span>(<span class="built_in">lines</span>)</span><br><span class="line">    <span class="comment">-- count words in the chunk</span></span><br><span class="line">    <span class="keyword">local</span> _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">&quot;%S+&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    wc = wc + t</span><br><span class="line">    <span class="comment">-- count newlines in the chunk</span></span><br><span class="line">    _,t = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">lines</span>, <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    lc = lc + t</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">print</span>(lc, wc, cc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> inp = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">1</span>], <span class="string">&quot;rb&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> out = <span class="built_in">assert</span>(<span class="built_in">io</span>.<span class="built_in">open</span>(<span class="built_in">arg</span>[<span class="number">2</span>], <span class="string">&quot;wb&quot;</span>))</span><br><span class="line"><span class="keyword">local</span> data = inp:<span class="built_in">read</span>(<span class="string">&quot;*all&quot;</span>)</span><br><span class="line">data = <span class="built_in">string</span>.<span class="built_in">gsub</span>(data, <span class="string">&quot;\r\n&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">out:<span class="built_in">write</span>(data)</span><br><span class="line"><span class="built_in">assert</span>(out:<span class="built_in">close</span>())</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fsize</span> <span class="params">(file)</span></span></span><br><span class="line"><span class="keyword">local</span> current = file:seek() <span class="comment">-- get current position</span></span><br><span class="line"><span class="keyword">local</span> size = file:seek(<span class="string">&quot;end&quot;</span>) <span class="comment">-- get file size</span></span><br><span class="line">file:seek(<span class="string">&quot;set&quot;</span>, current) <span class="comment">-- restore position</span></span><br><span class="line"><span class="keyword">return</span> size</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="22-system-lib-操作系统库"><a href="#22-system-lib-操作系统库" class="headerlink" title="22 system lib 操作系统库"></a>22 system lib 操作系统库</h2><p>Lua 是以 ANSI C 写成的</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- obs: 10800 = 3*60*60 (3 hours)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10800</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>, hour=<span class="number">0</span>, sec=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 10801</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">time</span>&#123;year=<span class="number">1970</span>, month=<span class="number">1</span>, day=<span class="number">1</span>&#125;)</span><br><span class="line"><span class="comment">--&gt; 54000 (obs: 54000 = 10800 + 12*60*60)</span></span><br><span class="line"></span><br><span class="line">temp = <span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;*t&quot;</span>, <span class="number">906000490</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">&#123;year = 1998, month = 9, day = 16, yday = 259, wday = 4,</span></span><br><span class="line"><span class="comment">hour = 23, min = 48, sec = 10, isdst = false&#125;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">%a abbreviated weekday name (e.g., Wed)</span></span><br><span class="line"><span class="comment">%A full weekday name (e.g., Wednesday)</span></span><br><span class="line"><span class="comment">%b abbreviated month name (e.g., Sep)</span></span><br><span class="line"><span class="comment">%B full month name (e.g., September)</span></span><br><span class="line"><span class="comment">%c date and time (e.g., 09/16/98 23:48:10)</span></span><br><span class="line"><span class="comment">%d day of the month (16) [01-31]</span></span><br><span class="line"><span class="comment">%H hour, using a 24-hour clock (23) [00-23]</span></span><br><span class="line"><span class="comment">%I hour, using a 12-hour clock (11) [01-12]</span></span><br><span class="line"><span class="comment">%M minute (48) [00-59]</span></span><br><span class="line"><span class="comment">%m month (09) [01-12]</span></span><br><span class="line"><span class="comment">%p either &quot;am&quot; or &quot;pm&quot; (pm)</span></span><br><span class="line"><span class="comment">%S second (10) [00-61]</span></span><br><span class="line"><span class="comment">%w weekday (3) [0-6 = Sunday-Saturday]</span></span><br><span class="line"><span class="comment">%x date (e.g., 09/16/98)</span></span><br><span class="line"><span class="comment">%X time (e.g., 23:48:10)</span></span><br><span class="line"><span class="comment">%Y full year (1998)</span></span><br><span class="line"><span class="comment">%y two-digit year (98) [00-99]</span></span><br><span class="line"><span class="comment">%% the character &#x27;%&#x27;</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 事实上如果不使用任何参数就调用 date，就是以%c 的形式输出。</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;today is %A, in %B&quot;</span>))</span><br><span class="line"><span class="comment">--&gt; today is Tuesday, in May</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">date</span>(<span class="string">&quot;%x&quot;</span>, <span class="number">906000490</span>))</span><br><span class="line"><span class="comment">--&gt; 09/16/1998</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">getenv</span>(<span class="string">&quot;HOME&quot;</span>)) <span class="comment">--&gt; /home/lua</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createDir</span> <span class="params">(dirname)</span></span></span><br><span class="line">    <span class="built_in">os</span>.<span class="built_in">execute</span>(<span class="string">&quot;mkdir &quot;</span> .. dirname)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h2 id="23-debug-lib"><a href="#23-debug-lib" class="headerlink" title="23. debug lib"></a>23. debug lib</h2><p>debug 库由两种函数组成：自省(<code>introspective</code>)函数和 <code>hooks</code>。</p>
<p>自省函数 <em>使得我们可以检查运行程序的某些方面，比如活动函数栈、当前执行代码的行号、本地变量的名和值。</em><br>Hooks <em>可以跟踪程序的执行情况。</em></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">debug</span>.<span class="built_in">getinfo</span>(foo)</span><br></pre></td></tr></table></figure>

<p>以数字 n 调用 <code>debug.getinfo(n)</code>时，返回在 <strong>n 级栈</strong>的活动函数的信息数据。<br>比如，如果 n&#x3D;1，返回的是正在进行调用的那个函数的信息。（n&#x3D;0 表示 C 函数 getinfo 本身）<br>如果 n 比栈中活动函数的个数大的话，debug.getinfo 返回 nil。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">traceback</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> level = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> info = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(level, <span class="string">&quot;Sl&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> info <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> info.what == <span class="string">&quot;C&quot;</span> <span class="keyword">then</span> <span class="comment">-- is a C function?</span></span><br><span class="line">            <span class="built_in">print</span>(level, <span class="string">&quot;C function&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span> <span class="comment">-- a Lua function</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;[%s]:%d&quot;</span>,</span><br><span class="line">            info.short_src, info.currentline))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        level = level + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--[[</span></span><br><span class="line"><span class="comment">a 10</span></span><br><span class="line"><span class="comment">b 20</span></span><br><span class="line"><span class="comment">x nil</span></span><br><span class="line"><span class="comment">a 4</span></span><br><span class="line"><span class="comment">]]</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span> <span class="params">(a,b)</span></span></span><br><span class="line">    <span class="keyword">local</span> x</span><br><span class="line">    <span class="keyword">do</span> <span class="keyword">local</span> c = a - b <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">local</span> a = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> name, value = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">1</span>, a)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> name <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="built_in">print</span>(name, value)</span><br><span class="line">        a = a + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">foo(<span class="number">10</span>, <span class="number">20</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getvarvalue</span> <span class="params">(name)</span></span></span><br><span class="line">    <span class="keyword">local</span> value, found</span><br><span class="line">    <span class="comment">-- try local variables</span></span><br><span class="line">    <span class="keyword">local</span> i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getlocal</span>(<span class="number">2</span>, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span></span><br><span class="line">        value = v</span><br><span class="line">        found = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> found <span class="keyword">then</span> <span class="keyword">return</span> value <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- try upvalues</span></span><br><span class="line">    <span class="keyword">local</span> func = <span class="built_in">debug</span>.<span class="built_in">getinfo</span>(<span class="number">2</span>).func</span><br><span class="line">    i = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span> <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> n, v = <span class="built_in">debug</span>.<span class="built_in">getupvalue</span>(func, i)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> n <span class="keyword">then</span> <span class="keyword">break</span> <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> n == name <span class="keyword">then</span> <span class="keyword">return</span> v <span class="keyword">end</span></span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- not found; get global</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">getfenv</span>(func)[name]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<h3 id="23-2-hooks"><a href="#23-2-hooks" class="headerlink" title="23.2 hooks"></a>23.2 hooks</h3><p>Lua 使用单个参数调用 hooks，参数为一个描述产生调用的事件：”call”、”return”、”line” 或 “count”。</p>
<p>有四种可以触发一个 hook 的事件：</p>
<ul>
<li>当 Lua 调用一个函数的时候 call 事件发生；</li>
<li>每次函数返回的时候，return 事件发生；</li>
<li>Lua 开始执行代码的新行时候，line 事件发生；</li>
<li>运行指定数目的指令之后，count 事件发生。</li>
</ul>
<blockquote>
<p>C API</p>
</blockquote>
<h2 id="24-C-API-Overview"><a href="#24-C-API-Overview" class="headerlink" title="24. C API Overview"></a>24. C API Overview</h2><p>Lua 解释器是一个使用 Lua 标准库实现的独立的解释器，她是一个很小的应用（总共不超过 500 行的代码）。</p>
<p>解释器负责程序和使用者的接口：<em>从使用者那里获取文件或者字符串，并传给 Lua 标准库，Lua 标准库负责最终的代码运行。</em></p>
<p>第一种，C 作为应用程序语言，Lua 作为一个<strong>库</strong>使用；<br>第二种，反过来，Lua 作为程序语言，C 作为库使用。</p>
<p>C API:<br>    - 读写 Lua 全局变量的函数，<br>    - 调用 Lua 函数的函数，<br>    - 运行 Lua 代码片断的函数，<br>    - 注册 C 函数然后可以在Lua 中被调用的函数，等等。</p>
<p>压栈函数:</p>
<pre><code>- 空值（nil）用 lua_pushnil，
- 数值型（double）用 lua_pushnumber，
- 布尔型（在 C 中用整数表示）用lua_pushboolean，
- 任意的字符串（char*类型，**允许包含&#39;\0&#39;字符**）用 lua_pushlstring，C语言风格（以&#39;\0&#39;结束）的字符串（const char*）用 lua_pushstring：
</code></pre>
<p>Lua 中的字符串不是以零为结束符的；它们依赖于一个明确的长度，因此可以包含任意的二进制数据。<br>Lua 从来不保持一个指向<strong>外部字符串</strong>（或任何其它对象，除了 C 函数——它总是静态指针）的指针。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int lua_checkstack (lua_State *L, int sz);</span><br></pre></td></tr></table></figure>

<p>lua_isnumber 和 lua_isstring 函数不检查这个值是否是指定的类型，而是看它<strong>是否能被转换成指定的那种类型</strong>。例如，任何数字类型都满足 lua_isstring</p>
<p>lua_type 函数，它返回栈中元素的类型。</p>
<p>给定的元素的类型不正确,lua_toboolean、lua_tonumber 和 lua_strlen 返回 0，其他函数返回 NULL</p>
<p>当一个 C 函数返回后，Lua 会清理他的栈</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *s = lua_tostring(L, <span class="number">-1</span>); <span class="comment">/* any Lua string */</span></span><br><span class="line"><span class="type">size_t</span> l = lua_strlen(L, <span class="number">-1</span>); <span class="comment">/* its length */</span></span><br><span class="line">assert(s[l] == <span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">assert(<span class="built_in">strlen</span>(s) &lt;= l);</span><br></pre></td></tr></table></figure>

<p>函数 lua_gettop 返回堆栈中的元素个数，它也是栈顶元素的索引</p>
<p>一个负数索引-x 对应于正数索引 gettop-x+1。</p>
<p>lua_settop 设置栈顶（也就是堆栈中的元素个数）为一个指定的值。<br>    - 如果开始的栈顶高于新的栈顶，顶部的值被丢弃。<br>    - 否则，为了得到指定的大小这个函数压入相应个数的空值（nil）到栈上。</p>
<p>lua_settop(L,0)清空堆栈。</p>
<p>函数 lua_pushvalue 压入堆栈上指定索引的一个抟贝到栈顶；<br>lua_remove 移除指定索引位置的元素，并将其上面所有的元素下移来填补这个位置的空白；<br>lua_insert 移动栈顶元素到指定索引的位置，并将这个索引位置上面的元素全部上移至栈顶被移动留下的空隔；<br>最后，lua_replace 从栈顶弹出元素值并将其设置到指定索引位置，没有任何移动操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">stackDump</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> top = lua_gettop(L);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">1</span>;i&lt;=top;i++)&#123; <span class="comment">/*repeatforeachlevel*/</span></span><br><span class="line">        <span class="type">int</span> t = lua_type(L, i);</span><br><span class="line">        <span class="keyword">switch</span> (t) &#123;</span><br><span class="line">        <span class="keyword">case</span> LUA_TSTRING: <span class="comment">/* strings */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;`%s&#x27;&quot;</span>, lua_tostring(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TBOOLEAN: <span class="comment">/* booleans */</span></span><br><span class="line">            <span class="built_in">printf</span>(lua_toboolean(L, i) ? <span class="string">&quot;true&quot;</span> : <span class="string">&quot;false&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LUA_TNUMBER: <span class="comment">/* numbers */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%g&quot;</span>, lua_tonumber(L, i));</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">/* other values */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, lua_typename(L, t)); </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot; &quot;</span>); <span class="comment">/* put a separator */</span> &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>); <span class="comment">/* end the listing */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">    lua_State *L = lua_open();</span><br><span class="line">    lua_pushboolean(L, <span class="number">1</span>); lua_pushnumber(L, <span class="number">10</span>);</span><br><span class="line">    lua_pushnil(L); lua_pushstring(L, <span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello&#x27; */</span></span><br><span class="line">    lua_pushvalue(L, <span class="number">-4</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 nil `hello&#x27; true */</span></span><br><span class="line">    lua_replace(L, <span class="number">3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello&#x27; */</span></span><br><span class="line">    lua_settop(L, <span class="number">6</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true `hello&#x27; nil nil */</span></span><br><span class="line">    lua_remove(L, <span class="number">-3</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true 10 true nil nil */</span></span><br><span class="line">    lua_settop(L, <span class="number">-5</span>); stackDump(L);</span><br><span class="line">    <span class="comment">/* true */</span></span><br><span class="line">    lua_close(L);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="24-3-C-API-exception-handler"><a href="#24-3-C-API-exception-handler" class="headerlink" title="24.3 C API exception handler"></a>24.3 C API exception handler</h3><p>当我们写一个库代码时（也就是被 Lua 调用的 C 函数）长跳转（long jump）的用处几乎和一个真正的异常处理一样的方便，因为 Lua 抓取了任务偶然的错误。</p>
<p>panic 函数<br>lua_pcall<br>lua_cpcall<br>luaL_error</p>
<h2 id="25-invoking-lua-function"><a href="#25-invoking-lua-function" class="headerlink" title="25. invoking lua function"></a>25. invoking lua function</h2><h2 id="26-invoking-C-function"><a href="#26-invoking-C-function" class="headerlink" title="26. invoking C function"></a>26. invoking C function</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">lua_pushcfunction(l, l_sin);</span><br><span class="line">lua_setglobal(l, <span class="string">&quot;mysin&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">l_sin</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">double</span> d = luaL_checknumber(L, <span class="number">1</span>);</span><br><span class="line">    lua_pushnumber(L, <span class="built_in">sin</span>(d));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* number of results */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// C函数库</span></span><br><span class="line">LUAMOD_API <span class="type">int</span></span><br><span class="line"><span class="title function_">luaopen_rmq_core</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_Reg l[] = &#123;</span><br><span class="line">        &#123; <span class="string">&quot;lwrite&quot;</span>, lrmq_write &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;pack&quot;</span>, lrmq_pack &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;unpack&quot;</span>, lrmq_unpack &#125;,</span><br><span class="line">        &#123; <span class="string">&quot;bind&quot;</span>, lrmq_bind &#125;,</span><br><span class="line">        &#123; <span class="literal">NULL</span>, <span class="literal">NULL</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    luaL_checkversion(L);</span><br><span class="line">    luaL_newlib(L,l);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="28-user-defined-types-in-C"><a href="#28-user-defined-types-in-C" class="headerlink" title="28. user-defined types in C"></a>28. user-defined types in C</h2><p>接口访问形式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a) <span class="comment">--&gt; userdata: 0x8064d48</span></span><br><span class="line"><span class="built_in">print</span>(array.size(a)) <span class="comment">--&gt; 1000</span></span><br><span class="line"><span class="keyword">for</span> i=<span class="number">1</span>,<span class="number">1000</span> <span class="keyword">do</span></span><br><span class="line">array.set(a, i, <span class="number">1</span>/i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">newarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">int</span> n = luaL_checkint(L, <span class="number">1</span>);</span><br><span class="line">    <span class="type">size_t</span> nbytes = <span class="keyword">sizeof</span>(NumArray) + (n - <span class="number">1</span>)*<span class="keyword">sizeof</span>(<span class="type">double</span>);</span><br><span class="line">    NumArray *a = (NumArray *)lua_newuserdata(L, nbytes);</span><br><span class="line">    luaL_getmetatable(L, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    a-&gt;size = n;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>; <span class="comment">/* new userdatum is already on the stack */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> NumArray *<span class="title function_">checkarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">void</span> *ud = luaL_checkudata(L, <span class="number">1</span>, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    luaL_argcheck(L, ud != <span class="literal">NULL</span>, <span class="number">1</span>, <span class="string">&quot;`array&#x27; expected&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (NumArray *)ud;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">getsize</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushnumber(L, a-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">double</span> *<span class="title function_">getelem</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    <span class="type">int</span> index = luaL_checkint(L, <span class="number">2</span>);</span><br><span class="line">    luaL_argcheck(L, <span class="number">1</span> &lt;= index &amp;&amp; index &lt;= a-&gt;size, <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;index out of range&quot;</span>);</span><br><span class="line">    <span class="comment">/* return element address */</span></span><br><span class="line">    <span class="keyword">return</span> &amp;a-&gt;values[index - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">setarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">double</span> newvalue = luaL_checknumber(L, <span class="number">3</span>);</span><br><span class="line">    *getelem(L) = newvalue;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">getarray</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    lua_pushnumber(L, *getelem(L));</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_f</span> [] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;new&quot;</span>, newarray&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">luaL_reg</span> <span class="title">arraylib_m</span> [] =</span> &#123;</span><br><span class="line">    &#123;<span class="string">&quot;__tostring&quot;</span>, array2string&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;set&quot;</span>, setarray&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;get&quot;</span>, getarray&#125;,</span><br><span class="line">    &#123;<span class="string">&quot;size&quot;</span>, getsize&#125;,</span><br><span class="line">    &#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">array2string</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    NumArray *a = checkarray(L);</span><br><span class="line">    lua_pushfstring(L, <span class="string">&quot;array(%d)&quot;</span>, a-&gt;size);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_array</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">&quot;LuaBook.array&quot;</span>);</span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    lua_pushvalue(L, <span class="number">-2</span>); <span class="comment">/* pushes the metatable */</span></span><br><span class="line">    lua_settable(L, <span class="number">-3</span>); <span class="comment">/* metatable.__index = metatable */</span></span><br><span class="line">    </span><br><span class="line">    luaL_openlib(L, <span class="literal">NULL</span>, arraylib_m, <span class="number">0</span>);</span><br><span class="line">    luaL_openlib(L, <span class="string">&quot;array&quot;</span>, arraylib_f, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>note:<em>luaL_openlib 的另一个特征，第一次调用，当我们传递一个 NULL作为库名时，luaL_openlib 并没有创建任何包含函数的表；相反，他认为封装函数的表在栈内，位于临时的 upvalues 的下面。</em></p>
<p>在这个例子中，封装函数的表是 metatable 本身，也就是 luaL_openlib 放置方法的地方。*</p>
<p>面向对象访问形式:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">a = array.new(<span class="number">1000</span>)</span><br><span class="line"><span class="built_in">print</span>(a:size()) <span class="comment">--&gt; 1000</span></span><br><span class="line">a:set(<span class="number">10</span>, <span class="number">3.4</span>)</span><br><span class="line"><span class="built_in">print</span>(a:get(<span class="number">10</span>)) <span class="comment">--&gt; 3.4</span></span><br></pre></td></tr></table></figure>

<h2 id="29-resource-managerment-资源管理"><a href="#29-resource-managerment-资源管理" class="headerlink" title="29. resource managerment 资源管理"></a>29. resource managerment 资源管理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="comment">/* forward declaration for the iterator function */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_iter</span> <span class="params">(lua_State *L)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">l_dir</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *path = luaL_checkstring(L, <span class="number">1</span>);</span><br><span class="line">    <span class="comment">/* create a userdatum to store a DIR address */</span></span><br><span class="line">    DIR **d = (DIR **)lua_newuserdata(L, <span class="keyword">sizeof</span>(DIR *));</span><br><span class="line">    <span class="comment">/* set its metatable */</span></span><br><span class="line">    luaL_getmetatable(L, <span class="string">&quot;LuaBook.dir&quot;</span>);</span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);</span><br><span class="line">    <span class="comment">/* try to open the given directory */</span></span><br><span class="line">    *d = opendir(path);</span><br><span class="line">    <span class="keyword">if</span> (*d == <span class="literal">NULL</span>) <span class="comment">/* error opening the directory? */</span></span><br><span class="line">    luaL_error(L, <span class="string">&quot;cannot open %s: %s&quot;</span>, path,</span><br><span class="line">    strerror(errno));</span><br><span class="line">    <span class="comment">/* creates and returns the iterator function</span></span><br><span class="line"><span class="comment">        (its sole upvalue, the directory userdatum,</span></span><br><span class="line"><span class="comment">        is already on the stack top */</span></span><br><span class="line">    lua_pushcclosure(L, dir_iter, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_iter</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, lua_upvalueindex(<span class="number">1</span>));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dirent</span> *<span class="title">entry</span>;</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = readdir(d)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    lua_pushstring(L, entry-&gt;d_name);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* no more values to return */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">dir_gc</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    DIR *d = *(DIR **)lua_touserdata(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (d) closedir(d);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">luaopen_dir</span> <span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    luaL_newmetatable(L, <span class="string">&quot;LuaBook.dir&quot;</span>);</span><br><span class="line">    <span class="comment">/* set its __gc field */</span></span><br><span class="line">    lua_pushstring(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">    lua_pushcfunction(L, dir_gc);</span><br><span class="line">    lua_settable(L, <span class="number">-3</span>);</span><br><span class="line">    <span class="comment">/* register the `dir&#x27; function */</span></span><br><span class="line">    lua_pushcfunction(L, l_dir);</span><br><span class="line">    lua_setglobal(L, <span class="string">&quot;dir&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Lua-版本更新记录"><a href="#Lua-版本更新记录" class="headerlink" title="Lua 版本更新记录"></a>Lua 版本更新记录</h2><h3 id="中文版"><a href="#中文版" class="headerlink" title="中文版"></a>中文版</h3><h4 id="自-Lua-5-3-以来的变化"><a href="#自-Lua-5-3-以来的变化" class="headerlink" title="自 Lua 5.3 以来的变化"></a>自 Lua 5.3 以来的变化</h4><p>以下是 Lua 5.4 引入的主要变化。参考手册列出了必须引入的不兼容性。</p>
<h5 id="主要变化"><a href="#主要变化" class="headerlink" title="主要变化"></a>主要变化</h5><ul>
<li>垃圾收集的新生代模式(新方法 意味着更频繁地启动较短的跟踪，仅涵盖最近创建的对象。 仅在短暂的爬网之后无法达到所需的内存消耗指标时，才执行所有对象的完全爬网。 这种方法可实现更高的性能和更低的内存消耗 在存储大量存在时间短的对象的情况下。)</li>
<li>待关闭变量</li>
<li>常量变量</li>
<li>userdata 可以有多个用户值</li>
<li>math.random 的新实现</li>
<li>警告系统</li>
<li>关于函数参数和返回值的调试信息</li>
<li>整数 ‘for’ 循环的新语义</li>
<li>可选的 ‘init’ 参数用于 ‘string.gmatch’</li>
<li>新函数 ‘lua_resetthread’ 和 ‘coroutine.close’</li>
<li>字符串到数字的强制转换移至字符串库</li>
<li>当缩小内存块时，允许分配函数失败</li>
<li>‘string.format’ 中的新格式 ‘%p’</li>
<li>utf8 库接受最多 2^31 的代码点</li>
</ul>
<h4 id="自-Lua-5-2-以来的变化"><a href="#自-Lua-5-2-以来的变化" class="headerlink" title="自 Lua 5.2 以来的变化"></a>自 Lua 5.2 以来的变化</h4><p>以下是 Lua 5.3 引入的主要变化。参考手册列出了必须引入的不兼容性。</p>
<h5 id="主要变化-1"><a href="#主要变化-1" class="headerlink" title="主要变化"></a>主要变化</h5><ul>
<li>整数（默认 64 位）</li>
<li>官方支持 32 位数字</li>
<li>位运算符</li>
<li>基本的 utf-8 支持</li>
<li>用于打包和解包值的函数</li>
<li>以下是 Lua 5.3 引入的其他变化：</li>
</ul>
<h5 id="语言"><a href="#语言" class="headerlink" title="语言"></a>语言</h5><ul>
<li>userdata 可以有任何 Lua 值作为用户值</li>
<li>向下取整除法</li>
<li>一些元方法的更灵活规则</li>
</ul>
<h5 id="库"><a href="#库" class="headerlink" title="库"></a>库</h5><ul>
<li>ipairs 和 table 库尊重元方法</li>
<li>string.dump 中的 strip 选项</li>
<li>table 库尊重元方法</li>
<li>新函数 table.move</li>
<li>新函数 string.pack</li>
<li>新函数 string.unpack</li>
<li>新函数 string.packsize</li>
</ul>
<h5 id="C-API"><a href="#C-API" class="headerlink" title="C API"></a>C API</h5><ul>
<li>更简单的 C 中的延续函数 API</li>
<li>lua_gettable 和类似函数返回结果值的类型</li>
<li>lua_dump 中的 strip 选项</li>
<li>新函数：lua_geti</li>
<li>新函数：lua_seti</li>
<li>新函数：lua_isyieldable</li>
<li>新函数：lua_numbertointeger</li>
<li>新函数：lua_rotate</li>
<li>新函数：lua_stringtonumber</li>
</ul>
<h5 id="Lua-独立解释器"><a href="#Lua-独立解释器" class="headerlink" title="Lua 独立解释器"></a>Lua 独立解释器</h5><ul>
<li>可用作计算器；无需前缀 ‘&#x3D;’</li>
<li>arg 表对所有代码可用</li>
</ul>
<h4 id="自-Lua-5-1-以来的变化"><a href="#自-Lua-5-1-以来的变化" class="headerlink" title="自 Lua 5.1 以来的变化"></a>自 Lua 5.1 以来的变化</h4><p>以下是 Lua 5.2 引入的主要变化。参考手册列出了必须引入的不兼容性。</p>
<h5 id="主要变化-2"><a href="#主要变化-2" class="headerlink" title="主要变化"></a>主要变化</h5><ul>
<li>可挂起的 pcall 和元方法</li>
<li>全局变量的新词法方案</li>
<li>短命表</li>
<li>位运算的新库</li>
<li>轻量级 C 函数</li>
<li>紧急垃圾收集器</li>
<li>goto 语句</li>
<li>表的终结器<br>以下是 Lua 5.2 引入的其他变化：</li>
</ul>
<h5 id="语言-1"><a href="#语言-1" class="headerlink" title="语言"></a>语言</h5><ul>
<li>线程或函数不再有 fenv</li>
<li>表尊重 __len 元方法</li>
<li>字符串中的十六进制和 \z 转义</li>
<li>支持十六进制浮点数</li>
<li>不同类型的顺序元方法</li>
<li>不再验证操作码一致性</li>
<li>钩子事件 “tail return” 被 “tail call” 取代</li>
<li>空语句</li>
<li>break 语句可以出现在块的中间</li>
</ul>
<h5 id="库-1"><a href="#库-1" class="headerlink" title="库"></a>库</h5><ul>
<li>通过 xpcall 调用的函数的参数</li>
<li>load 和 loadfile 的可选 ‘mode’ 参数（控制二进制 x 文本）</li>
<li>load 和 loadfile 的可选 ‘env’ 参数（加载块的环境）</li>
<li>loadlib 可以加载具有全局名称的库（RTLD_GLOBAL）</li>
<li>新函数 package.searchpath</li>
<li>模块加载时接收它们的路径</li>
<li>math.log 中的可选基数</li>
<li>string.rep 中的可选分隔符</li>
<li>file:write 返回文件</li>
<li>关闭管道返回退出状态</li>
<li>os.exit 可以关闭状态</li>
<li>新元方法 __pairs 和 __ipairs</li>
<li>collectgarbage 和 lua_gc 的新选项 ‘isrunning’</li>
<li>边界模式</li>
<li>模式中的 \0</li>
<li>io.read 的新选项 *L</li>
<li>io.lines 的选项</li>
<li>debug.getlocal 可以访问函数的可变参数</li>
</ul>
<h5 id="C-API-1"><a href="#C-API-1" class="headerlink" title="C API"></a>C API</h5><ul>
<li>注册表中预定义的主线程</li>
<li>新函数 lua_absindex, lua_arith, lua_compare, lua_copy, lua_len, lua_rawgetp, lua_rawsetp, lua_upvalueid, lua_upvaluejoin, lua_version.</li>
<li>新函数 luaL_checkversion, luaL_setmetatable, luaL_testudata, luaL_tolstring.</li>
<li>lua_pushstring 和 pushlstring 返回字符串</li>
<li>debug API 中可用的 nparams 和 isvararg</li>
<li>新的 lua_Unsigned</li>
</ul>
<h5 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h5><ul>
<li>每个函数的最大常量提高到 226</li>
<li>垃圾收集的代际模式（实验性）</li>
<li>NaN 技巧（实验性）</li>
<li>ctypes 的内部（不可变）版本</li>
<li>字符串缓冲区的更简单实现</li>
<li>解析器使用更少的 C 栈空间（不再有自动数组）</li>
</ul>
<h5 id="Lua-独立解释器-1"><a href="#Lua-独立解释器-1" class="headerlink" title="Lua 独立解释器"></a>Lua 独立解释器</h5><ul>
<li>新的 -E 选项以避免环境变量</li>
<li>处理非字符串错误消息</li>
</ul>
<h3 id="英文原版"><a href="#英文原版" class="headerlink" title="英文原版"></a>英文原版</h3><h4 id="Changes-since-Lua-5-3"><a href="#Changes-since-Lua-5-3" class="headerlink" title="Changes since Lua 5.3"></a>Changes since Lua 5.3</h4><p>Here are the main changes introduced in Lua 5.4. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes"><a href="#Main-changes" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>new generational mode for garbage collection</li>
<li>to-be-closed variables</li>
<li>const variables</li>
<li>userdata can have multiple user values</li>
<li>new implementation for math.random</li>
<li>warning system</li>
<li>debug information about function arguments and returns</li>
<li>new semantics for the integer ‘for’ loop</li>
<li>optional ‘init’ argument to ‘string.gmatch’</li>
<li>new functions ‘lua_resetthread’ and ‘coroutine.close’</li>
<li>string-to-number coercions moved to the string library</li>
<li>allocation function allowed to fail when shrinking a memory block</li>
<li>new format ‘%p’ in ‘string.format’</li>
<li>utf8 library accepts codepoints up to 2^31</li>
</ul>
<h4 id="Changes-since-Lua-5-2"><a href="#Changes-since-Lua-5-2" class="headerlink" title="Changes since Lua 5.2"></a>Changes since Lua 5.2</h4><p>Here are the main changes introduced in Lua 5.3. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes-1"><a href="#Main-changes-1" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>integers (64-bit by default)</li>
<li>official support for 32-bit numbers</li>
<li>bitwise operators</li>
<li>basic utf-8 support</li>
<li>functions for packing and unpacking values</li>
<li>Here are the other changes introduced in Lua 5.3:</li>
</ul>
<h5 id="Language"><a href="#Language" class="headerlink" title="Language"></a>Language</h5><ul>
<li>userdata can have any Lua value as uservalue</li>
<li>floor division</li>
<li>more flexible rules for some metamethods</li>
</ul>
<h5 id="Libraries"><a href="#Libraries" class="headerlink" title="Libraries"></a>Libraries</h5><ul>
<li>ipairs and the table library respect metamethods</li>
<li>strip option in string.dump</li>
<li>table library respects metamethods</li>
<li>new function table.move</li>
<li>new function string.pack</li>
<li>new function string.unpack</li>
<li>new function string.packsize</li>
</ul>
<h5 id="C-API-2"><a href="#C-API-2" class="headerlink" title="C API"></a>C API</h5><ul>
<li>simpler API for continuation functions in C</li>
<li>lua_gettable and similar functions return type of resulted value</li>
<li>strip option in lua_dump</li>
<li>new function: lua_geti</li>
<li>new function: lua_seti</li>
<li>new function: lua_isyieldable</li>
<li>new function: lua_numbertointeger</li>
<li>new function: lua_rotate</li>
<li>new function: lua_stringtonumber</li>
</ul>
<h5 id="Lua-standalone-interpreter"><a href="#Lua-standalone-interpreter" class="headerlink" title="Lua standalone interpreter"></a>Lua standalone interpreter</h5><ul>
<li>can be used as calculator; no need to prefix with ‘&#x3D;’</li>
<li>arg table available to all code</li>
</ul>
<h4 id="Changes-since-Lua-5-1"><a href="#Changes-since-Lua-5-1" class="headerlink" title="Changes since Lua 5.1"></a>Changes since Lua 5.1</h4><p>Here are the main changes introduced in Lua 5.2. The reference manual lists the incompatibilities that had to be introduced.</p>
<h5 id="Main-changes-2"><a href="#Main-changes-2" class="headerlink" title="Main changes"></a>Main changes</h5><ul>
<li>yieldable pcall and metamethods</li>
<li>new lexical scheme for globals</li>
<li>ephemeron tables</li>
<li>new library for bitwise operations</li>
<li>light C functions</li>
<li>emergency garbage collector</li>
<li>goto statement</li>
<li>finalizers for tables<br>Here are the other changes introduced in Lua 5.2:</li>
</ul>
<h5 id="Language-1"><a href="#Language-1" class="headerlink" title="Language"></a>Language</h5><ul>
<li>no more fenv for threads or functions</li>
<li>tables honor the __len metamethod</li>
<li>hex and \z escapes in strings</li>
<li>support for hexadecimal floats</li>
<li>order metamethods work for different types</li>
<li>no more verification of opcode consistency</li>
<li>hook event “tail return” replaced by “tail call”</li>
<li>empty statement</li>
<li>break statement may appear in the middle of a block</li>
</ul>
<h5 id="Libraries-1"><a href="#Libraries-1" class="headerlink" title="Libraries"></a>Libraries</h5><ul>
<li>arguments for function called through xpcall</li>
<li>optional ‘mode’ argument to load and loadfile (to control binary x text)</li>
<li>optional ‘env’ argument to load and loadfile (environment for loaded chunk)</li>
<li>loadlib may load libraries with global names (RTLD_GLOBAL)</li>
<li>new function package.searchpath</li>
<li>modules receive their paths when loaded</li>
<li>optional base in math.log</li>
<li>optional separator in string.rep</li>
<li>file:write returns file</li>
<li>closing a pipe returns exit status</li>
<li>os.exit may close state</li>
<li>new metamethods __pairs and __ipairs</li>
<li>new option ‘isrunning’ for collectgarbage and lua_gc</li>
<li>frontier patterns</li>
<li>\0 in patterns</li>
<li>new option *L for io.read</li>
<li>options for io.lines</li>
<li>debug.getlocal can access function varargs</li>
</ul>
<h5 id="C-API-3"><a href="#C-API-3" class="headerlink" title="C API"></a>C API</h5><ul>
<li>main thread predefined in the registry</li>
<li>new functions lua_absindex, lua_arith, lua_compare, lua_copy, lua_len, lua_rawgetp, lua_rawsetp, lua_upvalueid, lua_upvaluejoin, lua_version.</li>
<li>new functions luaL_checkversion, luaL_setmetatable, luaL_testudata, luaL_tolstring.</li>
<li>lua_pushstring and pushlstring return string</li>
<li>nparams and isvararg available in debug API</li>
<li>new lua_Unsigned</li>
</ul>
<h5 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h5><ul>
<li>max constants per function raised to 226</li>
<li>generational mode for garbage collection (experimental)</li>
<li>NaN trick (experimental)</li>
<li>internal (immutable) version of ctypes</li>
<li>simpler implementation for string buffers</li>
<li>parser uses much less C-stack space (no more auto arrays)</li>
</ul>
<h5 id="Lua-standalone-interpreter-1"><a href="#Lua-standalone-interpreter-1" class="headerlink" title="Lua standalone interpreter"></a>Lua standalone interpreter</h5><ul>
<li>new -E option to avoid environment variables</li>
<li>handling of non-string error messages</li>
</ul>
<h2 id="Lua-5-4-版本更新"><a href="#Lua-5-4-版本更新" class="headerlink" title="Lua 5.4 版本更新"></a>Lua 5.4 版本更新</h2><p>Lua5.4已经进入rc(Release Candidate)状态，相信很快就会发布正式版。这个版本在语言层面上修改的东西并不多，但是默认的GC被换成了“分代式GC”，这对于那些经常产生短期对象的程序应该会有很明显的性能提升。GC带来的负担永远是自动内存管理语言的一大痛点，如果能在这一点上取得突破，那肯定比提供更多语法糖来得有价值。</p>
<p>此外5.4可以指定局部变量的属性，用这样的语法：</p>
<p>local a <NAME> &#x3D; 3<br>NAME可以是const或close，为const时表示const变量(const variables)，const变量可以帮助编译器作一些优化，比如下面的代码：</p>
<p>local a <const> &#x3D; 4<br>local b &#x3D; a + 7<br>print(b)<br>编译器会把a消除掉，直接给b赋11。这种优化是有限的，对于基本类型和字符串，能够有效减少寄存器的访问，但对于table貌似益处不大。代码文件如果需要一些数值常量，可以写成const变量，比如：</p>
<p>local MAX_LEN <const> &#x3D; 20<br>function check_name(name)<br>    return #name &lt;&#x3D; MAX_LEN<br>end<br>在check_name中就没有upvalue的访问，而是直接转换成和20的比较。</p>
<p>close变量(To-be-closed Variables)需要和close元方法结合使用，在变量超出作用域时，会调用变量的close元方法，这听起来是不是有点像C++的RAII用法。下面是一个例子：</p>
<p>local function newlock()<br>    local lock &#x3D; {<br>        acquire &#x3D; function()<br>            print(“acquire lock”)<br>        end,<br>        release &#x3D; function()<br>            print(“release lock”)<br>        end,<br>    }<br>    return lock<br>end</p>
<p>local function lockguard(lock)<br>    local wrap &#x3D; {<br>        lock &#x3D; lock<br>    }<br>    lock.acquire()<br>    return setmetatable(wrap, {__close &#x3D; function(t, err)<br>        t.lock.release()<br>    end})<br>end</p>
<p>local lock &#x3D; newlock()<br>do<br>    for i &#x3D; 1, 3 do<br>        local l <close> &#x3D; lockguard(lock)<br>        print(i)<br>        error(“err”)<br>    end<br>end<br>定义local l <close>后，无论是否有错误，release都能得到调用；从这个例子也可以看出，close变量一般用于需要及时释放资源的情况；否则Lua的GC可以应付大多数情况。</p>
<p>除了上面提到的特性，还有一些新的修改罗列如下：</p>
<p>userdata现在可以关联多个user值，C的API也有相应的修改，如果我们新建的userdata没有关联值，则尽量使用lua_newuserdatauv，这样更高效，lua_newuserdata仅仅为了兼容，且默认会关联1个值。<br>math.random使用了新的算法。<br>协程库提供了新的APIcoroutine.close和lua_resetthread，coroutine.close只能在挂起或死亡状态下调用，挂起状态下会使用协程进入死亡状态，并且关闭所有的close变量。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://zirpon.github.io">チャン ゼプン</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">https://zirpon.github.io/2019/04/06/lua-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://zirpon.github.io" target="_blank">Zepung🐉Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/lua/">lua</a></div><div class="post-share"><div class="social-share" data-image="/img/404-bg.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2019/03/04/Golang-%E6%BA%90%E7%A0%81-CentOS-%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85-note/" title="Golang 源码编译安装 CentOS 7 note"><img class="cover" src="/img/header_img/tag-bg.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">Golang 源码编译安装 CentOS 7 note</div></div><div class="info-2"><div class="info-item-1">1. Prefix 需要下载的文件: Download  go1.12.src.tar.gz go1.4.3.src.tar.gz gcc glibc-devel   go1.4以上版本安装 依赖 go1.4 需要先编译安装go1.4, 否则会报错 (这个设定 很奇怪 不过 never mind just do it) 报错提示信息如下:  123Building Go cmd/dist using /root/go1.4.ERROR: Cannot find /root/go1.4/bin/go.Set $GOROOT_BOOTSTRAP to a working Go tree &gt;= Go 1.4. 安装 gcc 用于编译 go 1.4 1yum install -y gcc glibc-devel  2. Install go1.4.3.src.tar.gz2.1 安装 go1.4.31234mkdir /root/go1.4tar -xvf go1.4.3.src.tar.gz -C /root/go1.4cd...</div></div></div></a><a class="pagination-related" href="/2021/01/06/%E5%81%A5%E8%BA%AB%E7%AC%94%E8%AE%B0/" title="健身笔记"><img class="cover" src="/img/header_img/roman.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">健身笔记</div></div><div class="info-2"><div class="info-item-1"> 胸： 飞鸟 推举 俯卧撑背： 哑铃单臂划船 引体向上 悬挂带反向划船 俯卧撑 让背部两块肌肉夹紧的动作肩： 肩推 侧平举 面拉 耸肩腿： 只能深蹲 高位臀桥臂：臂屈伸 二头弯举 三头拉伸(扶墙拿水瓶向后拉伸) 单个水瓶1.1kg 不力竭换 大水瓶或者哑铃    胸 背 肩 腿 手臂                                                     ...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Begin"><span class="toc-text">1. Begin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-chunk"><span class="toc-text">1.1 chunk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4-lua-command-line"><span class="toc-text">1.4 lua command line</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-lua-basic-type"><span class="toc-text">2. lua basic type</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-string"><span class="toc-text">2.4 string</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-Function"><span class="toc-text">2.5 Function</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6-Userdata-and-Threads"><span class="toc-text">2.6 Userdata and Threads</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-expression-%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-text">3. expression 表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Relational-operators"><span class="toc-text">3.2 Relational operators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-logical-operator-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-text">3.3 logical operator 逻辑运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-operator-priority-%E4%BC%98%E5%85%88%E7%BA%A7"><span class="toc-text">3.5 operator priority 优先级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6-table-constructor-%E8%A1%A8%E7%9A%84%E6%9E%84%E9%80%A0"><span class="toc-text">3.6 table constructor 表的构造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-basic-syntax-%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95"><span class="toc-text">4. basic syntax 基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-local-variable-code-block-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F-%E4%BB%A3%E7%A0%81%E5%9D%97"><span class="toc-text">4.2  local variable &amp; code block 局部变量 代码块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-break-return"><span class="toc-text">4.3 break return</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-function"><span class="toc-text">5. function</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-multi-result-return"><span class="toc-text">5.1 multi result return</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-variable-parameter-%E5%8F%AF%E5%8F%98%E5%8F%82%E6%95%B0"><span class="toc-text">5.2 variable parameter 可变参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-named-parameter-%E5%91%BD%E5%90%8D%E5%8F%82%E6%95%B0"><span class="toc-text">5.3 named parameter 命名参数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-function-plus-%E5%86%8D%E8%AE%BA%E5%87%BD%E6%95%B0"><span class="toc-text">6. function plus 再论函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-proper-tail-calls-%E5%B0%BE%E8%B0%83%E7%94%A8"><span class="toc-text">6.3 proper tail calls 尾调用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-iterator-genericity-for-%E8%BF%AD%E4%BB%A3%E5%99%A8-%E6%B3%9B%E5%9E%8Bfor"><span class="toc-text">7. iterator &amp; genericity for 迭代器 泛型for</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-genericity-for-%E6%B3%9B%E5%9E%8B-for-%E7%9A%84%E8%AF%AD%E4%B9%89"><span class="toc-text">7.2 genericity for 泛型 for 的语义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-iterator-without-status-%E6%97%A0%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">7.3 iterator without status 无状态的迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-3-multi-status-iterator-%E5%A4%9A%E7%8A%B6%E6%80%81%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">7.3 multi status iterator 多状态的迭代器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-compile-run-debug-%E7%BC%96%E8%AF%91-%E8%BF%90%E8%A1%8C-%E8%B0%83%E8%AF%95"><span class="toc-text">8. compile run debug 编译 运行 调试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-1-require"><span class="toc-text">8.1 require</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-C-Packages"><span class="toc-text">8.2 C Packages</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-error-%E9%94%99%E8%AF%AF"><span class="toc-text">8.3 error 错误</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-4-exception-pcall"><span class="toc-text">8.4 exception &amp; pcall</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-5-exception-msg-xpcall"><span class="toc-text">8.5 exception msg &amp; xpcall</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-0-coroutine"><span class="toc-text">9.0 coroutine</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-filter-%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="toc-text">9.2 filter 过滤器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-3-iterator-%E8%BF%AD%E4%BB%A3%E5%99%A8"><span class="toc-text">9.3 iterator 迭代器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-4-pre-emptive-multi-thread-%E9%9D%9E%E6%8A%A2%E5%8D%A0%E5%BC%8F%E5%A4%9A%E7%BA%BF%E7%A8%8B"><span class="toc-text">9.4 pre-emptive multi thread 非抢占式多线程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-datastruct"><span class="toc-text">11. datastruct</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#11-1-array-%E6%95%B0%E7%BB%84"><span class="toc-text">11.1 array 数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-2-matrix-multidimensional-array-%E9%98%B5-%E5%A4%9A%E7%BB%B4%E6%95%B0%E7%BB%84"><span class="toc-text">11.2 matrix &amp; multidimensional array 阵 多维数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-3-linked-list-s%E9%93%BE%E8%A1%A8"><span class="toc-text">11.3 linked list s链表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-4-queen-dique-s%E9%98%9F%E5%88%97-%E5%8F%8C%E7%AB%AF%E9%98%9F%E5%88%97"><span class="toc-text">11.4 queen &amp; dique s队列 双端队列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-5-set-package-%E9%9B%86%E5%90%88-%E5%8C%85"><span class="toc-text">11.5 set &amp; package 集合 包</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11-6-string-buffer-%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%BC%93%E5%86%B2"><span class="toc-text">11.6 string buffer 字符串缓冲</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-data-file-storage-Persistence-%E6%95%B0%E6%8D%AE%E6%96%87%E4%BB%B6%E4%B8%8E%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">12. data file storage &amp; Persistence 数据文件与持久化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-metatables-metamethods"><span class="toc-text">13. metatables metamethods</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#13-1-arithmetic-operation-metamethods-%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%9A%84-matamethods"><span class="toc-text">13.1  arithmetic operation metamethods 算术运算的 matamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-2-relational-operation-metamethods-%E5%85%B3%E7%B3%BB%E8%BF%90%E7%AE%97%E7%9A%84-metamethods"><span class="toc-text">13.2 relational operation metamethods 关系运算的 metamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-3-others-metamethods"><span class="toc-text">13.3 others metamethods</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#13-4-table-relative-metamethods-%E8%A1%A8%E7%9B%B8%E5%85%B3-metamethods"><span class="toc-text">13.4 table relative metamethods 表相关 metamethods</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-1-The-index-Metamethod"><span class="toc-text">13.4.1 The __index Metamethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-2-The-newindex-Metamethod"><span class="toc-text">13.4.2 The __newindex Metamethod</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-3-table-default-value-%E6%9C%89%E9%BB%98%E8%AE%A4%E5%80%BC%E7%9A%84%E8%A1%A8"><span class="toc-text">13.4.3 table default value 有默认值的表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-4-table-monitor-%E7%9B%91%E6%8E%A7%E8%A1%A8"><span class="toc-text">13.4.4 table monitor 监控表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#13-4-5-readonly-table-%E5%8F%AA%E8%AF%BB%E8%A1%A8"><span class="toc-text">13.4.5 readonly table 只读表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-environment-%E7%8E%AF%E5%A2%83"><span class="toc-text">14. environment 环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#14-1-dynamic-access-global-value-%E4%BD%BF%E7%94%A8%E5%8A%A8%E6%80%81%E5%90%8D%E5%AD%97%E8%AE%BF%E9%97%AE%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">14.1 dynamic access global value 使用动态名字访问全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-2-delcare-global-value-%E5%A3%B0%E6%98%8E%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-text">14.2 delcare global value 声明全局变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#14-3-un-global-environment-%E9%9D%9E%E5%85%A8%E5%B1%80%E7%9A%84%E7%8E%AF%E5%A2%83"><span class="toc-text">14.3 un-global environment 非全局的环境</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#15-package"><span class="toc-text">15 package</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#15-3-package-file"><span class="toc-text">15.3 package &amp; file</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#16-object-oriented-programming-%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1"><span class="toc-text">16 object-oriented programming 面向对象程序设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#16-3-multiple-inheritance-%E5%A4%9A%E9%87%8D%E7%BB%A7%E6%89%BF"><span class="toc-text">16.3 multiple inheritance 多重继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-4-private-%E7%A7%81%E6%9C%89%E6%80%A7"><span class="toc-text">16.4 private 私有性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#16-5-Single-Method-%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%B3%95"><span class="toc-text">16.5 Single-Method 的对象实现方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#17-weak-table"><span class="toc-text">17 weak table</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#17-1-%E8%AE%B0%E5%BF%86%E5%87%BD%E6%95%B0"><span class="toc-text">17.1 记忆函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#18-%E6%95%B0%E5%AD%A6%E5%BA%93"><span class="toc-text">18. 数学库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#19-table-lib"><span class="toc-text">19. table lib</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#20-string-lib"><span class="toc-text">20 string lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#20-1-pattern-matching-%E6%A8%A1%E5%BC%8F%E5%8C%B9%E9%85%8D"><span class="toc-text">20.1 pattern matching 模式匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-2-pattern-%E6%A8%A1%E5%BC%8F"><span class="toc-text">20.2 pattern 模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#20-3-matchings-%E6%8D%95%E8%8E%B7"><span class="toc-text">20.3 matchings 捕获</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#21-IO-lib"><span class="toc-text">21. IO lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#21-1-simple-I-O-mode"><span class="toc-text">21.1 simple I&#x2F;O mode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#21-2-complete-I-O-mode"><span class="toc-text">21.2 complete I&#x2F;O mode</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#22-system-lib-%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%BA%93"><span class="toc-text">22 system lib 操作系统库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#23-debug-lib"><span class="toc-text">23. debug lib</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#23-2-hooks"><span class="toc-text">23.2 hooks</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#24-C-API-Overview"><span class="toc-text">24. C API Overview</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#24-3-C-API-exception-handler"><span class="toc-text">24.3 C API exception handler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#25-invoking-lua-function"><span class="toc-text">25. invoking lua function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#26-invoking-C-function"><span class="toc-text">26. invoking C function</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#28-user-defined-types-in-C"><span class="toc-text">28. user-defined types in C</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#29-resource-managerment-%E8%B5%84%E6%BA%90%E7%AE%A1%E7%90%86"><span class="toc-text">29. resource managerment 资源管理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0%E8%AE%B0%E5%BD%95"><span class="toc-text">Lua 版本更新记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%AD%E6%96%87%E7%89%88"><span class="toc-text">中文版</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-3-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">自 Lua 5.3 以来的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96"><span class="toc-text">主要变化</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-2-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">自 Lua 5.2 以来的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96-1"><span class="toc-text">主要变化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80"><span class="toc-text">语言</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93"><span class="toc-text">库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-%E7%8B%AC%E7%AB%8B%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="toc-text">Lua 独立解释器</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA-Lua-5-1-%E4%BB%A5%E6%9D%A5%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-text">自 Lua 5.1 以来的变化</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E5%8F%98%E5%8C%96-2"><span class="toc-text">主要变化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%AD%E8%A8%80-1"><span class="toc-text">语言</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%BA%93-1"><span class="toc-text">库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-1"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0"><span class="toc-text">实现</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-%E7%8B%AC%E7%AB%8B%E8%A7%A3%E9%87%8A%E5%99%A8-1"><span class="toc-text">Lua 独立解释器</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8B%B1%E6%96%87%E5%8E%9F%E7%89%88"><span class="toc-text">英文原版</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-3"><span class="toc-text">Changes since Lua 5.3</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes"><span class="toc-text">Main changes</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-2"><span class="toc-text">Changes since Lua 5.2</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes-1"><span class="toc-text">Main changes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Language"><span class="toc-text">Language</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Libraries"><span class="toc-text">Libraries</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-2"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-standalone-interpreter"><span class="toc-text">Lua standalone interpreter</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Changes-since-Lua-5-1"><span class="toc-text">Changes since Lua 5.1</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#Main-changes-2"><span class="toc-text">Main changes</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Language-1"><span class="toc-text">Language</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Libraries-1"><span class="toc-text">Libraries</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#C-API-3"><span class="toc-text">C API</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Implementation"><span class="toc-text">Implementation</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Lua-standalone-interpreter-1"><span class="toc-text">Lua standalone interpreter</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lua-5-4-%E7%89%88%E6%9C%AC%E6%9B%B4%E6%96%B0"><span class="toc-text">Lua 5.4 版本更新</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2025 By チャン ゼプン</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.3.5</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (true) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="text-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>